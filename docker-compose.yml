# Docker Compose Spec v2（versionキーは不要）
services:
  # ========================================
  # PostgreSQL (Development)
  # ========================================
  db-postgres:
    image: postgres:15-alpine
    container_name: lot-db-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-lot_management}
      POSTGRES_USER: ${POSTGRES_USER:-admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-dev_password}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --locale=ja_JP.UTF-8"
      TZ: Asia/Tokyo
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      # ← 起動直後の誤検知を避けつつ、127.0.0.1 を明示して安定化
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-admin} -d ${POSTGRES_DB:-lot_management} -h 127.0.0.1 || exit 1" ]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 25s
    networks:
      - lot-network
    restart: unless-stopped

  # ========================================
  # PostgreSQL (Test)
  # ========================================
  db-postgres-test:
    image: postgres:15-alpine
    container_name: lot-db-postgres-test
    profiles: [ "e2e" ] # E2E実行時のみ起動
    environment:
      POSTGRES_DB: lot_management_test
      POSTGRES_USER: testuser
      POSTGRES_PASSWORD: testpass
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --locale=ja_JP.UTF-8"
      TZ: Asia/Tokyo
    ports:
      - "5433:5432" # ホストの5433にマップ
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U testuser -d lot_management_test -h 127.0.0.1 || exit 1" ]
      interval: 3s
      timeout: 3s
      retries: 10
      start_period: 10s
    networks:
      - lot-network
    tmpfs:
      - /var/lib/postgresql/data # 高速化のためメモリ上に配置
    restart: unless-stopped

  # ========================================
  # Backend (FastAPI)
  # ========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: lot-backend
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-development}
      POSTGRES_DB: ${POSTGRES_DB:-lot_management}
      POSTGRES_USER: ${POSTGRES_USER:-admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-dev_password}
      # psycopg2 のままなら postgresql://
      DATABASE_URL: postgresql://${POSTGRES_USER:-admin}:${POSTGRES_PASSWORD:-dev_password}@db-postgres:5432/${POSTGRES_DB:-lot_management}
      # テスト用DB接続URL（Docker内からアクセス）
      TEST_DATABASE_URL: postgresql+psycopg2://testuser:testpass@db-postgres-test:5432/lot_management_test
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:5173,http://127.0.0.1:5173}
      TZ: Asia/Tokyo
      # 監視が弱い環境（Win/Mac+DockerDesktop）での安定化
      WATCHFILES_FORCE_POLLING: "true"
    ports:
      - "8000:8000"
    depends_on:
      db-postgres:
        condition: service_healthy
    volumes:
      # アプリ本体だけをコンテナへ同期（依存はイメージに保持）
      - ./backend:/app:cached
      - backend-cache:/root/.cache/pip
    command: >
      uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload --reload-dir /app/app --reload-include "*.py"
    develop:
      watch:
        - path: ./backend
          target: /app
          action: sync
        - path: ./backend/requirements.txt
          action: rebuild
        - path: ./backend/pyproject.toml
          action: rebuild
    networks:
      - lot-network
    restart: unless-stopped

  # ========================================
  # Backend (Test) - E2E専用
  # ========================================
  backend-test:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: lot-backend-test
    profiles: [ "e2e" ] # E2E実行時のみ起動
    environment:
      ENVIRONMENT: testing
      POSTGRES_DB: lot_management_test
      POSTGRES_USER: testuser
      POSTGRES_PASSWORD: testpass
      DATABASE_URL: postgresql://testuser:testpass@db-postgres-test:5432/lot_management_test
      TEST_DATABASE_URL: postgresql+psycopg2://testuser:testpass@db-postgres-test:5432/lot_management_test
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:5173,http://127.0.0.1:5173}
      TZ: Asia/Tokyo
    ports:
      - "18000:8000" # テスト用ポート
    depends_on:
      db-postgres-test:
        condition: service_healthy
    volumes:
      - ./backend:/app:cached
      - backend-cache:/root/.cache/pip
    command: >
      uvicorn app.main:app --host 0.0.0.0 --port 8000
    networks:
      - lot-network
    restart: unless-stopped

  # ========================================
  # Frontend (Vite)
  # ========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: lot-frontend
    working_dir: /app
    environment:
      VITE_API_BASE: "/api"
      VITE_BACKEND_ORIGIN: "http://backend:8000"
      TZ: Asia/Tokyo
      # 監視をポーリングに切替（Win/Mac安定化）
      CHOKIDAR_USEPOLLING: "1"
      WATCHPACK_POLLING: "true"
    ports:
      - "5173:5173"
    depends_on:
      - backend
    volumes:
      # ★ Dockerfile の WORKDIR=/app に合わせてマウントを統一
      - ./frontend:/app:cached
      - frontend_node_modules:/app/node_modules
    # Vite のキャッシュを都度無効化（反映漏れ対策）
    command: sh -c "npm run dev -- --host --force"
    develop:
      watch:
        - path: ./frontend
          target: /app
          action: sync
        - path: ./frontend/package.json
          action: rebuild
        - path: ./frontend/package-lock.json
          action: rebuild
        - path: ./frontend/pnpm-lock.yaml
          action: rebuild
        - path: ./frontend/yarn.lock
          action: rebuild
    networks:
      - lot-network
    restart: unless-stopped

  # ========================================
  # pgAdmin 4
  # ========================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: lot-pgadmin
    profiles: [ "ops" ] # ← 明示プロファイル化（デフォでは起動しない）
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL:-admin@example.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD:-admin}
      TZ: Asia/Tokyo
    ports:
      - "5050:80"
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    depends_on:
      db-postgres:
        condition: service_started
    networks:
      - lot-network
    restart: unless-stopped

# ========================================
# 永続ボリューム
# ========================================
volumes:
  postgres-data:
    driver: local
  backend-cache:
    driver: local
  frontend_node_modules: {}
  pgadmin-data:
    driver: local

# ========================================
# ネットワーク
# ========================================
networks:
  lot-network:
    driver: bridge
