# 運用手順書 (Operations Runbook)

## 1. 定常運用

### 1.1. システム監視
- **ログ監視**: コンテナ標準出力 (stdout/stderr) および DB上の操作ログ (`operation_logs` テーブル)。
- **デッドロック監視**: PostgreSQLの標準ログでデッドロックエラー (`40P01`) を監視する。頻発する場合は引当ロジックの競合を疑う。

### 1.2. データ整合性チェック
定期的（例: 日次バッチ後）に整合性チェックを実行することを推奨する。
参照: [不変条件 (Invariants)](../quality/invariants.md)

## 2. 障害対応

### 2.1. 在庫ズレの解消
物理在庫とシステム上の在庫 (`current_quantity`) が合わない場合、直接DBを更新してはならない。必ず **在庫調整 (Adjustment)** 機能を使用する。

- API: `POST /inventory/adjustments`
- 理由区分:
    - `physical_count`: 棚卸差異
    - `damage`: 破損
    - `loss`: 紛失
    - `found`: 発見（プラス調整）

### 2.2. ロックされた在庫の解放
品質検査等で `locked` になったロットを使用可能にするには、ロック解除APIを使用する。
- API: `POST /inventory/lots/{id}/unlock`

### 2.3. 不正な予約の強制解放
システムエラー等で残ってしまった `active` な予約は、有効期間 (`expires_at`) があれば自動的に無視されるか、バッチでクリーニングされるべきである（要確認: クリーニングバッチの有無）。
手動対応が必要な場合は API 経由で `release` コマンドを実行する。

## 3. バックアップ・リストア
- DB (PostgreSQL) の標準バックアップ手順（pg_dump 等）に従う。
- リストア後は、必ず「データ整合性チェック」SQLを実行し、在庫数が負になっていないか確認する。
