# 在庫・ロット管理 改善マスタープラン (統合版)

**区分:** 実行計画（マスタープラン）  
**更新日**: 2026-01-24  
**基準ドキュメント**: `docs/reviews/inventory-lot-management-review_merged.md`

---

## 決定事項サマリ (Decision Record)

実装のブレを防止するため、レビューで合意した主要な決定事項を以下に固定する。

1. **データ構造とエイリアス**
   - `LotReceipt.lot_number` カラムを完全削除。ロット番号は `LotMaster` 経由で取得する。
   - `Lot` エイリアスを廃止し、コードベース全体で `LotReceipt` に統一。
2. **在庫計算の方式**
   - SSOTはバックエンドのビュー（またはDB関数）に統一し、UIは再計算しない。
   - 計算式: `available = on_hand - locked - confirmed`
   - `reserved(active)` は減算せず、別列で可視化する。
3. **ロットマスターの同期**
   - `LotMaster` の集計値（初回入荷日、最終有効期限など）はDBトリガーで自動更新する。
4. **UI/UX 仕様**
   - 在庫一覧の展開行（ロット詳細）は既定を **単一展開（アコーディオン）** とする。
   - 大量データ対応として、サーバーサイドページネーション、バーチャルスクロール、`decimal.js` を導入する。
5. **台帳管理**
   - `StockMovement` を正（台帳/イベントログ）とし、`StockHistory` は読み取り用に寄せる。

---

## 全体状況サマリ

| フェーズ | 概要 | 進捗 |
|----------|------|------|
| **Phase 0** | 品質基盤整備・不具合修正 | ✅ 完了 |
| **Phase 1** | DB構造の適正化（破壊的変更含む） | ✅ 完了 (LotReceipt化完了) |
| **Phase 2** | コードリファクタリング・UI整理 | 🔄 進行中 |
| **Phase 3** | スケーラビリティ対応 | ⬜ 未着手 |
| **Phase 4** | 自動化（DBトリガー等） | ⬜ 未着手 |

---

## ✅ 完了済み / Completed

### Phase 0: 品質基盤整備 & 不具合修正
- ✅ **ロット簡易登録エラーの修正**
- ✅ **ロット作成のユニットテスト追加**
- ✅ **状態管理ガイドラインの文書化**
- ✅ **v1/v2 型定義の統一**

### Phase 1: DB変更・データ整合性
- ✅ **LotReceipt.lot_number カラム削除**: LotReceipt モデルに移行完了。`lot_number` は `LotMaster` 経由または `@property` で取得。
- ✅ **FEFO インデックス最適化**: `expiry_date` を含むインデックス適用済み。
- ✅ **allocated_quantity 計算の統一**: `reserved_quantity` は `LotReservation` テーブルへ移行 (v3.0)。
- ✅ **consumed_quantity 導入**: `LotReceipt` で `consumed_quantity` を管理済み。

---


## 詳細実行計画 (残タスク)

### Phase 2: UI/UX & コードリファクタリング
- [ ] **Lot エイリアス廃止**: `Lot` エイリアスは後方互換性のため残存 (`inventory_models.py`)。完全廃止は未完了。
- [ ] **InventoryTable.tsx の分割**: 肥大化したテーブルコンポーネントを責務ごとに分割。
- [ ] **単一展開の実装**: 在庫一覧の展開モードをアコーディオン方式に。
- [ ] **フィルター導線の見直し**: ビューに依存しない統一されたフィルタリング体験。

### Phase 3: スケーラビリティ対応
- [ ] **サーバーサイドページネーション**: APIは `limit`/`offset` 対応済み。フロントエンド実装が必要。
- [ ] **バーチャルスクロール**: DOMレンダリング負荷の軽減。
- [ ] **decimal.js 導入**: 通貨・数量計算の精度保証と Number 型キャストの排除。

### Phase 4: 自動化
- [ ] **LotMaster 集計値の自動同期トリガー**: データの不整合を防止し、読み取り専用カラムの正確性を保証。

---

## リスクと軽減策

| リスク | 軽減策 |
|--------|--------|
| DB変更による既存データ破損 | 破壊的変更（Phase 1）はDBリセットまたは慎重な移行手順で実施する。 |
| テスト不足によるリグレッション | Phase 0 で整備したテスト基盤を活用し、各フェーズ完了後に自動テストを完遂する。 |
