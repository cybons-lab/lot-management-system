# 在庫・ロット管理ページ レビュー（問題点洗い出し）

対象: 在庫管理画面（一覧・詳細）とロット表示/操作周りの実装・データ設計。

## 1. データ整合性・業務ルール逸脱

### 1-1. 利用可能在庫の計算ロジックがドメイン定義と乖離
- **ドメイン定義**では「有効在庫 = 現在在庫 - ロック数量 - 確定引当」で、**仮引当(Active)は在庫を減らさない**運用。
- しかし **v_lot_allocations** は `active` と `confirmed` を合算しており、**UI/サマリ計算で仮引当まで在庫減算**される。
- **影響**: UI上の「利用可能」や在庫サマリが保守運用ルールと矛盾し、オーバーブッキング許容設計を壊す。現場は「在庫が足りない」と誤認しやすい。

### 1-2. ロック数量が二重に差し引かれるリスク
- ロット一覧の出庫可否判定で `current_quantity - allocated - locked` を使っているが、
  `current_quantity` 自体が **既に locked を減算**した値（ビュー定義）になっている。
- **影響**: 実在庫があるのに「出庫不可」と誤判定される。ロック数量が多いロットほど誤差が大きい。

### 1-3. 利用可能在庫の説明表示が誤った式になっている
- 詳細画面で「利用可能在庫数 = 総在庫数 - 引当済在庫数」と説明しているが、
  **ロック数量**が含まれておらず、画面表示の式が実計算と一致しない。
- **影響**: 利用者が在庫ロジックを誤解し、ロック/引当の影響が把握できない。

## 2. 画面表示とデータ取得の齟齬

### 2-1. ロット一覧が「100件上限」で欠落する
- ロット取得APIの `limit` デフォルトが 100 で、
  **明示的なページングや無限スクロールが無い**ため、
  大量ロットの製品は**一覧が欠落**する。
- 「ロット数」カラムは別集計のため、
  **表示件数とロット数が一致しない**状況が発生する。

### 2-2. 詳細画面が全ロットを取得してからローカルで絞り込み
- 詳細画面で `useLotsQuery({})` を使い、**全ロット取得 → フィルタ**している。
- **影響**: データ量が増えると**表示遅延・ネットワーク負荷・メモリ負荷**が増大。
  また 100件上限のため該当ロットが欠ける可能性も高い。

### 2-3. 仕入先フィルタ時の「在庫なし」タブが機能しない
- 仕入先フィルタ時の在庫サマリは `remaining_quantity > 0` の条件が固定で、
  **在庫0の行自体が取得されない**。
- その結果、UIの「在庫なし」タブを選択しても結果が出ない/意図と違う。

## 3. UX/UIの操作性問題

### 3-1. ロット一覧の情報不足
- 展開行のロット一覧に「有効在庫」「引当内訳」などがなく、
  実質的に「現在在庫」しかわからない。
- 予約やロックでどれだけ引当されているか判断できず、
  **操作（出庫/ロック）の判断材料が不足**。

### 3-2. 展開行が常に1件のみ（暗黙的な制約）
- 複数行を同時に比較したいケース（倉庫違いの在庫比較など）に不向き。
- UI上は「複数展開できそう」に見えるため、**操作の期待値と挙動がズレる**。

### 3-3. ロットステータス表現が限定的
- ロットの状態は「ロック中/利用可」のみ表示され、
  **期限切れ・枯渇・廃棄などの状態が可視化されない**。
- 期限切れ在庫の混在を見落としやすくなる。

## 4. API/設計の不整合・将来的な破綻ポイント

### 4-1. v1/v2 の型定義が混在
- フロントは v2 `/api/v2/lot` を叩いているが、
  `useLotsQuery` の型定義は `/api/lots` ベース（v1系）。
- **影響**: APIレスポンス差異が表面化しにくく、型安全性が崩れる。

### 4-2. 在庫サマリとロット詳細のデータ源が不一致
- 在庫サマリは `v_inventory_summary`（product_warehouse起点）だが、
  ロット詳細は `v_lot_details`（lot_receipts起点）。
- データ源が違うため、**集計値と明細値が一致しないケース**が生じる。
  （例: product_warehouse に存在するがロット未作成など）

---

## まとめ（重要度順の対応優先度）
1. **有効在庫計算の定義ズレ修正**（active/confirmedの扱い）
2. **ロック数量の二重控除修正**（出庫可否判定や表示式）
3. **ロット一覧のページング/取得方法見直し**（100件制限問題）
4. **詳細画面のAPI取得をproduct_id/warehouse_idで絞り込み**
5. **在庫なしタブの仕様修正**（supplier/primary filter時の条件）
6. **UI情報量強化**（有効在庫/引当内訳/期限切れ表示）