# 出荷票テキスト置換ロジック 仕様比較と改善提案

**作成日:** 2026-01-30
**対象ファイル:** `backend/app/presentation/api/routes/ocr_results_router.py`
**対象関数:** `build_shipping_slip_text()` (215-266行目)

---

## 概要

OCR結果から抽出したデータ（ロット番号、数量、入庫番号、日付）を使って、出荷票テンプレート文字列を実際の出荷票テキストに変換するロジックの仕様比較。

現状のPython実装と、元のExcel実装（Copilot整理版）の差分を明確化し、次回PRでの改善方針を定義する。

---

## 現状の実装 (Python)

### 処理対象
- **ファイル:** `backend/app/presentation/api/routes/ocr_results_router.py`
- **関数:** `build_shipping_slip_text(template, inbound_no, lot_no_1, quantity_1, lot_no_2, quantity_2, shipping_date, delivery_date)`

### 処理フロー

```python
# 1. ロット置換 (236-251行)
if lot_no_1 or lot_no_2:
    lot_entries = []
    if lot_no_1:
        lot_entries.append(f"{lot_no_1}（{quantity_1 or ''}）")
    if lot_no_2:
        lot_entries.append(f"{lot_no_2}（{quantity_2 or ''}）")

    lot_text = "・".join(lot_entries)  # 例: "46043（20）・46045（30）"

    # 正規化: "ロット" → "ロット番号(数量)"
    normalized = re.sub(r"(^|/)ロット($|/)", r"\1ロット番号(数量)\2", result)

    # 置換: "ロット番号(数量)" → 実際の値
    result = re.sub(r"ロット番号\s*[（(]数量[）)]", lot_text, normalized)

# 2. 入庫番号置換 (253-256行) - 単純置換
if inbound_no:
    result = result.replace("入庫番号", inbound_no)

# 3. 納期置換 (258-260行) - 単純置換
if delivery_date:
    result = result.replace("納期", delivery_date)

# 4. 出荷日置換 (262-264行) - 単純置換
if shipping_date:
    result = result.replace("出荷日", shipping_date)
```

### 現状の特徴

| 項目 | 詳細 |
|------|------|
| **処理順** | ロット → 入庫番号 → 納期 → 出荷日 |
| **ロット区切り** | `・` (全角中黒) |
| **数量表記** | `（20）` (全角カッコ) |
| **空欄時** | `（）` (空カッコが残る) |
| **日付フォーマット** | なし（渡された値をそのまま使用） |
| **テンプレ分岐** | なし（テンプレ構造に関わらず同じ処理） |

---

## Excel仕様 (Copilot整理版)

### 用語定義
- **テンプレ文:** 出荷票テキスト（テンプレ側の文面）
- **最終文:** 出荷票テキスト（最終出力）
- **Lot/数量/入庫No（1本目）:** LotNo-1 / 受注数量-1 / 入庫No-1
- **Lot/数量/入庫No（2本目）:** LotNo-2 / 受注数量-2 / 入庫No-2
- **出荷予定日:** 出荷予定日
- **受注納期:** 受注納期

### 処理フロー

```
1. 日付置換（▲/▲, ●/●）
2. ロット/入庫番号置換（テンプレ構造で分岐）
3. 最終文として出力
```

### 詳細ルール

#### 1) 日付置換ルール

**ルール D-1: `▲/▲` の置換（出荷予定日）**
- **条件:** テンプレ文に `▲/▲` が含まれる **かつ** 出荷予定日が入力されている
- **結果:** `▲/▲` を `出荷予定日（mm/dd形式）` で置換
- **フォーマット:** `TEXT(日付,"mm/dd")`

**ルール D-2: `▲/▲` を置換しない**
- **条件:** 出荷予定日が空（未入力）
- **結果:** `▲/▲` はテンプレ文のまま残す

**ルール D-3: `●/●` の置換（受注納期）**
- **条件:** テンプレ文に `●/●` が含まれる
- **結果:** `●/●` を `受注納期（mm/dd形式）` で置換

#### 2) ロット置換ルール（テンプレに「数量」があるかで分岐）

**ルール L-0: ロット連結表現（"数量つき"表示）**
- **条件:** LotNo-1 が入力されている
- **結果:**
  - ロット文字列（1本目）= `LotNo-1` + （受注数量-1があれば `(受注数量-1)` を付与）
  - LotNo-2 があれば `/` で連結し、同じルールで2本目を付ける
- **例:**
  - 1本目のみ: `46043(20)`
  - 2本目あり: `46043(20)/46045(20)`

**ルール L-1: テンプレに「数量」が無い場合（単純置換）**
- **条件:** テンプレ文に「数量」という文字が **含まれない**
- **結果:** テンプレ文中の `ロット` を、ロット連結表現で置換する
- **判定:** `ISERROR(FIND("数量",テンプレ))`

**ルール L-2: テンプレに「数量」がある場合（ブロック抽出→形を維持して置換）**
- **条件:** テンプレ文に「数量」という文字が **含まれる**
- **結果（置換対象の決め方）:**
  - テンプレ文から、「ロット」から「）」までの範囲を"ロットブロック"として抽出
  - そこを置換対象にする
- **結果（置換後の作り方）:**
  - 抽出したロットブロック内の
    - 文字 `ロット` を `LotNo` に置換
    - 文字 `数量` を `受注数量` に置換
  - して、テンプレの形を保ったままロットブロックを作り直す
  - LotNo-2 がある場合は `/` で2本目も同様に作って連結する

#### 3) 入庫番号置換ルール（テンプレの構造で分岐）

**ルール I-0: 入庫番号連結表現（"数量つき"表示）**
- **条件:** 入庫No-1 が入力されている
- **結果:**
  - 入庫番号文字列（1本目）= `入庫No-1` + （受注数量-1があれば `(受注数量-1)` を付与）
  - 入庫No-2 があれば `/` で連結し、同じルールで2本目を付ける

**ルール I-1: テンプレに「入庫番号」が無い場合**
- **条件:** テンプレ文に `入庫番号` が **含まれない**
- **結果:** 入庫番号置換は行わない

**ルール I-2: テンプレに「入庫番号」があり、かつ「ロット」もある場合（ブロック抽出→中身置換）**
- **条件:** テンプレ文に `入庫番号` が含まれる **かつ** `ロット` も含まれる
- **結果（置換対象の決め方）:**
  - テンプレ文から「入庫番号」から、（ロット位置以降にある）「/」の手前までを"入庫番号ブロック"として抽出
  - そこを置換対象にする
- **結果（置換後の作り方）:**
  - 抽出した入庫番号ブロック内の
    - `入庫番号` を `入庫No` に置換（1本目／2本目）
    - `ロット` を `LotNo(+数量)` に置換（1本目／2本目）
  - して"テンプレ形状を保ったまま"作り直す
  - 入庫No-2 がある場合は `/` で2本目相当も連結する

**ルール I-3: テンプレに「入庫番号」はあるが「ロット」が無い場合（単語置換寄り）**
- **条件:** テンプレ文に `入庫番号` が含まれる **かつ** `ロット` は含まれない
- **結果:**
  - "入庫番号の置換元"はテンプレ側の `入庫番号`（単語）になりやすく、
  - "入庫番号の置換後"は 入庫番号連結表現（I-0で作ったもの）になりやすい

---

## 現状 vs Excel仕様の差分まとめ

### 1. 日付フォーマットの違い

| 項目 | 現状（Python） | Excel仕様 |
|------|---------------|----------|
| **プレースホルダー** | `納期`, `出荷日` | `▲/▲`, `●/●` |
| **フォーマット** | そのまま渡される値 | `mm/dd` 形式に変換 |
| **処理順** | 最後（3-4番目） | 最初（1番目） |

**課題:**
- 日付フォーマット変換がない
- プレースホルダーが異なる
- 処理順が逆

### 2. ロット置換の柔軟性

| 項目 | 現状（Python） | Excel仕様 |
|------|---------------|----------|
| **判定条件** | テンプレに関わらず同じ処理 | テンプレに「数量」があるかで分岐 |
| **区切り文字** | `・` (全角中黒) | `/` |
| **カッコ** | `（）` (全角) | `()` (半角？) |
| **ブロック抽出** | なし（正規化のみ） | あり（「ロット」〜「）」を抽出） |

**課題:**
- 区切り文字が異なる
- テンプレ構造に応じた分岐がない
- ブロック抽出ロジックがない

### 3. 入庫番号置換の条件分岐

| 項目 | 現状（Python） | Excel仕様 |
|------|---------------|----------|
| **基本動作** | 単純な `replace` | テンプレ構造で分岐 |
| **ロット連携** | なし | 「入庫番号」+「ロット」の場合はブロック抽出 |

**課題:**
- 単純置換のみで、テンプレ構造を考慮していない
- Excel仕様ではテンプレ構造に応じた複雑な分岐がある

### 4. 数量の扱い

| 項目 | 現状（Python） | Excel仕様 |
|------|---------------|----------|
| **形式** | `（20）` (全角カッコ) | `(20)` (半角カッコ？要確認) |
| **空欄時** | `（）` (空カッコ) | テンプレ次第 |

---

## 改善提案

### Option 1: 現状ロジックを拡張（推奨・短期対応）

**変更内容:**
1. **日付フォーマット処理を追加**
   ```python
   # mm/dd形式に変換
   if shipping_date:
       formatted_date = datetime.strptime(shipping_date, "%Y-%m-%d").strftime("%m/%d")
       result = result.replace("▲/▲", formatted_date)
       result = result.replace("出荷日", formatted_date)  # 後方互換
   ```

2. **プレースホルダーのマッピング追加**
   - `▲/▲` → 出荷予定日
   - `●/●` → 受注納期
   - 既存の `出荷日`, `納期` も継続サポート

3. **区切り文字を設定可能に**
   ```python
   separator = "/"  # デフォルト: /（Excel仕様に合わせる）
   # 設定で "・" も選択可能にする
   lot_text = separator.join(lot_entries)
   ```

**メリット:**
- 既存コードへの影響が少ない
- 段階的に移行可能
- 後方互換性を保てる

**デメリット:**
- テンプレ構造を完全には活用できない

---

### Option 2: Excel仕様を完全実装（長期対応）

**変更内容:**
1. **テンプレ解析ロジック追加**
   ```python
   def analyze_template(template: str) -> dict:
       """テンプレ構造を解析"""
       return {
           "has_quantity": "数量" in template,
           "has_inbound_no": "入庫番号" in template,
           "has_lot": "ロット" in template,
       }
   ```

2. **ブロック抽出ロジック実装**
   ```python
   def extract_lot_block(template: str) -> str:
       """「ロット」から「）」までを抽出"""
       match = re.search(r"ロット.*?）", template)
       return match.group(0) if match else ""
   ```

3. **条件分岐を全て実装**
   - ルール L-1, L-2 の分岐
   - ルール I-1, I-2, I-3 の分岐

**メリット:**
- Excel仕様を完全再現
- テンプレの柔軟性が向上
- 複雑なテンプレにも対応可能

**デメリット:**
- 実装コストが高い
- テストケースが増える
- 既存テンプレとの互換性確認が必要

---

## 次のステップ（確認事項）

実装前に以下を確認する必要があります:

### 1. テンプレート実例の確認
- [ ] 実際のテンプレート文字列を収集
- [ ] よく使われるパターンを分類
- [ ] エッジケースの洗い出し

### 2. プレースホルダーの統一
- [ ] `▲/▲` と `出荷日` のどちらを使うべきか決定
- [ ] `●/●` と `納期` のどちらを使うべきか決定
- [ ] 両方サポートするか、統一するか

### 3. 区切り文字の決定
- [ ] `/` に統一するか
- [ ] `・` との共存を許すか
- [ ] 設定で選択可能にするか

### 4. 数量表記の確認
- [ ] 全角カッコ `（）` か半角カッコ `()` か
- [ ] 空欄時の挙動（`（）` を残すか、空文字にするか）

---

## 実装計画（次回PR）

**優先度: Medium**
**想定工数: 1-2日**

### Phase 1: 短期対応（Option 1ベース）
1. 日付フォーマット処理追加
2. プレースホルダー両対応（`▲/▲` + `出荷日`）
3. 区切り文字の統一（`/` に変更）
4. ユニットテスト追加

### Phase 2: 長期対応（Option 2ベース）
1. テンプレ解析ロジック実装
2. ブロック抽出ロジック実装
3. 条件分岐の完全実装
4. 統合テスト追加

---

## 関連ファイル

- **実装:** `backend/app/presentation/api/routes/ocr_results_router.py:215-266`
- **テスト:** (未作成 - 追加必要)
- **データモデル:** `backend/app/infrastructure/persistence/models/smartread_models.py`

---

## 参考資料

- Copilot整理版仕様（2026-01-30 ユーザー提供）
- Excel実装（詳細は別途確認予定）

---

**最終更新:** 2026-01-30
**ステータス:** 仕様整理完了 / 実装待ち
