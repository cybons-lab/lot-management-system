# 出荷票テキスト置換ロジック 仕様比較と確定仕様

**作成日:** 2026-01-30
**更新日:** 2026-01-31 (確定仕様反映)
**対象ファイル:** `backend/app/presentation/api/routes/ocr_results_router.py`
**対象関数:** `build_shipping_slip_text()`

---

## 概要

OCR結果から抽出したデータ（ロット番号、数量、入庫番号、日付）を使って、出荷票テンプレート文字列を実際の出荷票テキストに変換するロジックの最新仕様。
2026-01-31に受領したフィードバックおよびスクリーンショットに基づき、最終的な仕様を定義する。

---

## 確定仕様 (2026-01-31)

従来のPython実装やExcel仕様案に代わり、以下のルールを正とする。

### 1. プレースホルダーと日付計算

| 項目 | プレースホルダー | 置換ルール | 備考 |
|------|-----------------|------------|------|
| **出荷日** | `▲/▲` (または `▲▲/▲▲`) | `出荷日` (mm/dd) | **自動計算あり** (後述) |
| **納期** | `●/●` | `納期` (mm/dd) | |

#### 共通ルール
- **日付フォーマット:** `mm/dd` (月/日)
- **区切り文字:** `/` (スラッシュ) のみ
- **空欄時:** 空文字に置換 (プレースホルダーを削除)

#### 出荷日の自動計算ロジック
- **条件:** 出荷用マスタの「輸送LT」に数値が設定されている場合のみ計算を行う。
- **計算式:** `出荷日 = 納期 - 輸送LT (日)`
- **補足:** 輸送LTがない場合は、計算を行わず（OCR結果や入力値があればそれを使用、なければ空文字）、置換を行う。

### 2. ロット・入庫番号・数量の置換ロジック

テンプレートに含まれるプレースホルダーの構成によって挙動を変える。

#### 基本フォーマット
- **数量表記:** 半角カッコを使用 `(数量)`
    - 例: `(20)`
    - **ルール:** 数量が空欄の場合は、カッコごと非表示にする（空文字）。`( )` とはしない。
- **複数項目の区切り:** `/` (スラッシュ)
    - 例: `ロットA(10)/ロットB(20)`

#### シナリオ分岐 (スクリーンショット準拠)

**Case A: テンプレートに入庫番号のみがある場合**
*例: `B911/入庫番号/専/路線`*

- **入力: 入庫番号のみ**
    - 結果: `入庫番号` をそのまま置換。
    - 出力例: `B911/12345/専/路線`
- **入力: 入庫番号 + ロット番号**
    - 結果: **ロット番号(数量)** を前方に挿入する形で置換。
    - ロジック: `入庫番号` → `ロット(数量)/入庫番号(数量)`
    - 出力例: `B911/Lot123(10)/12345(10)/専/路線`
    - *補足: `入庫番号(数量)` だけにするのはNG (ロット情報が欠落するため)*

**Case B: テンプレートに入庫番号およびロットがある場合**
*例: `C697/入庫番号/ロット/専/路線/梱包`*

- **入力: 両方あり**
    - 結果: それぞれのプレースホルダーを置換。
    - `入庫番号` → `入庫番号` (数量なし)
    - `ロット` → `ロット(数量)`
    - 出力例: `C697/12345/Lot123(10)/専/路線/梱包`

**Case C: テンプレートに入庫番号(ロット)のような形式がある場合**
*例: `* 入庫番号(ロット)/カ/北産`*

- **入力: 両方あり**
    - 結果:
    - `入庫番号` → `入庫番号`
    - `ロット` → `ロット(数量)`
    - 出力例: `* 12345(Lot123(10))/カ/北産` (テンプレートのカッコ構造によるが、基本的に `ロット` は `ロット(数量)` になる)

### 3. ロバストネス要件 (Robustness)

- **空欄許容:** 数量ボックス欄が空欄の場合でも、エラー（バリデーションエラーや500エラー）を出さないこと。
    - 数量が空の場合は、数量部分（カッコ含む）の文字列を生成しないだけであり、処理自体は正常終了させる。
    - フロントエンドでの必須チェックも適用しない。

### 4. UI表示要件

- **ルールの可視化:** OCR結果詳細ページ（または編集モーダル）に、このテキスト置換ルールを表示する。
    - **表示形式:** アコーディオン形式（折りたたみ）などで、普段は邪魔にならないようにする。
    - **内容:** プレースホルダーの意味、自動計算のロジック、数量欠落時の挙動などをユーザーが確認できるようにする。

---

## 以前の実装・Excel仕様との主な変更点（参考）

1. **プレースホルダー:** `納期`/`出荷日`（漢字）ではなく `▲/▲`/`●/●`（記号）を正式サポート。
2. **区切り文字:** `・`（中黒）廃止、`/`（スラッシュ）に統一。
3. **数量のカッコ:** 全角 `（）` から 半角 `()` に変更。空欄時はカッコも削除。
4. **自動挿入:** 入庫番号しかないテンプレートでも、ロット情報がある場合は自動的にロット情報を挿入するロジックを追加。
5. **日付計算:** マスタの輸送LT依存の計算ロジックを明記。

---

## 実装への反映事項

`backend/app/presentation/api/routes/ocr_results_router.py` の `build_shipping_slip_text` 関数およびフロントエンドを修正する。

1. **日付計算:** マスタデータの参照が必要になるため、Service層で計算済みの値を渡すか、関数内でマスタを参照できるようにする。
2. **テンプレート解析:** `入庫番号` と `ロット` の有無を判定するフラグを用意する。
3. **条件分岐:** Case A/B に応じて置換文字列を構築する。
4. **正規表現:** `▲/▲` や `●/●` のパターンマッチには正規表現を使用し、`▲▲/▲▲` 等の揺らぎも吸収する。
5. **UI実装:** フロントエンドの対象コンポーネントにルール説明を追加する。
