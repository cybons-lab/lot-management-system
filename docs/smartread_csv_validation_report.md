# SmartRead CSVフォーマット検証 調査レポート

## 1. 概要
SmartReadでダウンロードされる横持ちデータ（CSV）の取り込みおよび縦持ち変換ロジック（`SmartReadCsvTransformer`）について、フォーマット要件、必須カラム、柔軟性、エラーハンドリングの観点で調査を行いました。

**結論:**
SmartReadの変換ロジックは**非常に柔軟**に設計されており、特定のカラム順序や厳密な必須カラム制約を持たず、存在する情報のみを抽出して変換する仕組みとなっています。

## 2. カラム要件

### 2.1 必須カラム
プログラムの動作上、**絶対に必要なカラム（存在しないとエラーで停止するもの）はありません。**
ただし、業務的に意味のあるデータを生成するためには、以下のカラムが必要です。これらのカラムはプログラム内で定数として定義されており、完全一致（正規化後）で判定されます。

#### 共通項目（ヘッダー情報）
以下のカラム名が列に含まれている場合、その値が抽出され、変換後の全行にコピーされます。
*   ファイル名
*   ページ番号
*   テンプレート名
*   発行日
*   納品書No
*   発注者
*   発注事業所
*   出荷場所名称
*   納入日
*   便

#### 明細項目（繰り返し情報）
以下のカラム名にサフィックス（数値）がついたものが自動探索されます（例: `材質コード1`, `材質コード 2` ... `材質コード20`）。
*   材質コード
*   材質サイズ
*   単位
*   納入量
*   納入量小数点（※`納入量`と結合されます）
*   アイテム
*   購買
*   次区
*   Lot No（サブ明細）
*   梱包数（サブ明細）
*   数量（サブ明細）

### 2.2 任意カラムの扱い
*   **定義されていないカラム:** 無視されます。エラーにはなりません。
*   **空のカラム:** 値が空として扱われます。

### 2.3 カラム名の正規化
カラム名のマッチングにおいて、以下の正規化が行われるため、表記の揺らぎがある程度許容されます。
*   前後空白の削除（Trim）
*   全角数字 → 半角数字への変換

## 3. カラム順序の柔軟性
*   **順序不問:** 変換ロジックは辞書型（Key-Value）でデータにアクセスするため、CSV内のカラム順序は**完全に任意**です。入れ替わっていても問題なく動作します。

## 4. エラーハンドリング

不正なデータが含まれていた場合でも、プロセス全体がクラッシュすることはなく、**「警告付きで取り込み成功」** または **「不正項目のクリア」** という挙動をとります。

### 4.1 検証ロジック詳細
| 項目 | 検証内容 | エラー時の挙動 |
| :--- | :--- | :--- |
| **発行日 / 納入日** | 日付フォーマットチェック<br>(`YYYY/MM/DD`, `YYYY-MM-DD`, `YYYY年MM月DD日` 等に対応) | `errors`リストにエラーを追加。<br>該当フィールドの値は**空文字**に置換される。<br>内部フラグ `エラー_発行日形式` 等が `1` になる。 |
| **次区** | 先頭がアルファベットであるか | `errors`リストにエラーを追加。<br>内部フラグ `エラー_次区形式` が `1` になる。（値は保持） |
| **納入量** | 数値であるか、0以上であるか | `errors`リストにエラーを追加。<br>内部フラグ `エラー_納入量` が `1` になる。（値は保持） |

### 4.2 エラーの通知
APIレスポンスの `errors` フィールドに、以下の形式でバリデーションエラーが返却されます。
```json
{
  "row": 1,
  "field": "発行日",
  "message": "日付形式が不正です",
  "value": "不正な日付文字列"
}
```

## 5. 推奨される改善案

現状の実装は要件（Option A: 理想）をほぼ満たしていますが、以下の点は考慮の余地があります。

1.  **明細なしの警告:**
    *   現状、明細カラムが一つも見つからない場合、単に縦持ちデータが生成されず、エラーも出ません。
    *   **提案:** 明細が1件も生成されなかった場合、「明細が見つかりませんでした」という警告を出すと、カラム名の不一致（意図しないフォーマット変更）に気づきやすくなります。

2.  **未知のカラムのログ出力:**
    *   デバッグ目的で、定義にないカラムが大量に含まれている場合にログ出力（INFO/DEBUGレベル）しておくと、フォーマット変更の追跡に役立つ可能性があります。

以上
