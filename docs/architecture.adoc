= Architecture Documentation
:toc: left
:toc-title: 目次
:sectnums:

**最終更新**: 2025-11-26

本ドキュメントは、ロット管理システムのアーキテクチャ、コードベース構造、APIリファクタリング計画、および共通型定義に関する情報を統合したものです。

== コードベース構造

=== 概要

Lot Management System は、Backend (Python/FastAPI) と Frontend (React/TypeScript) のモノレポ構成です。

=== Backend 構造 (Python 3.12 / FastAPI)

==== 層構造

[source,text]
----
app/
├── api/           # API層 (ルーター、依存性注入)
├── services/      # ビジネスロジック層
├── repositories/  # データアクセス層
├── models/        # SQLAlchemy モデル層
├── schemas/       # Pydantic スキーマ層 (I/O契約)
├── domain/        # ドメインロジック層 (純粋なビジネスルール)
├── core/          # コア機能 (設定、DB接続、ログ、エラーハンドリング)
├── middleware/    # ミドルウェア
└── db/            # データベースセッション管理
----

==== 依存関係の方向性

**単方向依存**（循環参照禁止）:

[source,text]
----
api → services → repositories → models
 ↓         ↓
schemas   domain
----

* **api**: services を呼び出し、schemas で入出力を定義
* **services**: ビジネスロジックを実装、repositories を呼び出し
* **repositories**: データアクセスのみ、models を使用
* **models**: SQLAlchemy モデル定義（DBテーブル構造）
* **schemas**: Pydantic モデル定義（API I/O契約）
* **domain**: 純粋なビジネスルール（FEFO、在庫検証など）

=== Frontend 構造 (React 19 / TypeScript)

==== 層構造

[source,text]
----
src/
├── features/      # 機能別コンポーネント（ビジネスロジック含む）
├── components/    # 共有コンポーネント
│   ├── ui/        # Radix UI ベースの汎用UIコンポーネント
│   └── shared/    # プロジェクト固有の共通コンポーネント
├── hooks/         # カスタムフック
│   ├── api/       # API呼び出しフック (TanStack Query)
│   ├── mutations/ # データ更新フック
│   └── ui/        # UI状態管理フック
├── services/      # API通信層（Axiosラッパー）
├── types/         # 型定義（OpenAPI自動生成）
├── utils/         # ユーティリティ関数
├── factories/     # テストデータ生成
└── mocks/         # MSW モックハンドラ
----

==== Features構造

各feature（機能）は独立したモジュールとして構成:

[source,text]
----
features/orders/
├── components/    # 機能固有のコンポーネント
├── hooks/         # 機能固有のフック
├── api.ts         # API呼び出し関数
├── types.ts       # 機能固有の型定義
└── index.ts       # Barrel export
----

== API構造リファクタリング計画 (v2.2)

=== 概要

v2.2 では、以下の目的でAPI構造をリファクタリングしました：

1. **フォーキャストのヘッダ・明細分離** - スケーラビリティと保守性の向上
2. **引当APIの責務分離** - FEFO / 手動引当 / 候補ロットの明確化
3. **マスタAPIのフラット化** - URL構造の簡素化
4. **product_id基準への統一** - パフォーマンス向上

=== 実装済み API 一覧 (Phase 1-4 完了)

* **Forecasts API**: ヘッダ・明細分離構造 (`/api/forecasts`)
* **Inbound Plans API**: 入荷予定管理 (`/api/inbound-plans`)
* **Adjustments API**: 在庫調整 (`/api/adjustments`)
* **Inventory Items API**: 在庫サマリ (`/api/inventory-items`)
* **Allocations API**: 引当管理 (`/api/allocations`)
* **Allocation Suggestions API**: 引当推奨 (`/api/allocation-suggestions`)
* **Masters API**: フラット化されたマスタAPI (`/api/warehouses`, `/api/products` 等)

=== 破壊的変更と移行

* 旧 `/api/forecast` 系エンドポイントは廃止予定（2026-02-15）
* 旧 `/api/masters/*` 系エンドポイントは互換性維持のため残存するが非推奨
* 旧 `/api/allocations/drag-assign` 等は `/api/allocation-suggestions/manual` 等へ移行

== API vs Frontend 対応状況分析

=== 概要

FastAPIバックエンドのAPIエンドポイントと、React/TypeScriptフロントエンドの画面・機能の対応状況分析（2025-11-21時点）。

=== 実装状況サマリ

| カテゴリ | 総エンドポイント数 | Implemented | Partial | Missing |
|---------|-------------------|-------------|---------|---------|
| Masters | 25 | 25 | 0 | 0 |
| Orders | 6 | 4 | 1 | 1 |
| Allocations | 13 | 9 | 0 | 4 |
| Inventory | 18 | 18 | 0 | 0 |
| Forecasts | 7 | 7 | 0 | 0 |
| Admin | 46 | 27 | 0 | 19 |
| **合計** | **115** | **90 (78%)** | **1 (1%)** | **24 (21%)** |

=== Missing 機能

* **Allocations**: 提案自動生成機能
* **Operation Logs**: マスタ変更履歴表示
* **Admin/Dashboard**: ダッシュボード統計表示
* **Admin/Simulation**: シミュレーション関連（開発用）

== 共通型候補リスト

=== 目的

バックエンド（FastAPI/Pydantic）とフロントエンド（React/TypeScript）で繰り返し登場する型パターンを特定し、共通型定義の候補として整理する。

=== 1. マスタデータSummary系

| バックエンド (Python) | フロントエンド (TypeScript) | フィールド |
|----------------------|---------------------------|-----------|
| `WarehouseSummary` | `WarehouseDisplay` | id + code + name |
| `SupplierSummary` | `SupplierDisplay` | id + code + name |
| `CustomerSummary` | `CustomerDisplay` | id + code + name |
| `ProductSummary` | `ProductDisplay` | id + code + name + unit |

=== 2. ListResponse / PageResponse パターン

**バックエンド提案**:
[source,python]
----
class ListResponse[T](BaseSchema):
    items: list[T]
    total: int
----

**フロントエンド提案**:
[source,typescript]
----
export type ListResponse<T> = {
    items: T[];
    total: number;
};
----

=== 3. ドメイン固有Summary系

* **LotSummary**: id, lot_number, expiry_date, available_quantity
* **AllocationSummary**: 引当情報のサマリ

=== 4. アクションプラン

1. **マスタデータSummary型の定義**（高優先度）
2. **ListResponse[T] の共通化**（高優先度）
3. **ドメインSummary型の定義**（中優先度）
4. **レガシーフィールドの削除**（中優先度）
