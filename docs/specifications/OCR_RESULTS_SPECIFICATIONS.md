# OCRçµæœãƒšãƒ¼ã‚¸ ä»•æ§˜æ›¸

**æœ€çµ‚æ›´æ–°:** 2026-01-23
**å¯¾è±¡ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** v2.1

## ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ãƒ•ãƒ­ãƒ¼](#ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ãƒ•ãƒ­ãƒ¼)
3. [å‡ºè·ç¥¨ãƒ†ã‚­ã‚¹ãƒˆç½®æ›ãƒ­ã‚¸ãƒƒã‚¯](#å‡ºè·ç¥¨ãƒ†ã‚­ã‚¹ãƒˆç½®æ›ãƒ­ã‚¸ãƒƒã‚¯)
4. [ãƒ­ãƒƒãƒˆå…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³](#ãƒ­ãƒƒãƒˆå…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³)
5. [å‡ºè·æ—¥è‡ªå‹•è¨ˆç®—](#å‡ºè·æ—¥è‡ªå‹•è¨ˆç®—)
6. [SAPãƒãƒƒãƒãƒ³ã‚°](#sapãƒãƒƒãƒãƒ³ã‚°)
7. [ç·¨é›†å¯èƒ½ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰](#ç·¨é›†å¯èƒ½ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰)

---

## æ¦‚è¦

OCRçµæœãƒšãƒ¼ã‚¸ã¯ã€SmartReadã§å–å¾—ã—ãŸå—æ³¨ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºãƒ»ç·¨é›†ã—ã€å‡ºè·ç¥¨ãƒ†ã‚­ã‚¹ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ãƒšãƒ¼ã‚¸ã§ã™ã€‚

**ä¸»è¦æ©Ÿèƒ½:**
- OCRå–å¾—ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºãƒ»ç·¨é›†
- SAPãƒã‚¹ã‚¿ã¨ã®ç…§åˆ
- å‡ºè·ç¥¨ãƒ†ã‚­ã‚¹ãƒˆã®è‡ªå‹•ç”Ÿæˆ
- å‡ºè·æ—¥ã®è‡ªå‹•è¨ˆç®—ï¼ˆå–¶æ¥­æ—¥ãƒ™ãƒ¼ã‚¹ï¼‰
- ãƒ­ãƒƒãƒˆãƒ»æ•°é‡å…¥åŠ›ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

---

## ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ãƒ•ãƒ­ãƒ¼

### ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. smartread_long_data        â† OCRå–å¾—ãƒ‡ãƒ¼ã‚¿ï¼ˆç¸¦æŒã¡ï¼‰     â”‚
â”‚ 2. ocr_result_edits           â† æ‰‹å…¥åŠ›ãƒ‡ãƒ¼ã‚¿                â”‚
â”‚ 3. shipping_master_curated    â† å‡ºè·ç”¨ãƒã‚¹ã‚¿                â”‚
â”‚ 4. sap_material_cache         â† SAPãƒãƒ†ãƒªã‚¢ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥     â”‚
â”‚ 5. calendar                   â† å–¶æ¥­æ—¥ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ v_ocr_results ãƒ“ãƒ¥ãƒ¼ï¼ˆãƒ‡ãƒ¼ã‚¿çµ±åˆï¼‰                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - OCRãƒ‡ãƒ¼ã‚¿ + æ‰‹å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ã‚¸                          â”‚
â”‚ - å‡ºè·ç”¨ãƒã‚¹ã‚¿ã¨JOINï¼ˆå¾—æ„å…ˆãƒ»æè³ªãƒ»æ¬¡åŒºã§ç…§åˆï¼‰            â”‚
â”‚ - ã‚¨ãƒ©ãƒ¼ãƒ•ãƒ©ã‚°è¨ˆç®—ï¼ˆãƒã‚¹ã‚¿æœªä¸€è‡´ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼ç­‰ï¼‰    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API (ocr_results_router.py)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - SAPç…§åˆå‡¦ç†ï¼ˆSapReconciliationServiceï¼‰                   â”‚
â”‚ - å‡ºè·æ—¥è‡ªå‹•è¨ˆç®—ï¼ˆCalendarService + transport_lt_daysï¼‰     â”‚
â”‚ - ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆ                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (OcrResultsListPage.tsx)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º                                                 â”‚
â”‚ - ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç·¨é›†ï¼ˆãƒ­ãƒƒãƒˆãƒ»æ•°é‡ãƒ»å…¥åº«Noãƒ»å‡ºè·æ—¥ãƒ»ç´æœŸç­‰ï¼‰    â”‚
â”‚ - å‡ºè·ç¥¨ãƒ†ã‚­ã‚¹ãƒˆè‡ªå‹•ç”Ÿæˆï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰                     â”‚
â”‚ - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ­ãƒƒãƒˆãƒ»æ•°é‡ãƒšã‚¢ãƒã‚§ãƒƒã‚¯ï¼‰                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ä»•çµ„ã¿

#### SAPãƒãƒ†ãƒªã‚¢ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥

**ç›®çš„:** SAPã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã¯æ™‚é–“ãŒã‹ã‹ã‚‹ãŸã‚ã€PostgreSQLã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦é«˜é€ŸåŒ–

**ãƒ†ãƒ¼ãƒ–ãƒ«:** `sap_material_cache`

**ãƒ•ãƒ­ãƒ¼:**
```
1. SAPæ¥ç¶šãƒšãƒ¼ã‚¸ã§RFCå‘¼ã³å‡ºã— (Z_SCM1_RFC_MATERIAL_DOWNLOAD)
   â†“
2. å–å¾—ãƒ‡ãƒ¼ã‚¿ã‚’sap_material_cacheãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜
   - å¾—æ„å…ˆã‚³ãƒ¼ãƒ‰ (KUNNR)
   - å…ˆæ–¹å“ç•ª (ZKDMAT_B) â† ãƒãƒƒãƒãƒ³ã‚°ã‚­ãƒ¼
   - ãƒ¡ãƒ¼ã‚«ãƒ¼å“ç•ª (ZMKMAT_B)
   - ä»•å…¥å…ˆã‚³ãƒ¼ãƒ‰ (ZLIFNR_H)
   - æ•°é‡å˜ä½ (MEINS)
   - å…¨ã‚«ãƒ©ãƒ JSON (raw_data)
   â†“
3. OCRçµæœãƒšãƒ¼ã‚¸ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ç…§åˆ
   - ãƒ¡ãƒ¢ãƒªä¸Šã§è¾æ›¸åŒ–ï¼ˆzkdmat_b â†’ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¢ã‚¤ãƒ†ãƒ ï¼‰
   - O(1)ã§é«˜é€Ÿæ¤œç´¢
```

**ãƒ‡ãƒ¼ã‚¿æ›´æ–°:**
- æ‰‹å‹•: SAPçµ±åˆãƒšãƒ¼ã‚¸ã§ã€Œãƒ‡ãƒ¼ã‚¿å–å¾—ã€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯ä¸Šæ›¸ãï¼ˆconnection_id + kunnr + zkdmat_bã§ä¸€æ„åˆ¶ç´„ï¼‰

---

## å‡ºè·ç¥¨ãƒ†ã‚­ã‚¹ãƒˆç½®æ›ãƒ­ã‚¸ãƒƒã‚¯

### åŸºæœ¬ä»•æ§˜

**ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ:** å‡ºè·ç”¨ãƒã‚¹ã‚¿ã® `shipping_slip_text` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

**ç½®æ›å¯¾è±¡:**
- `ãƒ­ãƒƒãƒˆ` â†’ ãƒ­ãƒƒãƒˆç•ªå·ã¨æ•°é‡
- `å…¥åº«ç•ªå·` â†’ å…¥åº«No
- `å‡ºè·â–²/â–²` â†’ å‡ºè·æ—¥ï¼ˆMM/DDå½¢å¼ï¼‰
- `ç€æ—¥æŒ‡å®šâ—/â—` â†’ ç´æœŸï¼ˆMM/DDå½¢å¼ï¼‰

### ç½®æ›æ¡ä»¶ï¼ˆé‡è¦ï¼‰

| ãƒ­ãƒƒãƒˆæƒ…å ± | å…¥åº«No | å‹•ä½œ | èª¬æ˜ |
|-----------|-------|------|------|
| **ç©º** | **ç©º** | ğŸ”´ **ç½®æ›ãªã—** | ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãã®ã¾ã¾å‡ºåŠ› |
| **ç©º** | âœ… ã‚ã‚Š | âš ï¸ éƒ¨åˆ†ç½®æ› | å…¥åº«ç•ªå·ã®ã¿ç½®æ›ã€ãƒ­ãƒƒãƒˆã¯ãã®ã¾ã¾ |
| âœ… ã‚ã‚Š | **ç©º** | âš ï¸ éƒ¨åˆ†ç½®æ› | ãƒ­ãƒƒãƒˆã®ã¿ç½®æ›ã€å…¥åº«ç•ªå·ã¯ãã®ã¾ã¾ |
| âœ… ã‚ã‚Š | âœ… ã‚ã‚Š | âœ… å®Œå…¨ç½®æ› | å…¨ã¦ç½®æ› |

**ã€Œãƒ­ãƒƒãƒˆæƒ…å ±ã‚ã‚Šã€ã®å®šç¾©:**
- ãƒ­ãƒƒãƒˆNoã¨æ•°é‡ãŒ**ãƒšã‚¢ã§å…¥åŠ›ã•ã‚Œã¦ã„ã‚‹**ã“ã¨
- ãƒ­ãƒƒãƒˆ1ã ã‘ã€ãƒ­ãƒƒãƒˆ2ã ã‘ã€ä¸¡æ–¹ â†’ ã„ãšã‚Œã‚‚OKï¼ˆãƒšã‚¢ãªã‚‰ï¼‰

### å…·ä½“ä¾‹

#### ä¾‹1: å…¨ã¦ç©º

```
ã€å…¥åŠ›ã€‘
- ãƒ­ãƒƒãƒˆ1: (ç©º)
- æ•°é‡1: (ç©º)
- ãƒ­ãƒƒãƒˆ2: (ç©º)
- æ•°é‡2: (ç©º)
- å…¥åº«No: (ç©º)

ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€‘
"/ãƒ­ãƒƒãƒˆ/å…¥åº«ç•ªå·/å‡ºè·â–²/â–²/ç€æ—¥æŒ‡å®šâ—/â—/"

ã€çµæœã€‘
"/ãƒ­ãƒƒãƒˆ/å…¥åº«ç•ªå·/å‡ºè·â–²/â–²/ç€æ—¥æŒ‡å®šâ—/â—/"
ï¼ˆãã®ã¾ã¾ã€æ—¥ä»˜ã®ã¿ç½®æ›ã•ã‚Œã‚‹å¯èƒ½æ€§ã‚ã‚Šï¼‰
```

#### ä¾‹2: å…¥åº«Noã®ã¿

```
ã€å…¥åŠ›ã€‘
- ãƒ­ãƒƒãƒˆ1: (ç©º)
- æ•°é‡1: (ç©º)
- å…¥åº«No: "IB123"

ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€‘
"/ãƒ­ãƒƒãƒˆ/å…¥åº«ç•ªå·/"

ã€çµæœã€‘
"/ãƒ­ãƒƒãƒˆ/IB123/"
```

#### ä¾‹3: ãƒ­ãƒƒãƒˆ1ã®ã¿

```
ã€å…¥åŠ›ã€‘
- ãƒ­ãƒƒãƒˆ1: "L001"
- æ•°é‡1: "20"
- å…¥åº«No: (ç©º)

ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€‘
"/ãƒ­ãƒƒãƒˆ/å…¥åº«ç•ªå·/"

ã€çµæœã€‘
"/L001ï¼ˆ20ï¼‰/å…¥åº«ç•ªå·/"
```

#### ä¾‹4: ãƒ­ãƒƒãƒˆ2ã¤ + å…¥åº«No

```
ã€å…¥åŠ›ã€‘
- ãƒ­ãƒƒãƒˆ1: "L001"
- æ•°é‡1: "20"
- ãƒ­ãƒƒãƒˆ2: "L002"
- æ•°é‡2: "30"
- å…¥åº«No: "IB123"

ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€‘
"/ãƒ­ãƒƒãƒˆ/å…¥åº«ç•ªå·/"

ã€çµæœã€‘
"/L001ï¼ˆ20ï¼‰/L002ï¼ˆ30ï¼‰/IB123/"

â€»ãƒ­ãƒƒãƒˆã®åŒºåˆ‡ã‚Š: ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ (/)
```

#### ä¾‹5: æ—¥ä»˜è¾¼ã¿

```
ã€å…¥åŠ›ã€‘
- ãƒ­ãƒƒãƒˆ1: "L001"
- æ•°é‡1: "20"
- å…¥åº«No: "IB123"
- å‡ºè·æ—¥: "01/25"ï¼ˆã¾ãŸã¯è‡ªå‹•è¨ˆç®—å€¤ï¼‰
- ç´æœŸ: "01/30"

ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€‘
"/ãƒ­ãƒƒãƒˆ/å…¥åº«ç•ªå·/å‡ºè·â–²/â–²/ç€æ—¥æŒ‡å®šâ—/â—/"

ã€çµæœã€‘
"/L001ï¼ˆ20ï¼‰/IB123/å‡ºè·01/25/ç€æ—¥æŒ‡å®š01/30/"
```

### å®Ÿè£…ç®‡æ‰€

**ãƒ•ã‚¡ã‚¤ãƒ«:** `frontend/src/features/ocr-results/pages/OcrResultsListPage.tsx`

**é–¢æ•°:** `buildShippingSlipText()`

```typescript
const buildShippingSlipText = (
  template: string | null,
  input: RowInputState,
  row: OcrResultItem,
): string => {
  if (!template) return "";

  const { hasValidLot } = validateLotInfo(input);
  const hasInboundNo = Boolean(input.inboundNo);

  // ä¸¡æ–¹ç©º â†’ ãã®ã¾ã¾è¿”ã™
  if (!hasValidLot && !hasInboundNo) {
    return template;
  }

  let result = template;

  // ãƒ­ãƒƒãƒˆç½®æ›ï¼ˆæœ‰åŠ¹ãªãƒ­ãƒƒãƒˆãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
  if (hasValidLot) {
    result = applyLotReplacement(result, input);
  }

  // å…¥åº«ç•ªå·ç½®æ›
  if (hasInboundNo) {
    result = result.replace(/å…¥åº«ç•ªå·/g, input.inboundNo);
  }

  // æ—¥ä»˜ç½®æ›ï¼ˆå¸¸ã«å®Ÿè¡Œï¼‰
  result = applyDateReplacements(result, input, row);

  return result;
};
```

---

## ãƒ­ãƒƒãƒˆå…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

### ä»•æ§˜

**ç›®çš„:** ãƒ­ãƒƒãƒˆNoã¨æ•°é‡ãŒç‰‡æ–¹ã ã‘å…¥åŠ›ã•ã‚Œã¦ã„ã‚‹å ´åˆã€å…¥åŠ›ãƒŸã‚¹ã®å¯èƒ½æ€§ãŒé«˜ã„ãŸã‚è­¦å‘Šè¡¨ç¤º

### ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ«

| ãƒ­ãƒƒãƒˆNo | æ•°é‡ | çŠ¶æ…‹ | è¡¨ç¤º |
|---------|------|------|------|
| âœ… ã‚ã‚Š | âœ… ã‚ã‚Š | âœ… æ­£å¸¸ | é€šå¸¸è¡¨ç¤º |
| âœ… ã‚ã‚Š | âŒ ç©º | âš ï¸ ä¸å®Œå…¨ | ğŸ”´ èµ¤èƒŒæ™¯è­¦å‘Š |
| âŒ ç©º | âœ… ã‚ã‚Š | âš ï¸ ä¸å®Œå…¨ | ğŸ”´ èµ¤èƒŒæ™¯è­¦å‘Š |
| âŒ ç©º | âŒ ç©º | âœ… æ­£å¸¸ï¼ˆæœªå…¥åŠ›ï¼‰ | é€šå¸¸è¡¨ç¤º |

### è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯

**ä¸å®Œå…¨ãªå…¥åŠ›ã®å ´åˆ:**
- èƒŒæ™¯è‰²: `bg-red-50`
- æ ç·šè‰²: `border-red-400`
- ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚: `focus:border-red-600 focus:ring-red-500`

**å®Ÿè£…ç®‡æ‰€:**

```typescript
// ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
const validateLotInfo = (
  input: RowInputState,
): { hasValidLot: boolean; hasIncomplete: boolean } => {
  const lot1HasNo = Boolean(input.lotNo1);
  const lot1HasQty = Boolean(input.quantity1);
  const lot2HasNo = Boolean(input.lotNo2);
  const lot2HasQty = Boolean(input.quantity2);

  // æœ‰åŠ¹ãªãƒ­ãƒƒãƒˆ: ãƒšã‚¢ã«ãªã£ã¦ã„ã‚‹
  const hasValidLot1 = lot1HasNo && lot1HasQty;
  const hasValidLot2 = lot2HasNo && lot2HasQty;
  const hasValidLot = hasValidLot1 || hasValidLot2;

  // ä¸å®Œå…¨: XORï¼ˆç‰‡æ–¹ã ã‘trueï¼‰
  const lot1Incomplete = lot1HasNo !== lot1HasQty;
  const lot2Incomplete = lot2HasNo !== lot2HasQty;
  const hasIncomplete = lot1Incomplete || lot2Incomplete;

  return { hasValidLot, hasIncomplete };
};
```

---

## å‡ºè·æ—¥è‡ªå‹•è¨ˆç®—

### ä»•æ§˜

**è¨ˆç®—å¼:**
```
å‡ºè·æ—¥ = ç´æœŸ - è¼¸é€LTï¼ˆå–¶æ¥­æ—¥ï¼‰
```

**æ¡ä»¶:**
- å‡ºè·ç”¨ãƒã‚¹ã‚¿ã« `transport_lt_days` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨
- ç´æœŸ (`delivery_date`) ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã“ã¨

**å–¶æ¥­æ—¥è¨ˆç®—:**
- `CalendarService` ã‚’ä½¿ç”¨
- ä¼šç¤¾ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆ`calendar` ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ã§ä¼‘æ¥­æ—¥ã‚’è€ƒæ…®
- åœŸæ—¥ç¥æ—¥ã‚’é™¤å¤–

### è¨ˆç®—ä¾‹

```
ã€è¨­å®šã€‘
- ç´æœŸ: 2026-01-30ï¼ˆé‡‘ï¼‰
- è¼¸é€LT: 3å–¶æ¥­æ—¥

ã€å–¶æ¥­æ—¥ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã€‘
- 2026-01-27ï¼ˆæœˆï¼‰: å–¶æ¥­æ—¥
- 2026-01-28ï¼ˆç«ï¼‰: å–¶æ¥­æ—¥
- 2026-01-29ï¼ˆæ°´ï¼‰: å–¶æ¥­æ—¥
- 2026-01-30ï¼ˆæœ¨ï¼‰: å–¶æ¥­æ—¥ï¼ˆç´æœŸï¼‰

ã€è¨ˆç®—çµæœã€‘
å‡ºè·æ—¥ = 2026-01-27ï¼ˆæœˆï¼‰
â€»3å–¶æ¥­æ—¥å‰ = æœ¨â†’æ°´â†’ç«â†’æœˆ
```

### è¡¨ç¤ºæ–¹æ³•

**è‡ªå‹•è¨ˆç®—å€¤ã®è¡¨ç¤º:**
- èƒŒæ™¯è‰²: `bg-blue-50`ï¼ˆé’èƒŒæ™¯ã§è­˜åˆ¥ï¼‰
- æ ç·šè‰²: `border-blue-300`
- ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—: ã€Œè‡ªå‹•è¨ˆç®—ï¼ˆLT=3æ—¥ï¼‰ã€

**æ‰‹å…¥åŠ›ã¨è‡ªå‹•è¨ˆç®—ã®å„ªå…ˆåº¦:**
```typescript
const displayDate = row.shipping_date || row.calculated_shipping_date;
```
â†’ æ‰‹å…¥åŠ›å€¤ãŒã‚ã‚Œã°ãã¡ã‚‰ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°è‡ªå‹•è¨ˆç®—å€¤

### å®Ÿè£…ç®‡æ‰€

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰:** `backend/app/presentation/api/routes/ocr_results_router.py`

```python
# å‡ºè·æ—¥ã®è‡ªå‹•è¨ˆç®—
if item.transport_lt_days and item.delivery_date:
    try:
        delivery_date_obj = datetime.strptime(item.delivery_date, "%Y-%m-%d").date()

        calendar_service = CalendarService(db)
        request = BusinessDayCalculationRequest(
            start_date=delivery_date_obj,
            days=item.transport_lt_days,
            direction="before",
            include_start=False,
        )
        item.calculated_shipping_date = calendar_service.calculate_business_day(request)
    except (ValueError, Exception):
        pass  # ã‚¨ãƒ©ãƒ¼æ™‚ã¯è¨ˆç®—ãªã—
```

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰:** `frontend/src/features/ocr-results/pages/OcrResultsListPage.tsx`

```typescript
function EditableDateCell({ row, field }) {
  const isShippingDate = field === "shippingDate";
  const isCalculated = isShippingDate && !value && row.calculated_shipping_date;
  const displayValue = isCalculated ? row.calculated_shipping_date : value;

  return (
    <input
      type="date"
      value={displayValue || ""}
      title={isCalculated ? `è‡ªå‹•è¨ˆç®—ï¼ˆLT=${row.transport_lt_days}æ—¥ï¼‰` : ""}
      className={cn(
        isCalculated
          ? "bg-blue-50 border-blue-300"
          : "bg-white border-gray-300"
      )}
    />
  );
}
```

---

## SAPãƒãƒƒãƒãƒ³ã‚°

### æ¦‚è¦

OCRçµæœã®æè³ªã‚³ãƒ¼ãƒ‰ã¨SAPãƒã‚¹ã‚¿ã®å…ˆæ–¹å“ç•ªï¼ˆZKDMAT_Bï¼‰ã‚’ç…§åˆã—ã€ä»•å…¥å…ˆæƒ…å ±ãƒ»æ•°é‡å˜ä½ãƒ»ãƒ¡ãƒ¼ã‚«ãƒ¼å“ç•ªã‚’å–å¾—ã—ã¾ã™ã€‚

### ãƒãƒƒãƒãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ3æ®µéšï¼‰

#### Step 1: ç›´æ¥ä¸€è‡´ï¼ˆEXACTï¼‰

```
SAPå…ˆæ–¹å“ç•ª(ZKDMAT_B) == OCRæè³ªã‚³ãƒ¼ãƒ‰
```

**ä¾‹:**
- OCRæè³ªã‚³ãƒ¼ãƒ‰: "M002"
- SAPã‚­ãƒ£ãƒƒã‚·ãƒ¥ã« "M002" ãŒå­˜åœ¨
- â†’ âœ… EXACT ãƒãƒƒãƒ

#### Step 2: ãƒã‚¹ã‚¿é€†å¼•ãï¼ˆMASTER_REVERSEï¼‰

```
1. ãƒã‚¹ã‚¿æ¤œç´¢:
   ã‚­ãƒ¼ = (å¾—æ„å…ˆã‚³ãƒ¼ãƒ‰, å…ˆæ–¹å“ç•ª=OCRæè³ªã‚³ãƒ¼ãƒ‰, æ¬¡åŒº)
   å–å¾— = æè³ªã‚³ãƒ¼ãƒ‰ï¼ˆãƒ¡ãƒ¼ã‚«ãƒ¼å“ç•ªï¼‰

2. SAPãƒãƒƒãƒãƒ³ã‚°:
   SAPå…ˆæ–¹å“ç•ª(ZKDMAT_B) == å–å¾—ã—ãŸæè³ªã‚³ãƒ¼ãƒ‰
```

**ä¾‹:**
- OCRæè³ªã‚³ãƒ¼ãƒ‰: "C001"ï¼ˆå¾—æ„å…ˆã®å‘¼ç§°ï¼‰
- ãƒã‚¹ã‚¿æ¤œç´¢ â†’ æè³ªã‚³ãƒ¼ãƒ‰ "M002" ã‚’å–å¾—
- SAPã‚­ãƒ£ãƒƒã‚·ãƒ¥ã« "M002" ãŒå­˜åœ¨
- â†’ âœ… MASTER_REVERSE ãƒãƒƒãƒ

#### Step 3: å‰æ–¹ä¸€è‡´ï¼ˆPREFIXï¼‰

```
SAPå…ˆæ–¹å“ç•ª(ZKDMAT_B) ãŒ OCRæè³ªã‚³ãƒ¼ãƒ‰ã§å‰æ–¹ä¸€è‡´
â€»ä¸€æ„ã«çµã‚Œã‚‹å ´åˆã®ã¿æ¡ç”¨ï¼ˆè­¦å‘Šè¡¨ç¤ºï¼‰
```

**ä¾‹:**
- OCRæè³ªã‚³ãƒ¼ãƒ‰: "M00"
- SAPã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§ "M00" ã§å§‹ã¾ã‚‹é …ç›®: "M002" ã®ã¿
- â†’ âš ï¸ PREFIX ãƒãƒƒãƒï¼ˆè­¦å‘Šï¼‰

#### ãƒãƒƒãƒãƒ³ã‚°å¤±æ•—ï¼ˆNOT_FOUNDï¼‰

- ä¸Šè¨˜ã„ãšã‚Œã«ã‚‚è©²å½“ã—ãªã„
- â†’ âŒ NOT_FOUND

### ãƒãƒƒãƒçµæœã®è¡¨ç¤º

**ã‚¢ã‚¤ã‚³ãƒ³:**
- âœ… EXACT: ç·‘ãƒã‚§ãƒƒã‚¯ï¼ˆå®Œå…¨ä¸€è‡´ï¼‰
- ğŸ”„ MASTER_REVERSE: é’çŸ¢å°ï¼ˆãƒã‚¹ã‚¿çµŒç”±ä¸€è‡´ï¼‰
- âš ï¸ PREFIX: é»„è‰²è­¦å‘Šï¼ˆå‰æ–¹ä¸€è‡´ã€è¦ç¢ºèªï¼‰
- âŒ NOT_FOUND: èµ¤Ã—ï¼ˆæœªä¸€è‡´ï¼‰

### å–å¾—æƒ…å ±

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | SAPãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å | èª¬æ˜ |
|-----------|----------------|------|
| `sap_supplier_code` | ZLIFNR_H | ä»•å…¥å…ˆã‚³ãƒ¼ãƒ‰ |
| `sap_supplier_name` | ï¼ˆãƒã‚¹ã‚¿ã‹ã‚‰å–å¾—ï¼‰ | ä»•å…¥å…ˆå |
| `sap_qty_unit` | MEINS | æ•°é‡å˜ä½ |
| `sap_maker_item` | ZMKMAT_B | ãƒ¡ãƒ¼ã‚«ãƒ¼å“ç•ª |
| `sap_matched_zkdmat_b` | ZKDMAT_B | ãƒãƒƒãƒã—ãŸå…ˆæ–¹å“ç•ª |

### å®Ÿè£…ç®‡æ‰€

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰:** `backend/app/application/services/sap/sap_reconciliation_service.py`

```python
class SapReconciliationService:
    def reconcile_single(
        self,
        material_code: str,
        jiku_code: str,
        customer_code: str,
    ) -> ReconciliationResult:
        # 1. ç›´æ¥ä¸€è‡´
        if material_code in self._sap_cache:
            return ReconciliationResult(sap_match_type=SapMatchType.EXACT, ...)

        # 2. ãƒã‚¹ã‚¿é€†å¼•ã
        master_material_code = self._lookup_master_material_code(
            customer_code, material_code, jiku_code
        )
        if master_material_code and master_material_code in self._sap_cache:
            return ReconciliationResult(sap_match_type=SapMatchType.MASTER_REVERSE, ...)

        # 3. å‰æ–¹ä¸€è‡´
        prefix_matches = [
            item for zkdmat_b in self._sap_cache
            if zkdmat_b.startswith(material_code)
        ]
        if len(prefix_matches) == 1:
            return ReconciliationResult(sap_match_type=SapMatchType.PREFIX, ...)

        return ReconciliationResult(sap_match_type=SapMatchType.NOT_FOUND)
```

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰:** `frontend/src/features/ocr-results/components/SapMatchIcon.tsx`

```tsx
function SapMatchIcon({ matchType }: { matchType?: string }) {
  switch (matchType) {
    case "exact":
      return <CheckCircle className="text-green-500" title="ç›´æ¥ä¸€è‡´" />;
    case "master_reverse":
      return <ArrowRightLeft className="text-blue-500" title="ãƒã‚¹ã‚¿çµŒç”±ä¸€è‡´" />;
    case "prefix":
      return <AlertTriangle className="text-yellow-500" title="å‰æ–¹ä¸€è‡´ï¼ˆè¦ç¢ºèªï¼‰" />;
    case "not_found":
      return <XCircle className="text-red-500" title="SAPæœªä¸€è‡´" />;
    default:
      return <Minus className="text-gray-400" title="æœªç…§åˆ" />;
  }
}
```

---

## ç·¨é›†å¯èƒ½ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

### ä¸€è¦§

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | èª¬æ˜ | ä¿å­˜å…ˆ |
|-----------|----|----|--------|
| `manual_lot_no_1` | string | ãƒ­ãƒƒãƒˆç•ªå·1 | `ocr_result_edits` |
| `manual_quantity_1` | string | æ•°é‡1 | `ocr_result_edits` |
| `manual_lot_no_2` | string | ãƒ­ãƒƒãƒˆç•ªå·2 | `ocr_result_edits` |
| `manual_quantity_2` | string | æ•°é‡2 | `ocr_result_edits` |
| `manual_inbound_no` | string | å…¥åº«No | `ocr_result_edits` |
| `manual_shipping_date` | date | å‡ºè·æ—¥ | `ocr_result_edits` |
| `manual_shipping_slip_text` | string | å‡ºè·ç¥¨ãƒ†ã‚­ã‚¹ãƒˆ | `ocr_result_edits` |
| `manual_jiku_code` | string | æ¬¡åŒº | `ocr_result_edits` |
| `manual_material_code` | string | æè³ªã‚³ãƒ¼ãƒ‰ | `ocr_result_edits` |
| `manual_delivery_quantity` | string | ç´å…¥é‡ | `ocr_result_edits` |
| `delivery_date` | string | ç´æœŸ | `ocr_result_edits` |

### ä¿å­˜å‡¦ç†

**API:** `POST /api/ocr-results/{item_id}/edit`

**è‡ªå‹•ä¿å­˜:**
- ãƒ‡ãƒã‚¦ãƒ³ã‚¹: 300ms
- å…¥åŠ›å¾Œ300msçµŒéã§è‡ªå‹•çš„ã«APIã‚³ãƒ¼ãƒ«
- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºãªã—ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ä¿å­˜ï¼‰

**å®Ÿè£…:**
```typescript
const saveTimersRef = useRef<Map<number, ReturnType<typeof setTimeout>>>(new Map());

const updateInputs = (row: OcrResultItem, updates: Partial<RowInputState>) => {
  // æ—¢å­˜ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
  const existingTimer = saveTimersRef.current.get(row.id);
  if (existingTimer) clearTimeout(existingTimer);

  // æ–°ã—ã„ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚»ãƒƒãƒˆï¼ˆ300mså¾Œã«ä¿å­˜ï¼‰
  const timer = setTimeout(() => {
    const payload = buildPayload(newState);
    saveMutation.mutate({ id: row.id, payload });
  }, 300);

  saveTimersRef.current.set(row.id, timer);
};
```

---

## é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰

- `backend/app/presentation/api/routes/ocr_results_router.py` - OCRçµæœAPI
- `backend/app/application/services/sap/sap_reconciliation_service.py` - SAPç…§åˆã‚µãƒ¼ãƒ“ã‚¹
- `backend/app/application/services/calendar_service.py` - å–¶æ¥­æ—¥è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹
- `backend/sql/views/create_views.sql` - v_ocr_results ãƒ“ãƒ¥ãƒ¼å®šç¾©
- `backend/app/infrastructure/persistence/models/smartread_models.py` - ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

- `frontend/src/features/ocr-results/pages/OcrResultsListPage.tsx` - ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
- `frontend/src/features/ocr-results/api.ts` - API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
- `frontend/src/features/ocr-results/components/SapMatchIcon.tsx` - SAPãƒãƒƒãƒã‚¢ã‚¤ã‚³ãƒ³

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

- `smartread_long_data` - OCRå–å¾—ãƒ‡ãƒ¼ã‚¿ï¼ˆç¸¦æŒã¡ï¼‰
- `ocr_result_edits` - æ‰‹å…¥åŠ›ãƒ‡ãƒ¼ã‚¿
- `shipping_master_curated` - å‡ºè·ç”¨ãƒã‚¹ã‚¿
- `sap_material_cache` - SAPãƒãƒ†ãƒªã‚¢ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- `calendar` - å–¶æ¥­æ—¥ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼

---

## å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ |
|------|-----------|---------|
| 2026-01-23 | v2.1 | åˆç‰ˆä½œæˆ |
| 2026-01-23 | v2.1 | ãƒ­ãƒƒãƒˆåŒºåˆ‡ã‚Šã‚’ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã«å¤‰æ›´ |
