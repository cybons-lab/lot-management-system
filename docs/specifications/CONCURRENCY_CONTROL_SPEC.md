# 排他制御・楽観的ロック仕様 (標準)

## 目的
データ競合による更新取りこぼしを防止し、今後のテーブル追加でも同様の問題が再発しないように統一ルールを定める。

## 適用範囲
書き換えを伴う全テーブルと、その更新系API。

## 用語
- `version`: 行単位の楽観的ロック用バージョン。
- `data_version`: タスクや親エンティティ単位のデータセットバージョン。
- `409 Conflict`: 競合検出時の標準エラーコード。

## 必須カラム
| 対象 | カラム | 型 | 既定 | 用途 |
| --- | --- | --- | --- | --- |
| 行更新型テーブル | `version` | INTEGER | 1 | 行更新の競合検出 |
| バッチ更新/全件上書き型 | `data_version` | INTEGER | 1 | データセット更新の競合検出 |

## API仕様
| 操作 | リクエスト | レスポンス |
| --- | --- | --- |
| 取得 | `version` または `data_version` を含める | 最新の `version` / `data_version` を返す |
| 更新 | `version` または `data_version` を必須 | 更新成功時は更新後のバージョンを返す |
| 削除 | `version` を必須 | 削除成功時は 204 / 200 を返す |

## 競合時の標準レスポンス
```
{
  "error": "OPTIMISTIC_LOCK_CONFLICT",
  "current_version": 3,
  "expected_version": 2,
  "message": "Data was modified by another user"
}
```

## バックエンド実装指針
1. 更新は `UPDATE ... WHERE version = :expected` で行う。
2. 更新件数が0の場合は 409 を返す。
3. バッチ更新では `data_version` を更新前にインクリメントし、保存処理全体を同一トランザクションで実施する。
4. 在庫や引当など二重計上リスクが高い処理は、悲観的ロック (`SELECT ... FOR UPDATE`) を優先する。

## フロントエンド実装指針
1. 取得レスポンスの `version` / `data_version` を状態に保持する。
2. 更新リクエストには必ず保持しているバージョンを送信する。
3. 409 を受けた場合は最新データを再取得し、差分確認や再入力を促す。

## 例外ポリシー
| パターン | 推奨 |
| --- | --- |
| 追記専用 (ログ、履歴、イベント) | `version` 不要 |
| 二重計上リスク高 | 悲観的ロックを優先 |
| バッチ再生成 | `data_version` を利用 |
