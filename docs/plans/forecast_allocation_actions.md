# フォーキャスト一覧からの引当アクション計画

**作成日:** 2025-12-05
**関連:** `forecast-order-integration-plan.md`

## 目的
フォーキャスト一覧ページから直接「引当推奨の生成」や「自動引当」を行えるようにします。これらのアクションはフォーキャストデータ（優先順位、グループ化）を利用して紐づく受注に対してロットを引当し、その結果を受注一覧にシームレスに反映させることを目的とします。

## 機能とロジック

### 1. 全体アクション: 「引当推奨生成」
*   **配置:** フォーキャスト一覧の右上（「SAP一括インポート」の横など）。
*   **対象:** 「フォーキャスト連携受注」（Order Type: `FORECAST_LINKED`）のうち、現在未引当または一部引当のすべての受注。
*   **ロジック:**
    1.  対象となるオープンな受注をすべて取得する。
    2.  製品×納入先でグループ化する。
    3.  各グループについて、利用可能な在庫（ロット）を取得する。
    4.  引当ロジック（FEFO - 先入先出/期限切迫順）を適用し、最適な引当を計算する。
        *   **拡張性:** 将来的なルール追加（例: 「出荷期限切れルール」「得意先別残存期間ルール」）に対応できる設計とする。
    5.  **アクション:** `allocations` テーブルに `soft`（仮引当）を作成する。
    6.  **制約 (重要):**
        *   既存の `hard`（確定引当）は**絶対に上書きしない**。
        *   既存の `soft`（仮引当）も、基本的には**維持する**（「未引当分のみ埋める」モードをデフォルトとする）。
        *   ※「全再計算（リセット）」モードは、運用ルールで厳密に管理する（例: 月初の初回のみ）。
*   **UIフィードバック:**
    *   処理中インジケータを表示（時間がかかる可能性があるため）。
    *   成功時: 「X件の受注に対して引当推奨を作成しました」と表示。
    *   失敗時: エラー詳細を表示。

### 2. グループアクション: 「自動引当」
*   **配置:** 各フォーキャストグループ（顧客×納入先×製品）のヘッダー。
*   **対象:** その特定のグループに属する受注。
*   **ロジック:**
    *   全体アクションと同様だが、対象をそのグループに限定する。
*   **UIフィードバック:**
    *   トースト通知: 「[製品名] の引当を行いました（Xロット）」

### 3. 受注アクション: 「自動引当」
*   **配置:** フォーキャストグループ内の「関連受注」リストの各行。
*   **対象:** 特定の単一受注。
*   **ロジック:**
    *   受注詳細ページの「自動引当」ボタンと同じロジック（単一受注に対するFEFO引当）。
*   **UIフィードバック:**
    *   行のステータスを即座に更新（例: 「未引当」→「引当済」）。

## 受注一覧との連携

これらのアクションは `allocations` テーブルを更新するため、受注一覧ページ（Order List）にもその結果が反映される必要があります。

### データ同期
*   **共通のデータソース:** 両方のページが `allocations` テーブルを参照します。
*   **ステータスマッピング:**
    *   フォーキャスト一覧で作成された `soft` 引当を持つ受注は、受注一覧でも **「引当済 (Soft)」** として表示されます。
    *   ユーザーは受注一覧で「引当ステータス: Soft」でフィルタリングすることで、推奨された引当を確認できます。

### ワークフロー
1.  **フォーキャスト一覧:** ユーザーが「引当推奨生成」をクリック。
2.  **システム:** `soft` 引当を計算して保存。
3.  **受注一覧:**
    *   ユーザーが受注一覧に移動。
    *   対象の受注が「引当済」（緑/黄色のバッジ）として表示される。
    *   ユーザーは内容を確認し、必要に応じて「Hard確定」（一括または個別）を行う。

## 実装ステップ

1.  **バックエンド API:**
    *   `POST /api/allocations/recommendations`: 全体/グループ単位の生成用エンドポイント。
        *   パラメータ: `group_id` (任意), `target_period` (任意)。
    *   既存の `POST /api/allocations/auto` を再利用: 単一受注用。

2.  **フロントエンド (フォーキャスト一覧):**
    *   「引当推奨生成」ボタンの実装（ローディング状態含む）。
    *   グループおよび受注ごとの「自動引当」ボタンの実装。
    *   APIとの接続。

3.  **フロントエンド (受注一覧):**
    *   「Soft引当済」ステータスが明確に区別できることを確認（実装済み？）。
    *   （将来的なステップ）「一括Hard確定」機能を追加し、フローを効率化する。

## 課題・リスク
*   **パフォーマンス:** 全受注に対する推奨生成は時間がかかる可能性があります。件数が多い場合はバックグラウンド処理やバッチ化を検討します。
*   **同時実行性:** 推奨生成中に受注が編集された場合はどうするか？（Soft引当なので、楽観的ロックや「後勝ち」で許容する方針で進める）。

## 引当ロジックとルール拡張性（将来対応）

現在は基本的な **FEFO (First Expired First Out)** ですが、ご要望の「有効期限の考慮（例: 1ヶ月以内は出荷不可）」や「製品/メーカーごとのルール」に対応するため、以下のような **ルールエンジン/フィルタリング設計** を採用します。

1.  **Candidate Selection (候補取得):** 在庫ロットを取得。
2.  **Filtering (ルール適用):**
    *   `GlobalExpiryRule`: 一律で「期限切れ」や「期限までX日未満」を除外。
    *   `ProductRule`: 製品ごとの個別ルール（例: A社製品は3ヶ月残存必須）。
    *   `CustomerRule`: 得意先ごとの納入条件（例: B社は製造後6ヶ月以内のみ）。
3.  **Sorting (優先順位):** FEFO順、ロットサイズ順など。
4.  **Allocation (数量割当):** 上位から順に引当。

この設計により、後から「この製品だけルールを変えたい」といった要望に柔軟に対応できます。

## 競合防止と運用ルール（他ユーザーへの影響防止）

「全受注に対する処理は月1回」という運用に合わせ、システム側で以下の安全策を講じます。

1.  **Hard引当の完全保護:**
    *   誰かが手動で確定（Hard）した引当は、自動計算ロジックが**一切触れません**。
    *   これにより、確定済みの作業が勝手に変更されることを防ぎます。

2.  **Soft引当の維持（追記モード）:**
    *   「一括推奨生成」は、デフォルトで **「未引当の数量（残数）」のみ** を対象とします。
    *   誰かが手動で仮置き（Soft）している場合も、それを維持し、足りない分だけを埋めに行きます。
    *   これにより、「他の人が作業中の仮引当」を勝手に書き換える事故を防ぎます。

3.  **再計算（リセット）の制限:**
    *   既存のSoft引当を全てクリアして再計算する「完全リセット」機能は、管理者権限または警告付きの特殊操作として実装します。
