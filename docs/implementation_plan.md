# Implementation Plan (Master)

> このドキュメントが唯一のマスター計画書です。更新時はここを起点にしてください。参考情報は `docs/tasks/archive/` に保存し、計画内容は常に本書に反映します。

## フェーズ構成
- **Phase 1:** 足回りの修正とデータ整備（最優先）
- **Phase 2:** コア機能の構造改革（UI/UXの抜本的変更）
- **Phase 3:** データモデル拡張と業務適合
- **Phase 4:** 品質向上

---

## Phase 1: 足回りの修正とデータ整備（最優先・今回実施）
現行開発で最優先する足回りタスク。これらが完了すると、以降のUI/UX改革やデータモデル拡張が進めやすくなる。

- **[BUG] マスタ管理リンクの修正 (TopNav vs Routes)**
  - **課題:** TopNavのマスタ系リンクが実際のルーティング定義とズレており、遷移に失敗するケースがある。
  - **対応:** `ROUTES.MASTERS` の定義とTopNavのドロップダウンリンクを完全に同期させ、/masters 配下の画面を含めて正常遷移できるようにする。

- **[MOCK] SAP入荷予定（発注残）データの作成**
  - **課題:** 入荷予定画面の確認に必要なSAPモックデータが不足している。
  - **対応:** `SAPMockClient` に入荷予定データ取得関数（発注番号、仕入先、倉庫、入荷予定日、明細など）を追加し、ダミー値でUI確認できるようにする。

- **[TOOL] 全画面自動スクリーンショットスクリプトの作成**
  - **目的:** 画面数が多いため、Playwrightで主要画面を巡回し `frontend/screenshots/` に保存する自動化スクリプトを用意する。
  - **対象:** ダッシュボード、需要予測、入荷予定、在庫/ロット/移動/調整、受注、引当、マスタ各種、設定、管理系ページなど、主要ルートを網羅。

---

## Phase 2: コア機能の構造改革（UI/UXの抜本的変更）
ユーザーの業務実態に合わせたUIへの変更を行う。

### [在庫管理] グルーピング表示 (仕入先/倉庫/製品)
- **現状の問題:** 在庫一覧が実質的に「ロット一覧」になっており情報過多で全体量を把握しにくい。
- **要件:** 「在庫管理（全体把握）」と「ロット管理（詳細）」の役割を明確に分ける。
- **実装詳細:**
  - 「仕入先別」「倉庫別」「製品別」の3パターンで在庫数を集約（Group By）して表示する機能を追加。
  - デフォルトは集約表示とし、ドリルダウンで詳細（ロット）が見れる形、または画面を分ける形にする。

### [受注管理] 明細単位（納入先単位）リストへの変更
- **現状の問題:** 受注番号（Order No）単位で表示されているが、業務の実態に合っておらず、受注番号の主張が強すぎてノイズになる。
- **ユーザーのメンタルモデル:**
  - 現場では「受注番号」ではなく「納入先（明細）」単位で物事を考えている。
  - 基本的に「1受注＝1明細（1納入先）」で運用されている。
  - 複数明細がある場合も、それは「複数の納入先」という意味合いが強い。
- **実装詳細:**
  - リストの主役を「受注ヘッダー」から「受注明細（納入先）」に変更する。
  - 受注番号は「ファイル名」のような扱いで控えめに表示（ツールチップやサブテキスト化）。
  - 一覧には「納入先」「製品」「数量」「納期」を大きく表示する。

### [ロット引当] 需要予測ページへの統合 & 未予測対応
- **現状の問題:** 引当作業を行う場所が分散しており、「需要予測がない注文」を引当てる画面が存在しない。
- **実装詳細:**
  - **予測ありの場合:** `ForecastDetailPage`（需要予測詳細）の中で、その予測に紐づく注文の引当を直接行えるようにコンポーネントを統合する。
  - **予測なしの場合:** 突発的な注文など、予測に紐付かない注文を処理するための `UnforecastedAllocationPage`（未予測引当画面）を新規作成する。

---

## Phase 3: データモデル拡張と業務適合

### [DB] スキーマ拡張 (Schema Improvements)
- `customer_items` に **出荷表テンプレート**（shipping_document_template）と **SAP備考**（sap_notes）を追加し、納入先ごとの指示文や備考を保持できるようにする。
- `order_lines` に **出荷指示テキスト**（shipping_document_text）を追加し、引当結果を転記して紙の指示書に出力するフローを整える。
- `customer_item_jiku_mappings` を追加し、1製品・複数納入先（次区コード）に対応できるようにする。

### [AUTH] ユーザー・仕入先担当割り当て
- **目的:** ユーザーごとに担当する仕入先を管理し、在庫や取引一覧で「自分の担当分だけ表示」を可能にする。
- **主要要件:**
  - ユーザーは複数仕入先を担当でき、仕入先にも複数担当者を設定可能。
  - 主担当（is_primary）を一意に管理し、優先表示・フィルタに利用する。
- **データモデル:** `user_supplier_assignments` テーブル＋ `v_user_supplier_assignments` ビューで担当者情報を提供し、必要に応じて在庫ビューへ主担当情報をJoinする。

---

## Phase 4: 品質向上

### [LOG] エラーロギングとDBエラーメッセージのユーザーフレンドリー化
- **フロントエンド:** `ErrorBoundary` とエラーロガーサービスでUI崩壊を防ぎつつクライアント側の例外を収集。axiosレスポンスインターセプターでAPIエラーも記録。
- **バックエンド/DB:** Unique制約違反などをユーザーが理解できる文言に変換し、ロギングと通知を整備する。
- **ステータス:** 計画中。Phase 1 完了後に着手。

---

## アーカイブと履歴
- 統合済み・完了済みの旧タスクは `docs/tasks/archive/` に保管。最新計画は必ず本書を参照すること。
