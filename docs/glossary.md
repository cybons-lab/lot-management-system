# 業務用語集 (Business Glossary)

## 納入先・工場関連

### 次区コード (jiku_code)
- **意味**: トヨタJITシステムの工場区域コード
- **読み**: じく
- **背景**: ジャスト・イン・タイム（Just-In-Time）生産方式で使用される工場内の特定区域
- **テーブル**: `delivery_places.jiku_code`
- **重要性**: 受注/予測データの一意キー = (得意先, 先方品番, 次区)の一部
- **実務**: 実務者が日常的に「ジク」と呼んでいる業務固有用語

### 納入先コード (delivery_place_code)
- **意味**: 実際の納入先を識別するコード
- **テーブル**: `delivery_places.delivery_place_code`
- **SAP側**: SAP商品マスタで管理

---

## 品番関連

### メーカー品番 (maker_part_code)
- **意味**: メーカーが決める標準品番
- **別名**: 自社品番
- **テーブル**: `products.maker_part_code`
- **対となる概念**: 先方品番 (external_product_code)
- **使用例**: "ABC-12345"
- **重要性**: システム内での商品の主要識別子

### 先方品番 (external_product_code)
- **意味**: 得意先が指定する品番
- **別名**: 顧客品番、得意先品番
- **テーブル**: `customer_items.external_product_code`
- **重要性**: 同じ製品でも得意先ごとに異なる品番を持つ可能性がある
- **ビジネスルール**: 受注/予測は (得意先, 先方品番, 次区) で一意に識別
- **SAP側**: SAP商品マスタの主要構成要素

---

## SAP連携関連

### SAP商品マスタ
- **構造**: 1レコード = (仕入元, 製品, 得意先, 次区, 出荷表テキスト, 備考)
- **制約**: 1つの商品につき1つの納入先のみ設定可能
- **問題**: 実際は複数の次区コードが必要だが、SAPでは1つしか登録できない
- **解決策**: 本システムで次区コードマッピングを管理

### 出荷表テキスト (shipping_document_template)
- **意味**: 出荷指示に使用する定型文
- **格納**: `customer_items.shipping_document_template`（計画中）
- **フロー**:
  1. 受注登録時に定型文を読み込む
  2. ロット引当後、ロット番号を書き込む
  3. 印刷して工場に出荷指示
- **重要性**: 工場の出荷作業の指示書となる

---

## 在庫管理関連

### ロット (Lot)
- **意味**: 入荷単位ごとの在庫管理単位
- **一意性**: 製品, 倉庫, ロット番号の組み合わせで一意
- **テーブル**: `lots`
- **管理項目**: 現在数量、引当数量、期限日、検査状態など

### 引当 (Allocation)
- **意味**: 受注に対してロットを割り当てること
- **テーブル**: `allocations`
- **種類**:
  - **正式引当** (`allocated`): 実在庫（ロット）からの引当
  - **仮引当** (`provisional`): 入荷予定からの引当（在庫到着前）
- **重要性**: 受注に対する在庫確保の記録

### 仮在庫 (Provisional Stock)
- **意味**: 入荷予定として計画されている在庫（まだ入庫していない）
- **計算**: 入荷予定明細の合計数量
- **ビュー**: `v_inventory_summary.provisional_stock`
- **用途**: 仮引当の対象となる

### FEFO (First Expired, First Out)
- **意味**: 期限の早いものから出庫するルール
- **実装**: 引当アルゴリズムで使用
- **目的**: 在庫の鮮度管理、廃棄削減

---

## ユーザー管理関連

### 担当割り当て (User-Supplier Assignment)
- **意味**: ユーザーごとに担当する仕入先を管理
- **テーブル**: `user_supplier_assignments`（計画中）
- **用途**: 
  - 画面での優先表示（自分の担当仕入先を上位に）
  - フィルタリング（自分の担当のみ表示）
  - 業務の責任範囲の明確化
- **主担当**: 仕入先ごとに1人の主担当者を設定可能

---

## 受注管理関連

### 受注データの一意キー
受注/予測データは以下の3つのキーで一意に識別されます：

```
(得意先コード, 先方品番, 次区コード)
```

- **得意先コード** (`customer_code`): どの顧客からの注文か
- **先方品番** (`external_product_code`): 顧客が指定する品番
- **次区コード** (`jiku_code`): トヨタJITシステムの工場区域コード

**重要性**: この組み合わせにより、同じ製品でも納入先や区域ごとに別の受注として管理可能

---

## 楽観的ロック関連

### version
- **意味**: 楽観的ロック用のバージョン番号
- **テーブル**: `lots.version`, `order_lines.version`
- **挙動**: 更新のたびに自動的にインクリメント
- **目的**: 同時更新による競合を検出・防止
- **Note**: 以前は`version_id`という名前だったが、SQLAlchemy慣習に合わせて`version`に変更

---

## データフロー

### 受注処理フロー（SAP連携）

```
1. SAP連携 or 手動入力
   ↓ (得意先, 先方品番, 次区)
2. customer_items から商品情報を取得
   ↓ (メーカー品番, 仕入先, 出荷表テキスト定型文)
3. 次区コード → 納入先コード 変換
   ↓ (customer_item_jiku_mappings 参照)
4. 受注明細を作成
   ↓
5. ロット引当実行（FEFO）
   ↓
6. 引当完了後、出荷表テキストにロット番号を記入
   ↓
7. 印刷 → 工場へ出荷指示
```

### 入荷処理フロー（SAP連携・仮在庫）

```
1. SAPから発注データ取得
   ↓
2. 入荷予定（InboundPlan）を作成
   ↓ (仮在庫として計上)
3. 仮引当が可能に
   ↓ (受注に対して入荷予定から引当)
4. 入庫確定
   ↓ (ロット番号を手入力)
5. ロット生成・在庫計上
   ↓
6. 仮引当 → 正式引当 に変換
```

---

## 用語間の関係図

```
┌─────────────┐
│  SAP商品マスタ │
│ (1商品1次区) │
└──────┬──────┘
       │
       ▼
┌─────────────────────┐
│  本システム           │
│ ・メーカー品番        │
│ ・先方品番           ◄──── 得意先別に管理
│ ・次区コード(複数)   │
│ ・出荷表テキスト      │
└─────────────────────┘
       │
       ▼
┌─────────────────────┐
│ 受注データ           │
│ (得意先, 先方品番, 次区) │
└─────────────────────┘
       │
       ▼
┌─────────────────────┐
│ ロット引当           │
│ (FEFO, 仮引当対応)   │
└─────────────────────┘
       │
       ▼
┌─────────────────────┐
│ 出荷指示             │
│ (出荷表テキスト)     │
└─────────────────────┘
```

---

## 重要なビジネスルール

1. **受注の一意性**: (得意先, 先方品番, 次区) で一意
2. **SAP制約**: 1商品1次区のみ → システムで複数次区を管理
3. **引当優先順**: FEFO（期限の早いものから）
4. **仮引当**: 入荷予定からの引当が可能
5. **ロット番号**: 入庫確定時に手入力（本番環境では必須）
6. **担当割り当て**: 仕入先ごとに主担当1人
7. **出荷指示**: ロット引当後、出荷表テキストに記入して印刷

---

## 参考資料

- [README.md](../README.md): システム概要
- [CHANGELOG_sap_inbound.md](../brain/CHANGELOG_sap_inbound.md): SAP連携の変更履歴
- [comprehensive_schema_improvements.md](../brain/comprehensive_schema_improvements.md): スキーマ改善計画
