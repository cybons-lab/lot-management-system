# 素材納品書発行機能 実行・連携仕様書 (Step2/3/4)

## 1. 概要
本ドキュメントは、素材納品書発行業務における **Step2（確認）〜 Step3（本番発行）〜 Step4（事後確認）** の一連の実行フローとシステム仕様をまとめたものである。
全工程を単一の **Run (run_id)** で管理し、ステータスに応じて表示・編集権限を厳格に制御する。

## 2. ステータス遷移設計

Runは以下のステータスを持ち、APIにより順序付き遷移を強制される。

| ステータス | 名称・意味 | 許可される操作 | 次の遷移(トリガー) |
| :--- | :--- | :--- | :--- |
| `step2_confirmed` | Step2実行待ち (確認完了) | 編集(UI), Step3実行 | `step3_running` (実行ボタン) |
| `step3_running` | Step3実行中 (PAD稼働) | 閲覧のみ, PAD結果更新 | `step3_done` (全件完了) |
| `step3_done` | 外部手順待ち (Step3完了) | 閲覧のみ, 外部完了ボタン | `step4_checking` (外部完了ボタン) |
| `step4_checking` | Step4確認待ち | 閲覧のみ, Step4チェック | `step4_checking` (チェック開始) |
| `step4_check_running` | Step4チェック中 | 閲覧のみ | `ready_for_step4_review` (突合完了) |
| `ready_for_step4_review` | Step4結果確認 | 閲覧のみ, 再実行(×のみ) | `done` (全○確認), `step3_running` (再実行) |
| `done` | 全工程完了 | 閲覧のみ | - |

> **重要**: Step3完了後、自動でStep4へは進まない。「IEモードサイトでの部分キャンセル」等の外部手順を必須ゲートとしているためである。

## 3. Step3: 本番発行 (PAD連携)

### 3.1 処理方針
*   **Web UI**: ユーザーによる編集は**完全禁止**（読み取り専用）。進捗監視のみ可能。
*   **PAD**: ポーリング型（Pull）でアイテムを取得し、処理結果を別エンドポイントへPushする。

### 3.2 アイテム取得 (Pull)
*   **API**: `GET /runs/{run_id}/next-item`
*   **タイムアウト回収**:
    *   アイテム取得時、`processing` 状態かつ開始から **2分** 以上経過しているアイテムがあれば、強制的に `failed_timeout` 等の失敗ステータスに変更して回収する。
    *   これにより、PADの異常終了によるスタックを防ぐ。
*   **優先順位**: メーカー（層別コード）ごとの残件数が少ない順（小ロット優先）。

### 3.3 結果更新 (Push)
*   **API**: `PATCH /runs/{run_id}/items/{item_id}/rpa-result` (PAD専用)
*   **許可フィールド**: `issue_done` (発行完了), `result` (結果ステータス), `sap_doc_no` (SAP伝票No), `match_result` (突合)
*   **制約**: UI用の更新API (`PATCH /items/{id}`) は、Step3実行中は使用禁止とする。

## 4. Step4: 事後確認 (突合)

### 4.1 必須ゲート: 外部手順完了
Step3完了後（`step3_done_waiting_external`）、ユーザーは外部システム（IEモードサイト等）での手動処理を行う必要がある。
*   完了後、「外部手順完了」ボタンを押下する (`POST /runs/{run_id}/external-done`)。
*   これによりステータスが `ready_for_step4_check` に遷移し、Step4の機能が有効化される。

### 4.2 突合プロセス
1.  **チェック開始**: ユーザーがStep1と同様の手順で最新データを取得したCSVをアップロードする。
2.  **変化確認**: システムはアイテムごとに「ステータスが期待通り変化したか」を判定する。
    *   変化あり → 突合OK (○)
    *   変化なし → 突合NG (×)
3.  **再実行**: NG (×) がある場合、そのアイテムだけを対象にStep3を再実行できる。

## 5. UI/UX設計 (ViewMode)

単一の詳細画面 (`RunDetailPage`) を、ステータスに応じた **ViewMode** で切り替えて表示する。

| ViewMode | 対応ステータス | 表示列 | 編集可否 | アクション |
| :--- | :--- | :--- | :--- | :--- |
| **Step2** | `step2_confirmed` | 基本情報, 納入量 | **可** (納入量, 発行F) | Step3実行 |
| **Step3** | `step3_running` ～ `step3_done` | ステータス, SAP情報 | **不可** (ReadOnly) | 進捗確認, 外部完了 |
| **Step4** | `step4_checking` 以降 | 突合結果 | **不可** | チェック開始, 再実行 |

## 6. システムアーキテクチャ・データフロー

(Mermaid図は省略するが、PADとのPull/Push型連携、および外部完了ゲートを介したStep4への遷移フローに従う)
