# 品番マスタ設計の矛盾と問題点

**作成日**: 2026-01-27
**ステータス**: 🔴 要対応
**影響範囲**: マスタデータ登録フロー、データ整合性

---

## 目次

1. [問題の概要](#問題の概要)
2. [データモデルの定義](#データモデルの定義)
3. [現在の問題点](#現在の問題点)
4. [ユーザー指摘事項](#ユーザー指摘事項)
5. [設計意図と実装の乖離](#設計意図と実装の乖離)
6. [影響範囲](#影響範囲)
7. [修正案](#修正案)

---

## 問題の概要

ロット管理システムの品番マスタにおいて、以下の矛盾が発生しています:

### 主要な問題

1. **循環依存の設計ミス**
   - 「メーカー品番マスタ」の登録に「商品」が必要
   - しかし「商品」の登録には本来「メーカー品番」が必要
   - どちらを先に登録すべきか不明確

2. **データモデルと実装の不一致**
   - DB: `supplier_items.product_id` は `nullable=True`（任意）
   - UI: フォームで `product_id` が必須

3. **用語の不統一**
   - 画面表示: 「先方品番マスタ」
   - コード: `CustomerItems`（得意先品番マッピング）
   - → **2026-01-27 修正済み**: 「得意先品番マスタ」に統一

4. **データの不整合**
   - `products.maker_part_code` に先方品番（customer_part_no）が混入
   - マイグレーションでデータが混ざった状態

5. **Excelビューの不具合**
   - 仕入先選択後に得意先品番が表示されない
   - `customer_items.supplier_id` の紐付けが不完全

---

## データモデルの定義

### 1. SupplierItem (仕入先品目マスタ)

**テーブル名**: `supplier_items` (旧 `product_suppliers`)

**役割**: 在庫管理の最小単位。仕入先から仕入れる品目情報を管理。**SSOT (Single Source of Truth)**

**DDL定義**:
```python
class SupplierItem(SoftDeleteMixin, Base):
    __tablename__ = "supplier_items"

    id: Mapped[int] = mapped_column(BigInteger, primary_key=True, autoincrement=True)

    # 外部キー
    product_id: Mapped[int | None] = mapped_column(
        BigInteger,
        ForeignKey("products.id", ondelete="RESTRICT"),
        nullable=True,  # ← NULL許容（重要）
    )
    supplier_id: Mapped[int] = mapped_column(
        BigInteger,
        ForeignKey("suppliers.id", ondelete="RESTRICT"),
        nullable=False,
    )

    # メーカー品番（ビジネスキーの一部）
    maker_part_no: Mapped[str] = mapped_column(
        String(100),
        nullable=False,
        comment="メーカー品番（仕入先の品番）",
    )

    # 属性
    base_unit: Mapped[str | None] = mapped_column(String(20), nullable=True)
    net_weight: Mapped[Decimal | None] = mapped_column(Numeric(10, 3), nullable=True)
    weight_unit: Mapped[str | None] = mapped_column(String(20), nullable=True)
    is_primary: Mapped[bool] = mapped_column(Boolean, nullable=False, default=False)
    lead_time_days: Mapped[int | None] = mapped_column(Integer, nullable=True)
    display_name: Mapped[str | None] = mapped_column(String(200), nullable=True)
    notes: Mapped[str | None] = mapped_column(Text, nullable=True)

    # ソフトデリート
    valid_to: Mapped[date] = mapped_column(
        Date, nullable=False, server_default=text("'9999-12-31'")
    )
    created_at: Mapped[datetime]
    updated_at: Mapped[datetime]

    __table_args__ = (
        # ビジネスキー: supplier_id + maker_part_no でユニーク
        UniqueConstraint("supplier_id", "maker_part_no",
                        name="uq_supplier_items_supplier_maker"),
        # 1製品につき1つのis_primary=true
        Index("idx_supplier_items_is_primary", "product_id", unique=True,
              postgresql_where=text("is_primary = true")),
    )
```

**画面表示**: メーカー品番マスタ (`/masters/supplier-products`)

---

### 2. Product (製品マスタ)

**テーブル名**: `products`

**役割**: 複数のメーカー品番を束ねるグループ定義・分類（名寄せ用）

**DDL定義**:
```python
class Product(SoftDeleteMixin, Base):
    __tablename__ = "products"

    id: Mapped[int] = mapped_column(BigInteger, primary_key=True, autoincrement=True)

    # ビジネスキー（システム内部識別子）
    maker_part_code: Mapped[str] = mapped_column(
        String(100),
        nullable=False,
        comment="システム内部識別子（本来はメーカー品番ではなくグループID）"
    )
    product_name: Mapped[str] = mapped_column(String(200), nullable=False)

    # 単位情報
    base_unit: Mapped[str] = mapped_column(String(20), nullable=False)
    internal_unit: Mapped[str] = mapped_column(String(20), nullable=False, server_default="CAN")
    external_unit: Mapped[str] = mapped_column(String(20), nullable=False, server_default="KG")
    qty_per_internal_unit: Mapped[Decimal] = mapped_column(
        Numeric(10, 4), nullable=False, server_default="1.0"
    )

    consumption_limit_days: Mapped[int | None] = mapped_column(Integer, nullable=True)
    qty_scale: Mapped[int] = mapped_column(Integer, nullable=False, server_default="1")

    # ソフトデリート
    valid_to: Mapped[date] = mapped_column(
        Date, nullable=False, server_default=text("'9999-12-31'")
    )
    created_at: Mapped[datetime]
    updated_at: Mapped[datetime]

    __table_args__ = (
        UniqueConstraint("maker_part_code", name="uq_products_maker_part_code"),
    )
```

**画面表示**: 商品構成マスタ (`/masters/products`)

---

### 3. CustomerItem (得意先品番マスタ)

**テーブル名**: `customer_items`

**役割**: 得意先の注文書に記載される品番（変換ルール）を管理

**DDL定義**:
```python
class CustomerItem(SoftDeleteMixin, Base):
    __tablename__ = "customer_items"

    id: Mapped[int] = mapped_column(BigInteger, primary_key=True, autoincrement=True)

    # 外部キー
    customer_id: Mapped[int] = mapped_column(
        BigInteger,
        ForeignKey("customers.id", ondelete="CASCADE"),
        nullable=False,
    )
    product_id: Mapped[int] = mapped_column(
        BigInteger,
        ForeignKey("products.id", ondelete="RESTRICT"),
        nullable=False,
    )
    supplier_id: Mapped[int | None] = mapped_column(
        BigInteger,
        ForeignKey("suppliers.id", ondelete="SET NULL"),
        nullable=True,  # レガシー、非推奨
    )
    supplier_item_id: Mapped[int | None] = mapped_column(
        BigInteger,
        ForeignKey("supplier_items.id", ondelete="SET NULL"),
        nullable=True,  # ← 本来はこちらを使用すべき
    )

    # 得意先品番（ビジネスキーの一部）
    customer_part_no: Mapped[str] = mapped_column(
        String(100),
        nullable=False,
        comment="得意先品番（先方品番）",
    )

    # 属性
    is_primary: Mapped[bool] = mapped_column(Boolean, server_default=text("false"), nullable=False)
    base_unit: Mapped[str] = mapped_column(String(20), nullable=False)
    pack_unit: Mapped[str | None] = mapped_column(String(20), nullable=True)
    pack_quantity: Mapped[int | None] = mapped_column(Integer, nullable=True)
    special_instructions: Mapped[str | None] = mapped_column(Text, nullable=True)

    # ソフトデリート
    valid_to: Mapped[date] = mapped_column(
        Date, nullable=False, server_default=text("'9999-12-31'")
    )
    created_at: Mapped[datetime]
    updated_at: Mapped[datetime]

    __table_args__ = (
        UniqueConstraint("customer_id", "customer_part_no",
                        name="uq_customer_items_customer_part"),
        Index("idx_customer_items_is_primary_unique", "supplier_item_id", unique=True,
              postgresql_where=text("is_primary = true AND supplier_item_id IS NOT NULL")),
    )
```

**画面表示**: 得意先品番マスタ (`/masters/customer-items`)

---

## 現在の問題点

### 問題1: メーカー品番マスタの登録フローが循環依存

**症状**:
- 「メーカー品番マスタ」（`/masters/supplier-products`）で新規登録しようとすると
- フォームで「商品」の選択が必須になっている
- しかし「商品」は本来「メーカー品番」をグループ化するためのもの

**データモデル vs 実装**:

| 項目 | データモデル | フロントエンド実装 | 矛盾 |
|:---|:---|:---|:---|
| `supplier_items.product_id` | `nullable=True`（任意） | 必須（`min(1)`） | ❌ |
| 登録順序 | メーカー品番が先 | 商品が先 | ❌ |

**コード証拠**:

**バックエンド（正しい）**:
```python
# supplier_item_model.py L62-66
product_id: Mapped[int | None] = mapped_column(
    BigInteger,
    ForeignKey("products.id", ondelete="RESTRICT"),
    nullable=True,  # ← NULL許容
)
```

**フロントエンド（間違い）**:
```typescript
// SupplierProductForm.tsx L37-42
const schema = z.object({
  product_id: z.coerce.number().min(1, "商品を選択してください"),  // ← 必須
  supplier_id: z.coerce.number().min(1, "仕入先を選択してください"),
  is_primary: z.boolean().default(false),
  lead_time_days: z.number().nullable(),
});
```

**問題の影響**:
- ユーザーは「商品」を先に作成しなければならない
- しかし「商品」のデータがないまま、どうやって「商品」を作るのか？
- → 循環依存により、データ登録が困難

---

### 問題2: 商品（products）のmaker_part_codeにデータが混入

**症状**:
- `products.maker_part_code` には本来「システム内部識別子」が入るべき
- しかし実際には「得意先品番（customer_part_no）」が混ざっている

**原因**:
- マイグレーション時にデータが不正確にコピーされた
- サンプルデータ生成時に `maker_part_code` を流用している

**コード証拠**:
```python
# masters.py L228-235 (サンプルデータ生成)
for idx, supplier in enumerate(selected_suppliers):
    maker_part_no = p.maker_part_code  # ← products.maker_part_codeを使用
    if (supplier.id, maker_part_no) not in supplier_maker_pairs:
        si = SupplierItem(
            product_id=p.id,
            supplier_id=supplier.id,
            maker_part_no=maker_part_no,  # ← ここでコピー
            is_primary=(idx == 0),
        )
```

**期待されるデータ**:
```
products.maker_part_code: "PRD-001" (システム内部ID)
supplier_items.maker_part_no: "DENSO-12345" (メーカー品番)
customer_items.customer_part_no: "TOYOTA-ABC-99" (得意先品番)
```

**実際のデータ**:
```
products.maker_part_code: "TOYOTA-ABC-99" ← 混入！
supplier_items.maker_part_no: "TOYOTA-ABC-99"
customer_items.customer_part_no: "TOYOTA-ABC-99"
```

---

### 問題3: Excelビューで仕入先選択後に得意先品番が表示されない

**症状**:
- Excelビュー（`/inventory/excel-portal`）で仕入先を選択
- 次のステップ「製品・得意先品番」が空っぽになる

**原因**:
- フロントエンドが `customer_items.supplier_id` でフィルタしている
- しかし `customer_items.supplier_id` が NULL または不正確
- 正しくは `customer_items.supplier_item_id` → `supplier_items.supplier_id` で参照すべき

**修正状況**:
- ✅ **Backend**: `GET /api/masters/customer-items?supplier_id=XXX` 実装済み
  - `supplier_item_id` → `supplier_items.supplier_id` 経由でフィルタ
- ✅ **Frontend API**: `supplier_id` パラメータ追加済み
- 🔄 **Frontend UI**: ExcelPortalPage の実装が未完了

**コード証拠（現状の問題）**:
```tsx
// ExcelPortalPage.tsx L39-43 (修正前)
const { data: allCustomerItems = [], isLoading: isLoadingCustomerItems } = useQuery({
  queryKey: ["customer-items", "all"],
  queryFn: () => getCustomerItems({ limit: 1000 }),  // ← 全件取得
  staleTime: 1000 * 60 * 5,
});

// L56-59 (フロントエンドでフィルタ)
const customerItemsForSupplier = useMemo(() => {
  if (!selected.supplierId) return [];
  return allCustomerItems.filter((item) => item.supplier_id === selected.supplierId);  // ← 不正確
}, [allCustomerItems, selected.supplierId]);
```

**修正案**:
```tsx
// supplier_idパラメータを使ってバックエンドでフィルタ
const { data: customerItemsForSupplier = [], isLoading: isLoadingCustomerItems } = useQuery({
  queryKey: ["customer-items", "by-supplier", selected.supplierId],
  queryFn: () =>
    selected.supplierId
      ? getCustomerItems({ supplier_id: selected.supplierId, limit: 1000 })
      : Promise.resolve([]),
  enabled: selected.supplierId !== null,
  staleTime: 1000 * 60 * 5,
});
```

---

## ユーザー指摘事項

### 1. 「先方品番マスタが得意先品番マッピング？」

**指摘内容**:
- 画面表示: 「先方品番マスタ」
- コード/ドキュメント: 「得意先品番マッピング」
- 用語が統一されていない

**対応状況**:
✅ **2026-01-27 修正完了**
- 画面タイトルを「得意先品番マスタ」に統一
- マスタ管理ページのメニューも統一
- Excelポータルページの表示も統一

### 2. 「メーカー品番マスタなのに、既にメーカー品番が存在してるのが不思議」

**指摘内容**:
- 「メーカー品番マスタ」で新規登録しようとすると
- 「商品」のドロップダウンが表示される
- しかしその時点で既に商品データが存在している
- **どこで入力したのか？**

**調査結果**:
1. **サンプルデータ自動生成** (`init-sample-data`)
   - `generate_customer_items()` が自動的に SupplierItem を作成
   - UI を使わずにデータが投入される

2. **マイグレーション** (`g1h2i3j4k5l6`)
   - `products.maker_part_code` から `maker_part_no` をバックフィル

3. **UI画面は存在する** (`/masters/supplier-products`)
   - SupplierProductsPage.tsx が完全実装
   - ただしフォームで `product_id` が必須になっている

### 3. 「この時点でデータを呼ぶ形になってる」

**指摘内容**:
- メーカー品番登録ダイアログで「商品を選択」が表示される
- しかしメーカー品番を登録する前に、なぜ商品が必要なのか？
- **循環依存になっている**

**問題の本質**:
```
❌ 現在の実装:
  メーカー品番マスタ（supplier_items）
    ↓ 登録時に必要
  商品（products）が先に必要
    ↓ しかし商品の登録には
  メーカー品番が必要（本来）
```

**設計意図（正しい）**:
```
✅ 本来の設計:
  1. メーカー品番を先に登録（supplier_items）
     - supplier_id + maker_part_no のみで登録可能
     - product_id は NULL 許容

  2. 商品（products）は後から任意でグループ化
     - 複数のメーカー品番を束ねたいときに作成
```

---

## 設計意図と実装の乖離

### 設計ドキュメントでの位置づけ

**CLAUDE.md より**:
```markdown
### Phase 別進捗

Phase 0 ~ 1: 完了 ✓
- UI メニュー構成の再編（「メーカー品番」を先頭に）
- テーブル名の一貫性（`product_suppliers` → `supplier_items`）

Phase 2: 進行中 (互換モード: `strict=False`)
- `supplier_items` に `supplier_item_id` 参照追加
- **未マッピング検証基盤** 導入（アラート機能）

Phase 3: 計画中 (厳密モード: `strict=True` へ切替)
- 在庫計算ロジックが `supplier_items` ベースに完全移行
- **未マッピング品目の出荷指示でエラー**
```

**調査レポートより**:
```
主役度:
  supplier_items: ⭐⭐⭐ (在庫基準)
  customer_items: ⭐⭐ (受注・出荷)
  products: ⭐ (グループ化)
  product_mappings: ☆ (調達・未実装)

設計意図の変遷:
- 旧設計: products が主役 → 現在は「名寄せ用」へ降格
- 新設計: supplier_items (メーカー品番) が主役 → SSOT
```

### 実装の現状

| 項目 | 設計意図 | 実装状況 | 乖離 |
|:---|:---|:---|:---|
| メーカー品番の位置づけ | 主役（⭐⭐⭐） | 商品に依存 | ❌ |
| `product_id` の必須性 | 任意（NULL許容） | 必須 | ❌ |
| 登録順序 | メーカー品番が先 | 商品が先 | ❌ |
| `supplier_item_id` 参照 | Phase 2 で導入 | 一部未使用 | △ |
| 未マッピング検証 | Phase 2 で導入 | 実装済み | ✅ |

---

## 影響範囲

### 1. データ登録フロー

**現状の運用（回避策）**:
1. まず「商品構成マスタ」でダミーデータを作成
2. その後「メーカー品番マスタ」で紐付け
3. 最後に「得意先品番マスタ」で変換ルールを登録

**問題点**:
- 手順が複雑で分かりにくい
- ダミーデータが残る可能性
- 設計意図と逆の順序

### 2. データ整合性

**影響を受けるテーブル**:
- `supplier_items`: `product_id` が必須になっているため、NULL が登録できない
- `products`: 不正確なデータ（得意先品番）が混入
- `customer_items`: `supplier_id` が不正確、`supplier_item_id` が未設定

### 3. 既存機能

**影響を受ける機能**:
- ✅ **Excelビュー**: 修正中（バックエンド完了、フロントエンド残）
- ❌ **在庫計算**: `supplier_items` ベースへの移行が未完了
- ❌ **出荷指示**: 未マッピング品目のエラー処理が未実装（Phase 3）
- ❌ **単位換算**: `product_uom_conversions` から `supplier_items` への移行が未完了

---

## 修正案

### Option A: フォームを修正して product_id を任意にする（推奨）

**変更内容**:

1. **フロントエンド修正**:
   - `SupplierProductForm.tsx` のスキーマ変更
   - `product_id` を任意にする
   - `maker_part_no` フィールドを追加（手入力）

2. **バックエンド修正**:
   - `SupplierItemCreate` スキーマで `product_id` を任意に
   - バリデーションロジック調整

3. **UI/UX 改善**:
   - 「商品」フィールドを「後から紐付け（任意）」として表示
   - 「メーカー品番」を主要入力項目として強調

**メリット**:
- ✅ 設計意図と一致
- ✅ データ登録が容易
- ✅ 循環依存が解消

**デメリット**:
- ❌ 既存データの migration が必要
- ❌ UI の変更が大きい

**実装工数**: 中（2-3日）

---

### Option B: 現状のまま運用ルールを明確化

**変更内容**:

1. **ドキュメント整備**:
   - マスタ登録の順序を明記
   - 「商品構成マスタ」→「メーカー品番マスタ」→「得意先品番マスタ」

2. **UI ガイド追加**:
   - マスタ管理ページにステップバイステップのガイドを表示
   - 初回利用時にチュートリアルを表示

3. **データ検証強化**:
   - 未マッピングアラートの改善
   - データ整合性チェックの自動化

**メリット**:
- ✅ 実装工数が少ない
- ✅ 既存データへの影響なし

**デメリット**:
- ❌ 設計意図と乖離したまま
- ❌ ユーザー体験が悪い
- ❌ 根本的な解決にならない

**実装工数**: 小（1日）

---

### Option C: データモデルを抜本的に見直す（Phase 3 相当）

**変更内容**:

1. **`supplier_items` を完全な主役に**:
   - `product_id` を削除または完全に任意化
   - `maker_part_no` を主キーに

2. **`products` の役割を再定義**:
   - グループ化専用テーブルに
   - `product_supplier_mappings` テーブルで紐付け

3. **データマイグレーション**:
   - 既存データを新スキーマに変換
   - 不正確なデータをクリーンアップ

**メリット**:
- ✅ 設計が明確
- ✅ 長期的な保守性が向上

**デメリット**:
- ❌ 実装工数が大きい
- ❌ 既存機能への影響が広範囲
- ❌ データ移行リスク

**実装工数**: 大（1-2週間）

---

## 推奨アクション

### 短期対応（即座に実施）

1. ✅ **画面タイトルの統一** - 完了
2. 🔄 **Excelビューの修正** - バックエンド完了、フロントエンド残
3. 📝 **このドキュメントの作成** - 完了
4. 📋 **運用ルールの暫定ドキュメント作成** - 次のステップ

### 中期対応（1-2週間以内）

1. **Option A の実装**
   - `SupplierProductForm` の `product_id` を任意化
   - `maker_part_no` フィールドを追加
   - バックエンド API のスキーマ修正

2. **データクリーンアップ**
   - `products.maker_part_code` の不正確なデータを修正
   - `customer_items.supplier_item_id` の紐付けを修復

### 長期対応（Phase 3）

1. **Option C の検討**
   - データモデルの抜本的見直し
   - Phase 3 設計への移行計画策定

---

## 関連ドキュメント

- `CLAUDE.md` - プロジェクト概要と設計方針
- `docs/project/BACKLOG.md` - タスクバックログ
- 調査レポート: 品番・品目管理の関係性（agentId: ae76a2c）
- 調査レポート: メーカー品番登録経路（agentId: a9644a7）

---

## 変更履歴

| 日付 | 変更内容 | 担当 |
|:---|:---|:---|
| 2026-01-27 | 初版作成 | Claude (Sonnet 4.5) |
| 2026-01-27 | 画面タイトル統一完了 | Claude (Sonnet 4.5) |
| 2026-01-27 | Excelビュー修正（Backend） | Claude (Sonnet 4.5) |
