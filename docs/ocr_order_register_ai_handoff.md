# OCR受注登録（中間ステップ）— AIに渡す設計メモ（マスタ＋結果）

> 目的：**現行VBAと同じ列・同じ見た目の「受注情報登録_yyyymmddhhMMss.xlsx」**を生成しつつ、Reactでも同内容を一覧表示できる状態にする。  
> 前提：ヘッダ揺れなし／AI-OCR→CSV→DB保存は完了済み／祝日カレンダーは既に実装済み。  
> 注意：**DNは今は忘れる**（OCR系列のみ）。DBテーブル名・列名は後で“プロジェクトを見れるAI”が確定させるため、ここでは「業務要件・ヘッダ・キー方針」を中心にまとめる。

---

## 1. 用語・要点

### 1.1 「材質×次区だけで足りない」とは
マスタ（出荷ルール/変換ルール）を引くキーが **材質コード × 次区（=出荷先区分）** だけだと、同じ組み合わせで複数行ヒットして **一意に決まらない**可能性がある、という意味。

今回の方針（ユーザー整理）：
- **次区は出荷先（出荷先区分）であり、複数行にならないように管理していたはず**
- 実態としては **得意先コードも絡む**
- 倉庫キー（出荷倉庫）も候補だが、以下の優先順位で扱う

#### キー方針（案）
1) **基本キー（原則一意）**：`得意先コード × 材質コード × 次区(jiku_code)`  
2) それでも重複するなら：`+ 出荷倉庫（倉庫キー）` を追加  
3) それでも重複するなら：**マスタ異常としてアラート**（運用で潰す）

> フィールド名：**次区は業務用語なので jiku_code 等でDB/DTO側も合わせる**（重要）。

---

## 2. UI配置（暫定）

### 2.1 グローバルナビ
- **受注管理の右にメニュー追加**
- 新規ページ：**OCR結果**（OCRの縦持ちデータ＋マスタ参照＋結果表示/Excel出力）

### 2.2 マスタ画面
- 既存の **マスタページ内に配置**
- 要件：**誰でも編集可能**
  - Web上で編集
  - Excelで更新（アップロード/差分反映/置換など、運用は後で確定）

---

## 3. 必要テーブル（最小構成）

> 実テーブル名は後でプロジェクトに合わせて変更可。ここでは責務だけ固定。

### 3.1 マスタ：Raw と Curated
- **master_raw**（監査・完全再現）
  - Excel「マスタ」シートの列を**そのまま**取り込み（順序と値を維持）
- **master_curated**（アプリ参照用：整形済み）
  - `得意先コード × 材質コード × 次区(jiku_code)` をキーとして、アプリが必要な値を保証
  - 重複は上の「キー方針」に従い、必要なら倉庫キー拡張 or アラート

### 3.2 結果（受注情報登録）：結果テーブル
- **order_register_rows**
  - OCR DTO（縦持ち）から復元した値＋マスタ参照結果＋手入力（ロット）を保持
  - Excel出力・React表示の**単一ソース**にする（ビューでも可）

---

## 4. ヘッダ一覧（順序固定）

### 4.1 マスタExcel（現行と同じ：A→T）
1. 得意先コード
2. 材質コード
3. 素材納品書記載製品名
4. 先方品番
5. メーカー品番
6. 発注
7. メーカー
8. メーカー名
9. 仕入先コード
10. 担当者名
11. 次区（= jiku_code）
12. 納入先略称
13. 納入先コード
14. 納入先
15. 倉庫コード
16. 出荷倉庫
17. 出荷票テキスト
18. 輸送LT(営業日)
19. 発注の有無
20. 備考

### 4.2 出力「受注情報登録」Excel（A→X）
> 注：**出荷票テキスト**が正しい表記（「出荷表テキスト」は表記揺れとして統一する）

1. LotNo-1
2. 数量-1
3. LotNo-2
4. 数量-2
5. 入庫No
6. 出荷日
7. 出荷票テキスト
8. 取得元
9. 材質コード
10. 次区
11. 納期
12. 納入量
13. アイテムNo
14. 先方品番
15. メーカー品番
16. 数量単位
17. 得意先
18. 仕入先
19. 仕入先名称
20. 出荷倉庫
21. 出荷倉庫名称
22. 納入場所
23. 納入場所名称
24. 備考

---

## 5. 列の由来（分類表）

### 5.1 マスタ列（Raw）分類
| 区分 | 列 | 用途 | 扱い |
|---|---|---|---|
| キー候補 | 得意先コード / 材質コード / 次区(jiku_code) | 変換ルール特定 | 原則一意（重複アラート方針） |
| 追加キー候補 | 出荷倉庫 / 倉庫コード | 重複解消・倉庫決定 | 必要ならキー拡張 |
| 製品情報 | 素材納品書記載製品名 / 先方品番 / メーカー品番 | OCR補完・照合 | OCR不足時の補完 |
| 取引先 | メーカー / メーカー名 / 仕入先コード / 担当者名 | 表示・発注判断 | 表示・出力に使用 |
| 納入先 | 納入先略称 / 納入先コード / 納入先 | 表示・出荷先情報 | 出力列に反映 |
| 文言/ルール | 出荷票テキスト / 輸送LT(営業日) / 発注の有無 / 備考 | 出荷票・日付計算 | 出荷票テキストは“後で高度化”前提でも保持 |

### 5.2 結果（受注情報登録）列の由来
| 列 | 由来 | 備考 |
|---|---|---|
| LotNo-1 / 数量-1 / LotNo-2 / 数量-2 | 手入力（ロット割当） | いまはそのまま残す（将来自動化余地） |
| 入庫No / アイテムNo / 納期 / 納入量 / 数量単位 | OCR DTO（縦持ちから復元） | OCR側の主データ |
| 材質コード / 先方品番 / メーカー品番 | OCR DTO（不足時マスタ補完） | 「どちらを正」にするかは後で確定 |
| 次区(jiku_code) | マスタ参照 | 業務用語としてフィールド名を合わせる |
| 得意先 / 仕入先 / 仕入先名称 / 出荷倉庫 / 出荷倉庫名称 / 納入場所 / 納入場所名称 | マスタ参照（Curated） | React表示・Excel出力の主役 |
| 取得元 | 定数（現状OCR固定） | DNは現時点で除外 |
| 出荷日 | 生成（祝日カレンダー＋LT等） | 当面は未計算/暫定でもOK（差し替えポイント1箇所） |
| 出荷票テキスト | 生成（当面簡易） | まず「見える・出せる」を優先 |
| 備考 | マスタ/手入力/生成混在 | 最初はマスタ備考を出すでOK |

---

## 6. 出荷票テキスト（後回しのメモ）
- いまは後回しで良い  
- やることは単純：**出荷票テキストのロット部分を「ロット番号(数量)」形式に置き換える**
- 2つロットを割り当てる場合は「/」区切り（だったはず）

---

## 7. AIに渡す JSON（機械可読パック）

```json
{
  "master_headers_A_to_T": [
    "得意先コード",
    "材質コード",
    "素材納品書記載製品名",
    "先方品番",
    "メーカー品番",
    "発注",
    "メーカー",
    "メーカー名",
    "仕入先コード",
    "担当者名",
    "次区",
    "納入先略称",
    "納入先コード",
    "納入先",
    "倉庫コード",
    "出荷倉庫",
    "出荷票テキスト",
    "輸送LT(営業日)",
    "発注の有無",
    "備考"
  ],
  "output_headers_A_to_X": [
    "LotNo-1",
    "数量-1",
    "LotNo-2",
    "数量-2",
    "入庫No",
    "出荷日",
    "出荷票テキスト",
    "取得元",
    "材質コード",
    "次区",
    "納期",
    "納入量",
    "アイテムNo",
    "先方品番",
    "メーカー品番",
    "数量単位",
    "得意先",
    "仕入先",
    "仕入先名称",
    "出荷倉庫",
    "出荷倉庫名称",
    "納入場所",
    "納入場所名称",
    "備考"
  ],
  "naming_note": "次区は業務用語のためDB/DTO側も jiku_code 等のフィールド名で統一する",
  "key_policy_proposal": {
    "primary_key_candidate": [
      "得意先コード",
      "材質コード",
      "次区(jiku_code)"
    ],
    "optional_key_extension": [
      "出荷倉庫(倉庫キー)"
    ],
    "duplicate_policy": "上記でも複数行になる場合はマスタ異常としてアラート"
  },
  "ui_placement": {
    "global_nav": "受注管理の右に『OCR結果』メニューを追加し、新規ページで一覧＋Excel出力",
    "master_page": "マスタページ内で編集（Web編集＋Excel更新）"
  },
  "scope_note": "DNは現時点で除外（OCR系列のみ）"
}
```

---

## 8. 次に“プロジェクトを見れるAI”へ渡す指示（要点）
- OCRのDTO（縦持ち）から、上記「出力列（A→X）」を作るための **必要フィールド一覧**を抽出
- 既存のOCRテーブル/DTOの列名と、このドキュメントの **業務ヘッダ** を突合してマッピング表を作成
- master_raw / master_curated / order_register_rows の **実テーブル定義案（列名・型・制約）** を提示
- キー重複検知（アラート）と、重複時の運用フローを提案