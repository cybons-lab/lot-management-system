= 残課題・TODO
:toc: left
:toc-title: 目次
:sectnums:

**最終更新:** 2025-11-27

== パフォーマンス改善: データベースビューの導入

=== 問題点

現在、`OrderService._populate_additional_info` メソッドでアプリケーション層での JOIN を多用しているため、パフォーマンスが低下している。

* 受注データ取得時に以下を個別にクエリ
** `CustomerItem` → `Supplier` (仕入元取得)
** `Product` (商品コード・商品名・単位情報取得)
** `DeliveryPlace` (納入先名取得)
* データ件数が増えると処理時間が増大

=== 解決策

受注明細の詳細情報を一括取得できるデータベースビューを作成する。

**候補ビュー名**: `v_order_line_details`

**含めるべきフィールド**:
* 受注・受注明細の基本情報
* 顧客名 (`customer_name`)
* 商品コード (`product_code` / `maker_part_code`)
* 商品名 (`product_name`)
* 仕入元名 (`supplier_name`)
* 納入先名 (`delivery_place_name`)
* 単位情報 (`internal_unit`, `external_unit`, `qty_per_internal_unit`)
* 引当情報 (`allocated_quantity`, 引当状況)

**期待効果**:
* 1クエリで必要な全情報を取得可能
* アプリケーション側での JOIN 処理が不要
* レスポンスタイムの大幅改善

== ステータス表示の複合対応

=== 問題点

現在のステータスラベルは単独表示のため、複数のステータスが同時に該当する場合に情報が欠落する。

**例**:
* 引当が完了しているが、在庫が過剰に割り当てられている場合
** 現状: 「引当完了」のみ表示 → 「在庫過多」の情報が失われる

=== 解決策

複数のステータスを同時に表示できるバッジ/タグ形式に変更する。

**実装案**:
[source,tsx]
----
// 現在（単独ラベル）
<Badge variant="success">引当完了</Badge>

// 改善後（複数バッジ）
<div className="flex gap-2">
  <Badge variant="success">引当完了</Badge>
  <Badge variant="warning">在庫過多</Badge>
</div>
----

**優先度を考慮した表示順**:
. エラー系（候補なし、期限切れ）
. 警告系（在庫不足、在庫過多）
. 正常系（引当完了、未引当）

== ロット引当ページ: オーダー集約表示機能

=== 問題点

現在の「ライン単位表示」では、同じ受注に属する複数の明細行が個別のパネルとして表示されるため、受注全体の把握が困難。

**現在の表示イメージ**:
[source,text]
----
[ORDER ORD-00000013 | 明細1: 商品A]
[ORDER ORD-00000013 | 明細2: 商品B]
[ORDER ORD-00000013 | 明細3: 商品C]
----

=== 解決策

オプションスイッチで「オーダー単位表示」に切り替えられるようにする。

**改善後の表示イメージ**:
[source,text]
----
[ORDER ORD-00000013]
  ├ 明細1: 商品A
  ├ 明細2: 商品B
  └ 明細3: 商品C
----

**実装方針**:
* `LineBasedAllocationList.tsx` にトグルスイッチを追加
* state で表示モードを管理 (`viewMode: 'line' | 'order'`)
* `order` モードの場合、受注IDでグループ化して表示
* 現在の `AllocationRowContainer` を再利用し、親コンテナで階層構造を実現

== 受注管理ページ: 明細単位表示への変更

=== 問題点

現在の受注管理ページ (`OrdersListPage`) は受注単位で表示されているため、明細レベルの情報（商品、数量、引当状況など）が見えにくい。

=== 解決策

明細単位（ライン単位）でのリスト表示に変更する。

**変更内容**:
* 受注ヘッダー情報は各行に展開して表示
* フィルタリング・ソート機能を明細レベルで提供
* 引当状況を明細ごとに表示

**UI イメージ**:
[cols="1,1,1,1,1,1,1"]
|===
| 受注番号 | 顧客 | 商品 | 数量 | 納期 | 引当状況 | 操作

| ORD-001 | 顧客A | 商品A | 10 BOX | 2025-12-01 | 引当完了 | 詳細
| ORD-001 | 顧客A | 商品B | 5 PCS | 2025-12-01 | 在庫不足 | 詳細
| ORD-002 | 顧客B | 商品C | 20 KG | 2025-12-05 | 未引当 | 詳細
|===

**実装方針**:
* ロット引当ページの `LineBasedAllocationList` の設計を参考
* 受注管理ページ専用のライン単位コンポーネントを作成
* バックエンドAPIは既存の `OrderWithLinesResponse` を流用可能

== 優先順位

. **高**: パフォーマンス改善（ビュー導入） - システム全体の体感速度に影響
. **中**: ステータス複合表示 - 情報の正確性向上
. **中**: オーダー集約表示 - UX改善
. **低**: 受注管理ページ明細単位化 - 代替手段（引当ページ）が存在

== SAP連携: 在庫トータルチェック ✅ 実装完了

**最終更新**: 2025-11-27 +
**実装コミット**: `75061f6` - feat(admin): SAP在庫トータルチェック機能の追加

=== 要件

**背景**:

* SAPは会社の基幹システムだが、ロット別在庫管理ができない
* 本システムがロット別在庫の主管理システムとなる
* ただし、SAPとの整合性を保つ必要がある

**実装内容**:

* 毎日1回、SAPと在庫総量の緩いチェックを実施
* ロット別の詳細管理は本システムで行う
* トータル在庫数がSAPと一致しているかを確認

=== 実装済み機能

**バックエンド**:

* `SAPMockClient` - SAP APIのモック実装 (`backend/app/external/sap_mock_client.py`)
* `InventorySyncService` - 在庫同期サービス (`backend/app/services/batch/inventory_sync_service.py`)
  ** ローカルDB在庫集計機能
  ** SAP在庫取得機能
  ** 差異検出ロジック（許容差異率1%）
  ** `BusinessRule` テーブルへのアラート記録（`inventory_sync_alert` タイプ）
* バッチジョブフレームワーク統合 (`inventory_sync` ジョブタイプ）
* APIエンドポイント: `POST /admin/batch-jobs/inventory-sync/execute`
  ** 即座に実行（バッチジョブレコード不要）
  ** 実行結果を JSON で返却

**フロントエンド**:

* 管理画面 (`AdminPage`) にSAP在庫チェックボタンを追加
* ワンクリックでSAP在庫トータルチェックを実行
* 実行結果（チェック商品数、差異数、アラート数）を表示
* トーストで成功/警告/エラーを通知

=== 今後の拡張（オプション）

* 定期実行スケジューラーの設定（日次バッチ）
* BusinessRule管理画面での `inventory_sync_alert` 専用フィルター
* 差異詳細レポートのエクスポート機能
* 本番SAP API への置き換え（現在はモック）

**優先度**: 実装完了 ✅

== 入荷予定管理: SAPからの取込フロー


=== 要件

**新しいフロー**:

. SAPの発注情報を引っ張ってくる
. 入荷が決まったら予定日を入力する
. 入荷されたら確定ボタンを押す

=== 現状

`inbound_service.py` (553行) は既存の実装があるが、新しい要件に合わせてリファクタリング・再設計が必要。

=== 対応方針

**待機理由**: 新しい要件の詳細が固まり次第、設計・実装を行う

**必要な設計項目**:

* SAP連携APIの仕様確認
* 発注情報の取込方法（バッチ or API）
* 予定日入力のUIデザイン
* 確定処理のワークフロー
* `inbound_service.py` のリファクタリング方針

**優先度**: 高 - ただし要件確定後に実施

== 更新された優先順位

. **高**: 入荷予定管理（SAP連携） - 要件確定後に実施
. **高**: パフォーマンス改善（ビュー導入） - システム全体の体感速度に影響
. **中**: ステータス複合表示 - 情報の正確性向上
. **中**: オーダー集約表示 - UX改善
. **低**: 受注管理ページ明細単位化 - 代替手段（引当ページ）が存在
. **完了 ✅**: SAP在庫トータルチェック - 実装完了（2025-11-27）



== 関連ファイル

* `backend/app/services/orders/order_service.py` - JOIN処理実装箇所
* `frontend/src/features/allocations/components/shared/LineBasedAllocationList.tsx` - ライン単位表示実装
* `frontend/src/features/orders/pages/OrdersListPage.tsx` - 受注管理ページ
