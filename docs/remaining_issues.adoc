= 残課題・TODO（最終精査版）
:toc: left
:toc-title: 目次
:sectnums:

**最終更新:** 2025-12-04 +
**精査実施:** 2025-11-28 +
**CI/CD:** ✅ 設定完了（バックエンドテストは一時スキップ）

== 精査結果サマリー

=== 完了状況

[cols="1,1,1,1"]
|===
| カテゴリ | 完了 | 残 | 進捗率

| プロジェクト構造改善
| 13
| 0
| ✅ 100%

| 機能実装（主要）
| 12+
| -
| ✅ 完了

| ロット引当UI Phase 1-5
| 5
| 0
| ✅ 100%

| OpenAPI型統一
| 1
| 0
| ✅ 100%（2025-12-04）
|===

=== 残課題カテゴリ

[cols="1,1,1"]
|===
| 優先度 | 項目数 | ステータス

| 🟠 高（機能拡張）
| 2
| 認証依存のため保留

| 🟡 中（品質改善）
| 3
| UIレイアウト総点検から着手

| 🔵 低（将来検討）
| 10
| 監視継続
|===

NOTE: 認証機能はテスト効率を考慮し保留。SAP連携は本番環境準備待ちのため低優先度へ降格（2025-12-04）。

---



=== 2. 担当者ロック表示（排他制御）

**ステータス:** 未実装 +
**ブロッカー:** 認証機能の実装

==== 要件

* 別ユーザーが編集中の場合、OrderCard上部に「🔒 田中太郎さんが編集中」と表示
* 操作をブロックまたは警告

==== 対応タスク

. 編集中ユーザー記録テーブルの作成
. WebSocket または ポーリングによる状態同期
. フロントエンドでのロック表示UI実装

==== 依存関係

* 認証機能が先に必要（ユーザー識別のため）

---

== 🟡 中優先度（機能拡張）

=== 3. SAP連携の本番化

**ステータス:** モック実装済み +
**優先度:** 中（本番運用開始時に対応）

==== 現状

* SAP在庫チェック: ✅ モック実装済み
* SAP受注登録: ✅ モック実装済み
* 本番SAP API接続: ❌ 未実装

==== 対応タスク

. 本番SAP API仕様の確認
. `SAPMockClient` → 本番クライアントへの置き換え
. 認証・接続設定の環境変数化

==== 関連ファイル

* `backend/app/external/sap_mock_client.py`
* `backend/app/services/batch/inventory_sync_service.py`

---

=== 4. 定期バッチジョブのスケジューラ設定

**ステータス:** 手動実行のみ +
**優先度:** 中

==== 現状

* SAP在庫チェック: 手動実行ボタンあり
* 定期実行（日次バッチ）: ❌ 未設定

==== 対応タスク

. APScheduler または Celery Beat の導入
. 日次バッチスケジュールの設定
. 実行ログ・監視の実装

---

=== 5. UIレイアウト（文字数超過）の総点検

**ステータス:** 未着手 +
**優先度:** 中（品質向上）

==== 現状

* ロット一覧の製品名などで、文字数が長い場合にレイアウト崩れが発生していた（修正済み）
* 他の画面（受注一覧、入荷予定一覧など）でも同様の現象が発生する可能性がある

==== 対応タスク

. 各一覧画面での長い文字列の表示確認
. 必要に応じた `max-width` と `truncate` の適用
. ツールチップ (`title` 属性) の付与確認

---

== 🔵 低優先度（将来検討）

=== 5. マイグレーションベースラインの作成

**ステータス:** 未着手 +
**優先度:** 低

==== 要件

* 現在のDBスキーマをベースラインとして `0000_baseline.py` マイグレーションを作成
* 既存のマイグレーション履歴を整理し、新規環境構築時にクリーンな状態から始められるようにする

==== 対応タスク

. 現在のスキーマを `pg_dump --schema-only` でエクスポート（**テーブルのみ**）
. `0000_baseline.py` マイグレーションファイルを作成
. 既存マイグレーションファイルをアーカイブ
. `alembic_version` テーブルのリセット手順をドキュメント化

==== 注意事項

* **ビューはテーブルと分離** - ビューは `backend/sql/views/create_views.sql` から別途作成
* `pg_dump` でビューもテーブルとして扱われる可能性があるため、出力を確認すること

---

=== 6. 設計書の整備・拡充

**ステータス:** ドラフト作成済み +
**優先度:** 低

==== 現状

* `docs/system_overview.md` - システム概要設計書（たたき台）作成済み
* 各種ドキュメントが散在している状態

==== 対応タスク

. `system_overview.md` の内容を拡充
. 機能一覧（画面・API・バッチ対応表）の作成
. 画面設計書（主要画面のワイヤーフレーム）の作成
. 既存ドキュメントの統合・整理

---

=== 7. 入荷予定手動作成機能

**ステータス:** Coming Soon +
**優先度:** 低（SAP連携が主のため不要の可能性）

==== 現状

* SAP連携（同期）: ✅ 実装済み
* 入庫確定フロー: ✅ 実装済み
* 手動作成: ❌ `InboundPlanCreatePage` は Coming Soon

==== 判断ポイント

* SAPの発注残から確認するため、手動作成は不要の可能性が高い
* 業務要件の再確認が必要

---

=== 8. ForecastDetailCard の肥大化監視

**ステータス:** 監視継続 +
**優先度:** 低

==== 現状

* `frontend/src/features/forecasts/components/ForecastDetailCard/` に26ファイル
* 現在はコロケーションされており管理可能

==== 対応基準

* ファイル数が30を超えた場合に分割検討
* 機能追加で複雑度が増した場合

---

=== 9. Hard Allocation の本格運用

**ステータス:** スキーマ準備済み +
**優先度:** 低（v3.0予定）

==== 現状

* Soft Allocation（推奨）: ✅ 実装済み
* Hard Allocation（確定）: `allocation_type = 'hard'` のみ準備

==== v3.0での対応予定

* 実在庫のロック機能
* 他オーダーからの利用制限

---

=== 10. レガシー AllocationService の削除

**ステータス:** 未着手 +
**優先度:** 低

==== 現状

* `backend/app/services/allocations/core.py` の `AllocationService` クラス
* APIからは使用されていない（孤立コード）
* 新しい引当ロジックは `actions.py` に実装済み

==== 対応タスク

. `AllocationService` の使用箇所がないことを再確認
. `core.py` を削除またはアーカイブ
. 関連する `AllocationRepository` のメソッドも整理

---

== ESLint/コード品質課題（参考）

フロントエンドに以下のESLint違反が残存しています。機能には影響しませんが、将来のリファクタリング対象です。

=== Critical（修正必須）

[cols="1,2,1"]
|===
| ファイル | 問題 | 影響

| `WarehouseSelector.tsx:24`
| `useEffect` が条件付きで呼ばれている
| ランタイムエラーの可能性

| `useDialog.ts:204`
| コールバック内で `useDialog` が呼ばれている
| Rules of Hooks 違反
|===

=== High（推奨修正）

[cols="1,2"]
|===
| 問題 | 件数

| アクセシビリティ（ラベル関連付け）
| 6件

| 関数長さ違反（80行超過）
| 17件

| 複雑度違反
| 15件
|===

---

== 完了済み課題（アーカイブ）

以下の課題は完了済みです。詳細は `completed_issues.adoc` を参照。

=== プロジェクト構造改善

* ✅ Phase 1: view_models統合、db削除、CLAUDE.md更新
* ✅ Phase 2: assignments、forecast、tools統合、health router調査、allocation サービス
* ✅ Phase 3: allocations feature、backups、InboundService、ForecastService

=== 機能実装

* ✅ パフォーマンス改善（v_order_line_detailsビュー導入）
* ✅ ステータス複合表示
* ✅ オーダー集約表示
* ✅ SAP在庫トータルチェック（モック）
* ✅ SAP受注登録（モック）
* ✅ 受注管理ページ明細単位化
* ✅ ロット引当UI改善 Phase 1-5
* ✅ 単位換算システム実装
* ✅ Bulk Import/Upsert API実装（全マスター）
* ✅ CSV/Excelエクスポート機能実装（全マスター）

---

== 次のアクション

=== 即座対応（本番前）

. 認証機能の実装計画策定
. bcryptへの移行

=== 短期（1-2週間）

. 排他制御の設計
. SAP本番API仕様確認

=== 中期（1ヶ月）

. 定期バッチスケジューラ導入
. ESLint Critical修正

---

== 更新履歴

[cols="1,2"]
|===
| 日付 | 内容

| 2025-12-04
| OpenAPI型統一完了（typegen:curl修正、api.d.ts統一、TypeCheckエラー全修正）

| 2025-11-28
| 最終精査版作成、優先度を3段階に整理

| 2025-11-28
| 認証機能の詳細追加

| 2025-11-27
| 初版作成
|===
