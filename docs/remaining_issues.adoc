= 残課題・TODO
:toc: left
:toc-title: 目次
:sectnums:

**最終更新:** 2025-11-27

== パフォーマンス改善: データベースビューの導入 ✅ 実装完了

=== 問題点

現在、`OrderService._populate_additional_info` メソッドでアプリケーション層での JOIN を多用しているため、パフォーマンスが低下している。

* 受注データ取得時に以下を個別にクエリ
** `CustomerItem` → `Supplier` (仕入元取得)
** `Product` (商品コード・商品名・単位情報取得)
** `DeliveryPlace` (納入先名取得)
* データ件数が増えると処理時間が増大

=== 解決策

受注明細の詳細情報を一括取得できるデータベースビューを作成する。

**候補ビュー名**: `v_order_line_details`

**含めるべきフィールド**:
* 受注・受注明細の基本情報
* 顧客名 (`customer_name`)
* 商品コード (`product_code` / `maker_part_code`)
* 商品名 (`product_name`)
* 仕入元名 (`supplier_name`)
* 納入先名 (`delivery_place_name`)
* 単位情報 (`internal_unit`, `external_unit`, `qty_per_internal_unit`)
* 引当情報 (`allocated_quantity`, 引当状況)

**期待効果**:
* 1クエリで必要な全情報を取得可能
* アプリケーション側での JOIN 処理が不要
* レスポンスタイムの大幅改善

== ステータス表示の複合対応 ✅ 実装完了

=== 問題点

現在のステータスラベルは単独表示のため、複数のステータスが同時に該当する場合に情報が欠落する。

**例**:
* 引当が完了しているが、在庫が過剰に割り当てられている場合
** 現状: 「引当完了」のみ表示 → 「在庫過多」の情報が失われる

=== 解決策

複数のステータスを同時に表示できるバッジ/タグ形式に変更する。

**実装案**:
[source,tsx]
----
// 現在（単独ラベル）
<Badge variant="success">引当完了</Badge>

// 改善後（複数バッジ）
<div className="flex gap-2">
  <Badge variant="success">引当完了</Badge>
  <Badge variant="warning">在庫過多</Badge>
</div>
----

**優先度を考慮した表示順**:
. エラー系（候補なし、期限切れ）
. 警告系（在庫不足、在庫過多）
. 正常系（引当完了、未引当）

== ロット引当ページ: オーダー集約表示機能 ✅ 実装完了

=== 問題点

現在の「ライン単位表示」では、同じ受注に属する複数の明細行が個別のパネルとして表示されるため、受注全体の把握が困難。

**現在の表示イメージ**:
[source,text]
----
[ORDER ORD-00000013 | 明細1: 商品A]
[ORDER ORD-00000013 | 明細2: 商品B]
[ORDER ORD-00000013 | 明細3: 商品C]
----

=== 解決策

オプションスイッチで「オーダー単位表示」に切り替えられるようにする。

**改善後の表示イメージ**:
[source,text]
----
[ORDER ORD-00000013]
  ├ 明細1: 商品A
  ├ 明細2: 商品B
  └ 明細3: 商品C
----

**実装方針**:
* `LineBasedAllocationList.tsx` にトグルスイッチを追加
* state で表示モードを管理 (`viewMode: 'line' | 'order'`)
* `order` モードの場合、受注IDでグループ化して表示
* 現在の `AllocationRowContainer` を再利用し、親コンテナで階層構造を実現

== 受注管理ページ: 明細単位表示への変更

=== 問題点

現在の受注管理ページ (`OrdersListPage`) は受注単位で表示されているため、明細レベルの情報（商品、数量、引当状況など）が見えにくい。

=== 解決策

明細単位（ライン単位）でのリスト表示に変更する。

**変更内容**:
* 受注ヘッダー情報は各行に展開して表示
* フィルタリング・ソート機能を明細レベルで提供
* 引当状況を明細ごとに表示

**UI イメージ**:
[cols="1,1,1,1,1,1,1"]
|===
| 受注番号 | 顧客 | 商品 | 数量 | 納期 | 引当状況 | 操作

| ORD-001 | 顧客A | 商品A | 10 BOX | 2025-12-01 | 引当完了 | 詳細
| ORD-001 | 顧客A | 商品B | 5 PCS | 2025-12-01 | 在庫不足 | 詳細
| ORD-002 | 顧客B | 商品C | 20 KG | 2025-12-05 | 未引当 | 詳細
|===

**実装方針**:
* ロット引当ページの `LineBasedAllocationList` の設計を参考
* 受注管理ページ専用のライン単位コンポーネントを作成
* バックエンドAPIは既存の `OrderWithLinesResponse` を流用可能

== 優先順位

. **高**: パフォーマンス改善（ビュー導入） - システム全体の体感速度に影響
. **中**: ステータス複合表示 - 情報の正確性向上
. **中**: オーダー集約表示 - UX改善
. **完了 ✅**: 受注管理ページ明細単位化 - 実装完了（2025-11-28）

== SAP連携: 在庫トータルチェック ✅ 実装完了

**最終更新**: 2025-11-27 +
**実装コミット**: `75061f6` - feat(admin): SAP在庫トータルチェック機能の追加

=== 要件

**背景**:

* SAPは会社の基幹システムだが、ロット別在庫管理ができない
* 本システムがロット別在庫の主管理システムとなる
* ただし、SAPとの整合性を保つ必要がある

**実装内容**:

* 毎日1回、SAPと在庫総量の緩いチェックを実施
* ロット別の詳細管理は本システムで行う
* トータル在庫数がSAPと一致しているかを確認

=== 実装済み機能

**バックエンド**:

* `SAPMockClient` - SAP APIのモック実装 (`backend/app/external/sap_mock_client.py`)
* `InventorySyncService` - 在庫同期サービス (`backend/app/services/batch/inventory_sync_service.py`)
  ** ローカルDB在庫集計機能
  ** SAP在庫取得機能
  ** 差異検出ロジック（許容差異率1%）
  ** `BusinessRule` テーブルへのアラート記録（`inventory_sync_alert` タイプ）
* バッチジョブフレームワーク統合 (`inventory_sync` ジョブタイプ）
* APIエンドポイント: `POST /admin/batch-jobs/inventory-sync/execute`
  ** 即座に実行（バッチジョブレコード不要）
  ** 実行結果を JSON で返却

**フロントエンド**:

* 管理画面 (`AdminPage`) にSAP在庫チェックボタンを追加
* ワンクリックでSAP在庫トータルチェックを実行
* 実行結果（チェック商品数、差異数、アラート数）を表示
* トーストで成功/警告/エラーを通知

=== 今後の拡張（オプション）

* 定期実行スケジューラーの設定（日次バッチ）
* BusinessRule管理画面での `inventory_sync_alert` 専用フィルター
* 差異詳細レポートのエクスポート機能
* 本番SAP API への置き換え（現在はモック）

**優先度**: 実装完了 ✅

== 入荷予定管理: SAPからの取込フロー


=== 要件

**新しいフロー**:

. SAPの発注情報を引っ張ってくる
. 入荷が決まったら予定日を入力する
. 入荷されたら確定ボタンを押す

=== 現状

* **実装済み**:
** SAP連携（同期）モック機能 (`InboundPlansListPage` の同期ボタン)
** 入庫確定フロー (`InboundPlanDetailPage` の入庫確定ボタン)
** 入荷予定日の編集機能 (`InboundPlanDetailPage` の編集ボタン)
* **未実装**:
** 手動作成機能 (`InboundPlanCreatePage` は Coming Soon)

=== 対応方針

**優先度**: 低 - SAPの発注残から確認するため、手動作成機能は不要の可能性が高い。
※ ただし、課題としては念のため残しておく。

**必要なタスク**:
. `InboundPlanCreatePage` の実装（必要に応じて）

== SAP連携: 受注登録（モック） ✅ 実装完了

**最終更新**: 2025-11-28 +
**実装コミット**: `feature/sap-mock-api`

=== 要件

* Forecast詳細画面から、関連する受注をSAPに登録する
* SAP APIのモック実装

=== 実装内容

* **バックエンド**: `POST /api/integration/sap/sales-orders` (Mock)
* **フロントエンド**: `SAPIntegrationSection` からAPIコール、トースト通知

== 更新された優先順位

. **中**: Allocationサービスのリファクタリング - 技術的負債の解消
. **低**: 入荷予定手動作成 - SAP連携が主のため優先度低
. **完了 ✅**: SAP受注登録（モック） - 実装完了（2025-11-28）
. **完了 ✅**: SAP在庫トータルチェック - 実装完了（2025-11-27）
. **完了 ✅**: パフォーマンス改善（ビュー導入） - 実装完了（2025-11-27）
. **完了 ✅**: オーダー集約表示 - 実装完了（2025-11-27）
. **完了 ✅**: ステータス複合表示 - 実装完了（2025-11-27）



== 関連ファイル

* `backend/app/services/orders/order_service.py` - JOIN処理実装箇所
* `frontend/src/features/allocations/components/shared/LineBasedAllocationList.tsx` - ライン単位表示実装
* `frontend/src/features/orders/pages/OrdersListPage.tsx` - 受注管理ページ

== プロジェクト構造改善 (2025-11-27 分析実施)

**最終更新**: 2025-11-27 +
**分析対象**: プロジェクト全体のディレクトリ構造とファイル配置

=== 検出された問題点

プロジェクト構造の包括的分析を実施し、**16件の改善項目**を優先度別に検出。

==== Phase 1: 即座対応（1-2日）【高優先度】

===== 1. view_models.py と views_models.py の重複 🔴

**問題**:
[source,text]
----
backend/app/models/
├── view_models.py (60行) ← LotWithMaster 1つのみ
└── views_models.py (254行) ← 10個以上のビューモデル
----

**影響**: ファイル名が混乱を招く（単数 vs 複数）

**対応**: ✅ 実装完了 (2025-11-27)

* `LotWithMaster` クラスを `views_models.py` に移動
* `view_models.py` ファイルを削除
* `lots_router.py` の import文を `views_models` に変更
* **変更ファイル**:
  ** `backend/app/models/views_models.py` - LotWithMaster追加
  ** `backend/app/api/routes/inventory/lots_router.py` - import修正
  ** `backend/app/models/view_models.py` - 削除

===== 2. app/db/session.py レガシー互換レイヤー 🔴

**問題**: 実装は `app/core/database` から全て re-export するだけの互換レイヤー

**使用箇所**: わずか3ファイルのみ
[source,text]
----
- tests/api/test_inventory_sync_api.py
- tests/api/test_lots.py
- routes/orders/orders_validate_router.py
----

**対応**: ✅ 実装完了 (2025-11-27)

* 3ファイルの import を `app.core.database` に変更
* `app/db/session.py` を削除
* `app/db/__init__.py` を削除
* `app/db/` ディレクトリ全体を削除
* **変更ファイル**:
  ** `backend/tests/api/test_inventory_sync_api.py` - import修正
  ** `backend/tests/api/test_lots.py` - import修正
  ** `backend/app/api/routes/orders/orders_validate_router.py` - import修正
  ** `backend/app/db/` - ディレクトリ削除

===== 3. CLAUDE.md とコードベースの乖離 🔴

**検出された差異**:
[cols="1,1,1,1"]
|===
| 項目 | CLAUDE.md 記載 | 実態 | 状態

| routes/masters | 11 files | 5 files | ❌ 古い
| routes/admin | 9 files | 10 files | ❌ 古い
| routes/integration | 2 files | 存在しない | ❌ 削除済み
| models ファイル数 | 11 files | 14 files | ❌ 古い
|===

**対応**: ✅ 実装完了 (2025-11-27)

* CLAUDE.md を最新の構造で更新
* **更新内容**:
  ** routes/masters: 11 files → 5 files
  ** routes/admin: 9 files → 10 files
  ** routes/integration: 削除（ディレクトリが存在しない）
  ** routes/alerts: 追加
  ** models: 11 files → 13 files（実際のファイル数に修正）
* **変更ファイル**:
  ** `CLAUDE.md` - Directory Structure セクション更新

==== Phase 2: 短期改善（1週間）【中優先度】

===== 4. assignments モジュールの非対称配置 🟡

**問題**: 他のモジュールはディレクトリ配下なのに assignments だけが直下配置

**対応**: ✅ 実装完了 (2025-11-28)

* `routes/assignments/`, `services/assignments/`, `schemas/assignments/` に移動

===== 5. frontend: forecast と forecasts の重複 🟡

**問題**: `forecast/` に1ファイルのみ、`forecasts/` が本体実装

**対応**: ✅ 実装完了 (2025-11-28)

* `ForecastFileUploadCard.tsx` を `forecasts/components/` に移動
* `forecast/` ディレクトリを削除

===== 6. tools/ と backend/tools/ の分散 🟡

**問題**: ツールが2箇所に散在

**対応**: ✅ 実装完了 (2025-11-28)

* backend/tools/ のファイルを tools/ に統合
* schema_consistency_check.py と v2 を統合
* generate-types.py を削除（実装がない）

===== 7. admin router に health 関連が2つ存在 🟡

**問題**: `health_router.py` と `admin_healthcheck_router.py` の重複可能性

**対応**: ✅ 調査完了 (2025-11-28)

* 両ファイルの内容を確認し、異なる目的（K8sプローブ vs 管理画面詳細）であるため**統合不要**と判断

===== 8. allocation サービスの過度な細分化 🟡

**問題**: `services/allocation/` に11ファイル（合計1692行）

**対応**: ✅ 実装完了 (2025-11-28)

* `services/allocations/` (複数形) に移行し、5つの主要モジュールに再編
* `core.py`, `search.py`, `fefo.py`, `actions.py`, `suggestion.py`

==== Phase 3: 中長期改善（2-4週間）【低優先度】

===== 9. allocations feature の複雑さ 🔵

**問題**: `features/allocations/` に83ファイル、`useLotAllocation/` だけで11ファイル

**対応**: ⏳ 未実施

===== 10. backups/ ディレクトリの運用方針 🔵

**対応**: ⏳ 未実施

===== 11. InboundService の責務分離 🔵

**問題**: `backend/app/services/inventory/inbound_service.py` (約550行) に、入荷予定管理(CRUD)と入荷受入処理(Logic)が混在している。特に `receive_inbound_plan` はロット生成などのロジックを含み肥大化の傾向がある。

**対応**: ⏳ 未実施

* 入荷受入ロジックを `InboundReceivingService` (仮) などに分離することを検討

===== 12. ForecastService の責務分離 🔵

**問題**: `backend/app/services/forecasts/forecast_service.py` (約420行) に、通常CRUDと一括インポート処理(`bulk_import`)が混在している。`bulk_import` は履歴管理なども含み複雑。

**対応**: ⏳ 未実施

* インポート処理を `ForecastImportService` (仮) などに分離することを検討

=== 実施ステータス

**Phase 1 完了状況**: ✅ 3/3 完了 (2025-11-27)

* ✅ view_models.py と views_models.py を統合
* ✅ app/db/session.py を削除
* ✅ CLAUDE.md を最新構造で更新

**Phase 2 完了状況**: ✅ 5/5 完了 (2025-11-28)

* ✅ assignments モジュール統合
* ✅ forecast ディレクトリ統合
* ✅ tools ディレクトリ統合
* ✅ health router 調査（対応不要）
* ✅ allocation サービスリファクタリング

**Phase 3 完了状況**: ⏳ 0/4 未実施

**総計**: ✅ 8/12 完了 (66%)
