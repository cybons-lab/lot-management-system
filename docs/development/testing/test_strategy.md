# テスト戦略 (Test Strategy)

## 1. 現状のテスト資産
`backend/tests` 配下に pytest ベースのテストコードが存在する。
- **Unit Tests**: ドメインロジック（`calculator.py` 等）の単体テスト。
- **Integration Tests**: API経由での結合テスト（DB接続あり）。

## 2. 重点テスト領域 (Priority Areas)

ロット管理特有のリスクに対するテストを強化する。

### 2.1. 同時実行制御 (Concurrency) [High]
- **シナリオ**: 同一ロットに対して、ほぼ同時に複数の受注から引当要求が来るケース。
- **期待値**:
    - 在庫数以上の引当（オーバーブッキング）が発生しないこと（Confirmed時）。
    - または、仕様通り Active 予約が作成され、後続処理で適切にハンドリングされること。
- **手法**: スレッド並列実行による負荷テスト。

### 2.2. 境界値テスト [Medium]
- **シナリオ**:
    - 在庫残数ギリギリの引当（残数0になる）。
    - 有効期限当日の引当（期限切れ判定の時分秒境界）。
    - ロック数量と現在在庫が一致する場合の有効在庫計算。

### 2.3. 異常系・整合性 [Medium]
- **シナリオ**:
    - DB接続断などによる途中ロールバック時のデータ整合性。
    - 外部システム（SAP）連携失敗時の状態不整合（Confirmedのまま残る等）。

## 3. テスト観点表 (Test Matrix)

| カテゴリ | ケースID | テスト概要 | 期待結果 |
| :--- | :--- | :--- | :--- |
| **Logic** | L-01 | FEFOソート順序 | 期限切迫順、かつ期限切れは除外される |
| **Logic** | L-02 | 部分引当の可否 | `allow_partial=False` なら不足時は全量却下 |
| **DB** | D-01 | ロット番号重複 | Unique制約エラーが発生する |
| **DB** | D-02 | 在庫のマイナス更新 | Check制約エラーが発生する |
| **API** | A-01 | 存在しないロットID | 404 Not Found |
| **Flow** | F-01 | 入庫→引当→出庫 | 正常に在庫履歴が記録され、最終在庫が合う |
