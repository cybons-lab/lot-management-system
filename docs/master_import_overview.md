# マスタインポート機能 概要ドキュメント

## 1. 背景・目的

本システムでは、ロット管理に必要なマスタ情報（仕入先・得意先・品目およびそれらの関係性）を、既存の SAP / 各担当者が持つロット管理表から効率的かつ安全に取り込む必要がある。

現状の課題:

- SAP 側は Zテーブルを含め数百テーブルが関与しており、テーブル構造をそのまま追従するのは現実的ではない  
- 担当者ごとに管理表の形式が異なり、CSV では列ズレ・ゼロ落ちなどの事故リスクが高い  
- 将来的な再インポート（マスタ再生成）や別環境への反映も想定される  

これらを踏まえ、本ドキュメントでは **マスタインポート機能の方針と概要** を示す。

---

## 2. 方針の要点

### 2.1 データ形式方針

- **ユーザー向けの公式フォーマット：Excel（.xlsx）**
- **開発者・連携向けフォーマット：JSON / YAML**
- **CSV はサポート外（禁止）**
  - 列ズレ・ゼロ落ちの事故が起きやすいため  
  - UI にも選択肢を出さず、アップロードされた場合は即エラー

---

## 3. インポートの考え方（共通パイプライン）

全フォーマット（Excel/JSON/YAML）をまず **中間モデル ImportedRow に変換**し、  
そこから以下の流れでDBに登録する。

1. distinct 抽出  
2. マスタテーブルへ upsert（ここで DB により ID が確定する）  
3. コード → ID マッピングを生成  
4. 関係テーブル（customer_items / supplier_items 等）を一括作成  

SAP の Zテーブル構造には追従せず、**SAP業務キー（コード）だけをマスタに保持**してロット管理に最適な独立構造を保つ。

---

## 4. 管理画面で提供する機能

### 4.1 テーブル初期化（危険操作）

- ロット管理関連マスタのデータを削除して初期化  
- 誤操作防止策  
  - 「理解しました」チェック  
  - `DELETE` と入力させる  
  - 権限は管理者のみ  
  - 実行ログを記録  

### 4.2 マスタインポート

- 入力形式：Excel / JSON / YAML
- フロー：
  1. ファイルアップロード  
  2. バリデーション（Dry Run）  
  3. サマリ確認  
  4. 本番反映（upsert or 再作成モード）  

---

## 5. JSON エクスポートの活用

現行DB → 業務視点の入れ子JSON を生成し、  
以下の目的で使用する：

- ビュー不足の発見（JOINできていない関係の洗い出し）  
- Excelレイアウトの検討  
- 将来のAPI構造の雛形  

例：

```json
[
  {
    "customer": { "code": "C001", "name": "得意先A" },
    "items": [
      {
        "item": { "code": "M001", "name": "製品X" },
        "vendors": [
          { "code": "V001", "name": "AAA商事" }
        ]
      }
    ]
  }
]
```

---

## 6. 将来拡張と設計思想

- JSON を“本来の業務構造モデル”、Excel を“人間が編集可能なビュー”と位置づける  
- 中間モデルを中心に処理統一し、拡張を容易にする  
- 関係が複雑な部分は Excel ではなく JSON/YAML に寄せる  

---

## 7. 運用上の注意点

1. Excelテンプレートは極力シンプルにする  
2. JSON/YAML のパースエラーは即中止  
3. CSVは禁止  
4. 初期化とインポートはログ & 権限制御  
5. JSONエクスポート結果を定期的に確認し、ビューやマスタ構造の改善に役立てる  

---

## 8. まとめ

- Excel（公式）＋ JSON/YAML（開発者向け）  
- CSVは廃止  
- 中間モデル → マスタ upsert → マッピング → 関係構築 の統一パイプライン  
- 入れ子JSONで全体像を可視化しながら設計改善  

