# マスタ一括インポート機能 (Master Import) 概要

## 1. 概要
本機能は、システムの初期構築や大規模なデータ移行、または運用中のマスタメンテナンスにおいて、関連する複数のマスタテーブルデータを単一のファイルから一括でインポートするための機能である。
従来の「テーブルごとのCSVインポート」における順序依存や整合性管理の手間を解消し、構造化されたデータを用いて安全かつ効率的にマスタを登録することを目的とする。

## 2. 背景と課題
- **既存の課題**:
    - テーブルごとに個別のCSVファイルをアップロードする必要がある。
    - 外部キー制約があるため、登録順序（例: Supplier -> Product -> ProductSupplier）を人間が管理しなければならない。
    - 部分的な失敗によりデータ不整合が発生しやすい。
- **解決策**:
    - 関連データを1つの構造化ファイル（JSON/YAML/Excel）にまとめる。
    - システム側で適切な順序で登録処理を行う。
    - トランザクション制御により、整合性を担保する。

## 3. 主な機能

### 3.1 対応フォーマット
- **JSON / YAML (.json, .yaml, .yml)**
    - **推奨フォーマット**。階層構造を持つデータを自然に表現できるため、複雑なリレーション定義に適している。
    - システム間連携や開発者のテストデータ作成にも利用。
- **Excel (.xlsx)**
    - **エンドユーザー向け**。シートごとにデータを分割し、視覚的に管理しやすい形式。
    - CSVの代替として採用（CSVは文字コード問題や型情報の欠落等のため**廃止**）。

### 3.2 データグルーピング
一括インポートでは、業務的な関連性に基づいて以下の2つの大きなグループでデータを扱う。
1.  **仕入系 (Supply Side)**:
    - 仕入先 (Suppliers)
    - 製品 (Products)
    - 仕入先製品マッピング (Product Suppliers)
2.  **得意先系 (Customer Side)**:
    - 得意先 (Customers)
    - 納品先 (Delivery Places)
    - 得意先品目マッピング (Customer Items)

※ 得意先品目マッピングは製品マスタに依存するため、仕入系データの登録後に実施することを推奨。

### 3.3 インポートモード
- **Dry Run (検証モード)**:
    - 実際のDB更新は行わず、パース、バリデーション、登録予定件数の集計のみを行う。
    - エラーの事前検知に使用。
- **Execution (実行モード)**:
    - DBへのコミットを行う。
    - 基本的にAll-or-Nothing（またはグルーピング単位）のトランザクション管理を行う。

## 4. 将来の拡張
- **マスタ初期化機能**:
    - 全マスタデータを削除(TRUNCATE)し、クリーンな状態にする機能（開発・検証環境用）。
- **エクスポート機能**:
    - 現在のDBの状態を、インポート可能な形式（JSON/Excel）でエクスポートし、バックアップや環境移行に利用可能にする。
