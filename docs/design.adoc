= Design Documentation
:toc: left
:toc-title: 目次
:sectnums:

**最終更新**: 2025-11-26

本ドキュメントは、ロット管理システムの概要設計、業務フロー、およびUI/UX改善仕様を統合したものです。

== ロット管理システム 概要設計 (v2.2)

=== 背景・目的

ロット管理システムは、製品や部品をロット(同一条件で製造・出荷された最小単位)ごとに管理し、在庫や履歴を正確に把握するためのシステムです。ロット単位で管理することで在庫管理や工程管理の効率化、余剰在庫の削減が可能となり、品質問題発生時の原因究明や迅速な製品回収(リコール)を容易にします。

=== 業務の前提(方針)

1. **入庫はロット単位で厳密管理**: 入荷時には必ずロット単位で在庫登録を行います。
2. **出庫は現物優先**: システム上の指示よりも現場の実物を優先し、差異は後で調整します。
3. **入荷予定と実ロットの分離**: 予定(`inbound_plans`)と実績(`lots`)はデータ上分離して管理します。
4. **引当予約と出荷実績の分離**: 引当(`allocations`)と出荷実績は分離管理します。
5. **棚卸と差異調整による在庫精度維持**: 定期的な棚卸と`adjustments`による調整で精度を維持します。

=== 業務フロー

==== 入荷業務フロー

[mermaid]
----
flowchart TB
    Start([入荷予定登録])
    Start --> A1[入荷予定ヘッダ作成<br/>inbound_plans]
    A1 --> A2[入荷予定明細登録<br/>inbound_plan_lines]
    A2 --> A3{ロット番号<br/>判明?}
    
    A3 -->|判明| A4[期待ロット作成<br/>expected_lots]
    A3 -->|不明| A5[ロット番号なしで予定登録]
    
    A4 --> A6[入荷待ち]
    A5 --> A6
    
    A6 --> B1([実際の入荷])
    B1 --> B2[納品書確認]
    B2 --> B3[実ロット登録<br/>lots]
    B3 --> B4[在庫数量更新<br/>lots.current_quantity]
    B4 --> B5[在庫履歴記録<br/>stock_history]
    B5 --> B6[入荷予定ステータス更新<br/>inbound_plans.status]
    B6 --> End([入荷完了])
----

==== 受注・引当業務フロー(フォーキャストベース)

[mermaid]
----
flowchart TB
    Start([フォーキャスト登録])
    Start --> F1[フォーキャストヘッダ作成<br/>forecast_headers]
    F1 --> F2[日次フォーキャスト明細登録<br/>forecast_lines]
    F2 --> F3[自動引当推奨生成<br/>allocation_suggestions]
    
    F3 --> A1{引当推奨<br/>承認?}
    A1 -->|承認| A2[引当確定<br/>allocations]
    A1 -->|変更| A3[手動でロット選択]
    A3 --> A2
    
    A2 --> A4[在庫引当数更新<br/>lots.allocated_quantity]
    A4 --> A5[引当履歴記録<br/>stock_history]
    
    A5 --> S1([出荷指示])
    S1 --> S2{出荷方法}
    S2 -->|直送| S3[倉庫から直接出荷]
    S2 -->|経由| S4[自社倉庫経由]
    
    S3 --> S5[実出荷記録<br/>stock_history]
    S4 --> S5
    S5 --> S6[在庫数量減算<br/>lots.current_quantity]
    S6 --> S7[引当数量減算<br/>lots.allocated_quantity]
    S7 --> End([出荷完了])
----

=== テーブル定義 (v2.2)

主要なテーブル定義の概要です。詳細は `schema.adoc` を参照してください。

* **マスタ系**: `customers`, `delivery_places`, `warehouses`, `products`, `suppliers`
* **品番マッピング**: `customer_items`
* **入荷・在庫系**: `inbound_plans`, `lots`, `inventory_items`, `stock_history`, `adjustments`
* **フォーキャスト系**: `forecast_headers`, `forecast_lines`
* **受注・引当系**: `orders`, `order_lines`, `allocations`, `allocation_suggestions`
* **ユーザー・認証系**: `users`, `roles`, `user_roles`
* **運用系**: `batch_jobs`, `operation_logs`, `business_rules`, `system_configs`

== 画面統合・アラート・受注管理改善仕様

=== 全体方針

画面を以下の4レイヤーで整理します：

1. **計画レイヤー**: 需要予測、入荷予定
2. **在庫レイヤー**: 在庫（製品×倉庫）、ロット（明細）
3. **実行レイヤー**: 受注管理、ロット引当
4. **横断レイヤー**: ダッシュボード、レポート

=== 在庫＋ロット統合要件

* **在庫トップ画面**: 製品×倉庫レベルで在庫全体を俯瞰。行展開でロット一覧を表示。
* **在庫アイテム詳細ページ**:
    * タブ構成: サマリ、ロット一覧、入荷予定、需要予測

=== ダッシュボード改修

* **KPIカード**: 総在庫数、総受注数、未引当受注数、引当率
* **アラート一覧**: 重要度（critical/warning/info）付きで表示

=== アラート仕様

* **受注系**: 無予測受注の放置（Critical）
* **在庫・ロット系**: 安全在庫割れ、在庫過多、消費期限アラート
* **予測系**: フォーキャスト未達

=== 受注管理ページの改善

* 受注を「ヘッダー行＋展開される明細行」で表示。
* ヘッダー行で全体の引当率をプログレスバー表示。
* 展開時に明細ごとの引当状況を表示。
