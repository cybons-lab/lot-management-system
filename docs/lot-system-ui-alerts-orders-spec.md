
# 画面統合・アラート・受注管理改善 要件まとめ

ロット管理システム v2 初版からの UI/UX 改善方針と、  
Gemini 等で実装・修正してもらうためのチェックリスト。

---

## 1. 全体方針（レイヤーとページの役割）

### 1-1. レイヤー分け

画面を次の 4 レイヤーで整理する。

- **計画レイヤー**
  - 需要予測
  - 入荷予定（＋将来の発注計画）
- **在庫レイヤー**
  - 在庫（製品×倉庫レベルの集約）
  - ロット（ロット番号単位の明細）
- **実行レイヤー**
  - 受注管理
  - ロット引当
- **横断レイヤー**
  - ダッシュボード（KPI＋アラート＋レポート入口）
  - レポート（週次・月次集計など）

### 1-2. ナビゲーションの整理（案）

- 在庫管理とロット管理は、**機能としては一体**とみなす。
- メニュー例：

  - ダッシュボード  
  - 需要予測  
  - 入荷予定  
  - 在庫　（在庫＋ロットをここに統合）  
  - 受注管理  
  - ロット引当  
  - 設定 / 管理 / マスタ

---

## 2. 在庫＋ロット統合の要件

### 2-1. 在庫トップ画面（現・在庫管理）

**役割**：製品×倉庫レベルで在庫全体を俯瞰する「入口ページ」。

- 既存の上部カードは基本維持：
  - 在庫アイテム数
  - 総在庫数
  - 利用可能在庫数
  - 引当済在庫数
  - 製品種類数
  - 倉庫数
- フィルタ：
  - 製品ID
  - 倉庫ID
  - 将来、在庫状態などの絞り込みを追加できる構造にしておく。

**やってほしい改善**

- 各行（製品×倉庫）から、ロット明細を閲覧できるようにする。
  - 行クリック or 「▼」アイコンで行を展開し、  
    **該当製品×倉庫のロット一覧**をインライン表示。
  - ロット一覧のカラム例：
    - ロット番号
    - 現在在庫
    - 有効期限
    - ステータス（ロック/使用可など）
    - アクション（詳細・ロック切替 など）

---

### 2-2. 在庫アイテム詳細ページ

**役割**：1 製品×1 倉庫に対する情報を集約するハブ。

#### タブ構成（最低限）

1. **サマリ**
   - 総在庫数 / 引当済在庫数 / 利用可能在庫数
   - 計算式表示：  
     `利用可能在庫 = 総在庫数 − 引当済在庫数`
2. **ロット一覧**
   - その製品×倉庫に属するロット一覧を表示
   - ロット単位の操作（ロック・破棄など）はここに集約
3. **入荷予定**
   - 同じ製品（必要なら同じ倉庫/納入先）に紐づく入荷予定一覧
4. **需要予測**
   - 同じ製品（＋得意先/納入先グループ）に紐づく需要予測の要約

※ タブ 3, 4 は最初は簡易実装でもよいが、  
**デザインとしてはタブを用意しておく**。

---

## 3. ダッシュボード改修（アラート＋レポート）

### 3-1. 上部 KPI カード

- 総在庫数
- 総受注数（期間：暫定で「全期間」 or 「今月」）
- 未引当受注数
- 引当率（引当済受注数 / 総受注数）

※ 将来、期間フィルタ（今日/今週/今月）を付けられる設計にする。

### 3-2. アラート一覧（必須）

ダッシュボードのメインコンテンツとして**アラート一覧テーブル**を表示する。

- カラム案：
  - 種別（受注 / 在庫 / ロット / 予測）
  - タイトル（短い一文）
  - 対象（受注番号 / 製品×倉庫 / ロット番号 など）
  - 重要度（critical / warning / info）
  - 発生日時 or 基準日
  - アクション（「詳細を開く」ボタン）

- 行クリック or ボタンで、**対応する詳細ページに遷移**する。

### 3-3. レポート入口

アラート一覧の下または横に、簡易グラフやレポートページへのリンク領域を用意する。

- 例：
  - 日別出荷数量
  - 月別在庫推移
  - 得意先別サービスレベル（引当率）

初版では「グラフ placeholder＋リンク」でもよい。

---

## 4. アラート仕様（必須アラート）

### 4-1. 共通事項

- アラートは以下のカテゴリに分類する：
  - `order`（受注）
  - `inventory`（在庫集約）
  - `lot`（ロット）
  - `forecast`（予測）
- 重要度（severity）：
  - `critical` / `warning` / `info`

> ここでは「どういう条件でアラートとみなすか」の粗い仕様だけ決める。  
> 実際の閾値・ロジックは後で調整可。

---

### 4-2. 受注系

#### A1. 無予測受注の放置（最重要）

- 意味：フォーキャストがない＝看板・突発、なので見逃し厳禁。
- 条件（案）：
  - 対象受注がフォーキャストに紐づかない（例：`forecast_group_id IS NULL`）
  - 受注ステータスが「未処理/未引当」
  - `created_at <= now() - 30分`
- カテゴリ：`order`
- 重要度：`critical`
- 遷移先：該当受注詳細ページ

#### A2. 日別フォーキャストに対する前倒し

- 前提：**前倒し判定は日別フォーキャストのみ**に対して行う。
  - 翌月になると旬→日別にフォーキャストがブレイクダウンされるため。
- 単位：
  - 得意先×納入先×製品×日（`forecast_daily` 想定）
- 条件例：
  - 当日受注累計量 > その日の日別フォーキャスト量 × 120%
- カテゴリ：`forecast`
- 重要度：`warning`
- 遷移先：該当の日別フォーキャストカード or 受注一覧フィルタ済状態

---

### 4-3. 在庫・ロット系

#### B1. 安全在庫割れ

- 前提：製品×倉庫ごとに `safety_stock_qty` を管理。
- 条件例：
  - 利用可能在庫 < safety_stock_qty
- カテゴリ：`inventory`
- 重要度：`warning`〜`critical`（閾値次第）

#### B2. 在庫過多

- 前提：製品×倉庫ごとに `max_stock_qty` または「目標在庫日数」を設定。
- 条件例：
  - 利用可能在庫 > max_stock_qty  
  **または**  
  - 利用可能在庫 ÷ 直近出荷量の日数 > 設定日数
- カテゴリ：`inventory`
- 重要度：`info` or `warning`

#### B3. 消費期限アラート（30/60/90）

- 単位：ロット
- 条件例：
  - `expiry_date - today` の残日数が
    - 90 日以下 → `info`
    - 60 日以下 → `warning`
    - 30 日以下 → `critical`
- カテゴリ：`lot`
- 遷移先：ロット詳細 or ロット一覧（対象ロット）

---

### 4-4. 予測系

#### C1. フォーキャスト未達

- 意味：予測より受注が少なく、計画見直し候補。
- 単位：得意先×納入先×製品×期間（旬 or 月）
- 条件例：
  - 期間終了時点で、実績受注量 < フォーキャスト量 × 70%
- カテゴリ：`forecast`
- 重要度：`info` or `warning`
- 遷移先：該当フォーキャストカード

---

## 5. Alert API の荒い設計

### 5-1. 共通型（フロント／バック）

TypeScript イメージ：

```ts
export type AlertSeverity = 'info' | 'warning' | 'critical';
export type AlertCategory = 'order' | 'inventory' | 'lot' | 'forecast';

export type AlertTarget =
  | { resourceType: 'order'; id: number }
  | { resourceType: 'inventory_item'; id: number }
  | { resourceType: 'lot'; id: number }
  | { resourceType: 'forecast_daily'; id: number };

export interface AlertItem {
  id: string;
  category: AlertCategory;
  type: string;        // 'UNFORECASTED_ORDER_STALE' など
  severity: AlertSeverity;
  title: string;       // 一覧の1行メッセージ
  message: string;     // 詳細説明（任意）
  occurredAt: string;  // ISO8601
  target: AlertTarget; // 遷移先識別用
}
```

バックエンド側では、これに対応する Pydantic モデルを定義して返す。

---

### 5-2. エンドポイント（案）

#### GET `/api/alerts`

- 用途：ダッシュボードのアラート一覧、詳細一覧ページ。
- クエリパラメータ（任意）：
  - `severity`: `critical,warning,info`（カンマ区切り）
  - `category`: `order,inventory,lot,forecast`
  - `limit`: 取得件数（デフォルト 50）
  - `only_open`: true/false（初版は true 固定でよい）

- レスポンス：

```json
{
  "items": [ /* AlertItem[] */ ]
}
```

#### GET `/api/alerts/summary`

- 用途：ダッシュボード上部のアラート件数表示。

- レスポンス例：

```json
{
  "total": 23,
  "bySeverity": {
    "critical": 3,
    "warning": 12,
    "info": 8
  },
  "byCategory": {
    "order": 5,
    "inventory": 7,
    "lot": 6,
    "forecast": 5
  }
}
```

---

### 5-3. サーバ側実装イメージ（非常に粗い）

- `collect_order_alerts()`
- `collect_inventory_alerts()`
- `collect_lot_alerts()`
- `collect_forecast_alerts()`

などの関数で、それぞれ A1〜C1 を計算し `AlertItem` にマッピング。  
初版では DB にアラートテーブルを持たず、**ダッシュボード表示時に都度計算**する。

---

## 6. 需要予測・入荷予定・在庫の横連携要件

キーは **得意先×納入先×製品**（＋日付）で揃える。

### 6-1. 需要予測ページからの動線

各フォーキャストカード（得意先×納入先×製品グループ）に、右側パネルを設ける。

**右側パネルに表示したい情報**

- 現在の在庫（該当製品の総在庫 or 指定倉庫）
- 今後の入荷予定合計
- 対象期間の需要予測合計
- 上記から計算した「予定在庫」  
  `予定在庫 = 在庫 + 入荷予定 − 需要予測`
- 危険水準の場合はバッジ表示（例：`⚠ 在庫不足見込み`）

**パネル内のアクションボタン**

- 「在庫状況を開く」
  - 対象製品×倉庫の在庫詳細ページへ遷移
- 「入荷予定を開く」
  - 入荷予定一覧を該当得意先×納入先×製品でフィルタした状態で表示

---

### 6-2. 入荷予定ページからの動線

各入荷予定行に「関連情報」アクションを追加。

- 「需要予測を開く」
  - 対象の得意先×納入先×製品のフォーキャストカードへ遷移
- 「在庫を開く」
  - 在庫詳細ページの「入荷予定タブ」を開いた状態で遷移

---

### 6-3. 在庫詳細ページのタブと連携

前述の通りタブを持たせる：

1. サマリ
2. ロット一覧
3. 入荷予定
4. 需要予測

- 「入荷予定」タブ：該当製品の入荷予定一覧
- 「需要予測」タブ：該当製品（＋得意先/納入先）に紐づくフォーキャスト要約とグラフ

---

## 7. 受注管理ページの改善要件

### 7-1. 現状

- 受注単位でカードが並び、ステータスや引当状況を確認できるが、
  - 受注ヘッダと明細の関係がやや分かりづらい。
  - 1 画面で「全体の引当率」と「明細ごとの進捗」が見えにくい。

### 7-2. 改善目標

- 受注を「ヘッダー行＋展開される明細行」で表示する。
- ヘッダー行だけで「この受注はどれくらい引き当て済みか」を一目で把握できる。
- 展開すると、製品ごとの明細（数量・引当状況）が確認できる。

### 7-3. 表示形式（仕様）

表示イメージ（ASCII モック）：

```text
デフォルト（閉じた状態）：
┌─────────────────────────────────────────┐
│ ▶ ORD-001 | 得意先A | 2025/11/22 | ████ 50% | ...
└─────────────────────────────────────────┘

クリックで展開：
┌─────────────────────────────────────────┐
│ ▼ ORD-001 | 得意先A | 2025/11/22 | ████ 50% | ...
├─────────────────────────────────────────┤
│   PROD-001 | 製品A | 100個 | ████ 100%    │
│   PROD-002 | 製品B | 50個  | ████ 0%      │
│   PROD-003 | 製品C | 30個  | ████ 50%     │
└─────────────────────────────────────────┘
```

このイメージを満たすように、以下のように構成する。

#### 1) 受注ヘッダー行（閉じた状態）

- 左側：展開/折りたたみアイコン（▶ / ▼）
- 表示項目：
  - 受注番号
  - 得意先コード・得意先名
  - 受注日
  - 明細数
  - **全体の引当率（プログレスバー）**
  - 受注ステータス（pending / allocated / shipped など）
  - アクション（詳細ページへのリンクアイコンなど）

#### 2) 受注明細行（展開時のみ）

- 表示項目：
  - 製品コード・製品名
  - 注文数量
  - 引当数量
  - **明細ごとの引当率（プログレスバー）**
  - 納期（納入希望日など）
  - （将来）得意先・納入先・倉庫などの詳細

- ヘッダー行のすぐ下に「インデント付き」で表示すること。

### 7-4. 受注ページとアラート・他画面との連携

- 無予測受注アラート（A1）から遷移した場合：
  - 対象受注をページ上部 or 展開状態でフォーカスする。
- 受注行からのリンク：
  - 「ロット引当ページ」へのショートカットボタンを設置してもよい（任意）。
  - 将来的には、受注明細から「ロット候補」モーダルを呼び出せる設計を意識。

---

## 8. 実装優先度（提案）

1. **受注管理ページのレイアウト改善（7章）**
2. **アラート仕様 A1/B3 の実装＋ Alert API（4章・5章）**
3. **ダッシュボードにアラート一覧とサマリを表示（3章）**
4. **在庫＋ロット統合（2章：在庫一覧からロット展開＋在庫詳細タブ化）**
5. **需要予測・入荷予定・在庫の横連携（6章）**
6. **その他アラート（A2, B1, B2, C1）とレポート強化**
