= 改善計画書：型定義の同期とドキュメント運用
:toc: left
:toc-title: 目次
:sectnums:

**作成日**: 2025-11-26 +
**作成者**: Antigravity

== 背景と課題

=== 現状の課題

1.  **型定義の不整合（Single Source of Truth の欠如）**
    *   バックエンド（Python/Pydantic）とフロントエンド（TypeScript）で型定義が二重管理されている。
    *   バックエンドの変更（例：フィールド名の変更、追加）がフロントエンドに自動的に反映されず、手動更新が必要となっている。
    *   結果として、実装時に古い型定義を参照してしまい、バグや手戻りが発生している（例：`free_qty` vs `available_quantity`）。

2.  **ドキュメントの陳腐化**
    *   手動で記述された API リファレンス（`api_reference.adoc`）は、実際のコードと乖離しやすい。
    *   「ドキュメントが正」という運用が難しく、実装（コード）が先行してしまう。

3.  **ディレクトリ構造と配置の乖離**
    *   「本来あるべき場所に型がない」といった、ディレクトリ構造のルールが曖昧、あるいは守られていないケースがある。

== 改善目標

1.  **型定義の自動同期**
    *   バックエンドの OpenAPI 定義（`openapi.json`）を正（Source of Truth）とし、フロントエンドの型定義を自動生成する。
    *   手動での型定義メンテナンスを廃止する。

2.  **ドキュメント運用の効率化**
    *   詳細な API 仕様は自動生成される OpenAPI ドキュメント（Swagger UI / Redoc）に任せる。
    *   手動ドキュメントは「アーキテクチャ」「概念」「ユースケース」などの記述に集中する。

== アクションプラン

=== Phase 1: 型定義自動生成の導入（直近）

1.  **OpenAPI スキーマの出力スクリプト作成**
    *   バックエンドの FastAPI アプリケーションから `openapi.json` をファイルとして出力するスクリプトを用意する。

2.  **フロントエンドへの生成ツール導入**
    *   `openapi-typescript` などのツールを導入する。
    *   `npm run generate:types` コマンドで、`openapi.json` から TypeScript 型定義ファイル（例：`src/shared/types/schema.d.ts`）を生成できるようにする。

3.  **試験的な適用**
    *   一部の機能（例：今回修正した `Allocations` 周り）で、自動生成された型定義を使用するようにリファクタリングし、運用の課題を洗い出す。

=== Phase 2: 全体適用とCI/CD連携（中期）

1.  **既存型定義の置き換え**
    *   `src/features/*/api.ts` などで手動定義されている型を、自動生成された型に順次置き換える。
    *   Utility Types（`Pick`, `Omit` 等）を活用し、フロントエンドで必要な形に整形するラッパー層を設けることも検討する。

2.  **CI/CD パイプラインへの組み込み**
    *   バックエンドの変更時に自動で型定義生成コマンドを実行し、差分があれば検知（または自動コミット）する仕組みを構築する。

=== Phase 3: ドキュメントとディレクトリ構造の整理（長期）

1.  **API リファレンスの軽量化**
    *   `docs/api_reference.adoc` から詳細なパラメータ定義などを削除し、OpenAPI ドキュメントへのリンクに置き換える。

2.  **ディレクトリ構造の再定義**
    *   自動生成された型定義の配置場所を明確化する（例：`src/shared/types/openapi`）。
    *   Feature ごとの型定義は、そこからの引用（Re-export）や拡張に留めるルールを徹底する。

== 運用ルール案

*   **バックエンド変更時**: 必ず `openapi.json` の更新と、フロントエンド型定義の再生成を行う。
*   **フロントエンド実装時**: 手動で型を定義せず、生成された型定義（`components["schemas"]["..."]`）を優先して使用する。
*   **ドキュメント**: API の挙動に関する疑問は、まず Swagger UI (`/api/docs`) またはコードを確認し、手動ドキュメントは補助的に利用する。
