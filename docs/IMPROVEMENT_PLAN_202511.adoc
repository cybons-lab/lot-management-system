= 改善計画書：型定義の同期とドキュメント運用
:toc: left
:toc-title: 目次
:sectnums:

**作成日**: 2025-11-26 +
**作成者**: Antigravity

== 背景と課題

=== 現状の課題

1.  **型定義の不整合（Single Source of Truth の欠如）**
    *   バックエンド（Python/Pydantic）とフロントエンド（TypeScript）で型定義が二重管理されている。
    *   バックエンドの変更（例：フィールド名の変更、追加）がフロントエンドに自動的に反映されず、手動更新が必要となっている。
    *   結果として、実装時に古い型定義を参照してしまい、バグや手戻りが発生している（例：`free_qty` vs `available_quantity`）。

2.  **ドキュメントの陳腐化**
    *   手動で記述された API リファレンス（`api_reference.adoc`）は、実際のコードと乖離しやすい。
    *   「ドキュメントが正」という運用が難しく、実装（コード）が先行してしまう。

3.  **ディレクトリ構造と配置の乖離**
    *   「本来あるべき場所に型がない」といった、ディレクトリ構造のルールが曖昧、あるいは守られていないケースがある。

== 改善目標

1.  **型定義の自動同期**
    *   バックエンドの OpenAPI 定義（`openapi.json`）を正（Source of Truth）とし、フロントエンドの型定義を自動生成する。
    *   手動での型定義メンテナンスを廃止する。

2.  **ドキュメント運用の効率化**
    *   詳細な API 仕様は自動生成される OpenAPI ドキュメント（Swagger UI / Redoc）に任せる。
    *   手動ドキュメントは「アーキテクチャ」「概念」「ユースケース」などの記述に集中する。

== アクションプラン

=== Phase 1: 基盤整備と依存管理の刷新（優先度：高）

1.  **Backend: 依存管理のモダン化 (`uv` 導入)**
    *   現状の `requirements.txt` から、高速なパッケージマネージャー `uv` (または `poetry`) へ移行する。
    *   開発依存（`ruff`, `pytest` 等）と本番依存を明確に分離し、`pyproject.toml` で一元管理する。
    *   Python 3.12 向けの最新ライブラリバージョンに更新する。

2.  **Backend: OpenAPI スキーマ出力の自動化**
    *   FastAPI アプリを起動せずに `openapi.json` を静的ファイルとして出力するスクリプト (`scripts/export_openapi.py`) を作成する。
    *   これを CI やフロントエンドの型生成コマンドから参照できるようにする。

3.  **Frontend: 型定義生成フローの確立**
    *   `openapi-typescript` を用いて、バックエンドの `openapi.json` から型定義 (`src/shared/types/openapi.d.ts`) を生成する npm スクリプトを整備する。
    *   生成された型定義が Git 管理対象となるよう `.gitignore` を調整する（開発者間の同期のため）。

4.  **CI/CD: 品質チェックの強化**
    *   GitHub Actions (`quality.yml`) に以下を追加する：
        *   Backend: `ruff format --check`, `ruff check`, `pytest`
        *   Frontend: `tsc` (型チェック), `eslint`, `prettier` (フォーマットチェック)
        *   **型定義同期チェック**: バックエンドのスキーマとフロントエンドの型定義が一致しているか検証。

=== Phase 2: 型定義の同期とリファクタリング（優先度：中）

1.  **Frontend: 生成型への移行（パイロット）**
    *   `features/allocations` を対象に、手動定義された `CandidateLotItem` 等を、自動生成された型 (`components["schemas"]["CandidateLotItem"]`) に置き換える。
    *   必要に応じて、使いやすいエイリアス型（Utility Types）を `src/shared/types/schema.ts` に定義する。

2.  **Frontend: 全体適用**
    *   他の機能（`orders`, `inventory` 等）にも同様の置き換えを展開する。
    *   最終的に `src/features/*/api.ts` 内の手動インターフェース定義を全廃する。

=== Phase 3: コード品質と構成の標準化（優先度：中）

1.  **Frontend: ディレクトリ構造の厳格化**
    *   `features` 間での直接インポートを禁止する Lint ルール（`import/no-restricted-paths`）が正しく機能しているか確認し、違反があれば修正する。
    *   `shared` ディレクトリの責務を明確化し、汎用コンポーネントとドメイン固有コンポーネントを整理する。

2.  **Backend: テスト構成の整備**
    *   `tests` ディレクトリの構造を見直し、単体テストと統合テストを分離する。
    *   テストデータの生成ロジック（`Factory` パターン等）を整備する。

=== Phase 4: ドキュメントと開発フローの定着（優先度：低）

1.  **ドキュメントの軽量化**
    *   `docs/api_reference.adoc` を簡素化し、Swagger UI への誘導を強化する。
    *   開発者向けガイド (`docs/frontend.adoc` 等) に、新しい型定義生成フローと依存管理コマンドの手順を追記する。

2.  **開発フローのドキュメント化**
    *   「バックエンド変更 → 型生成 → フロントエンド修正」という一連の流れを `CONTRIBUTING.md` 等にまとめる。

== 運用ルール案

*   **バックエンド変更時**: 必ず `openapi.json` の更新と、フロントエンド型定義の再生成を行う。
*   **フロントエンド実装時**: 手動で型を定義せず、生成された型定義（`components["schemas"]["..."]`）を優先して使用する。
*   **ドキュメント**: API の挙動に関する疑問は、まず Swagger UI (`/api/docs`) またはコードを確認し、手動ドキュメントは補助的に利用する。
