= ロット引当・推奨機能ドキュメント
:toc: left
:toc-title: 目次
:sectnums:

**最終更新:** 2025-11-25

== 概要

本ドキュメントは、ロット管理システムにおける「ロット引当」および「引当推奨（ソフトアロケーション）」に関する以下の3つの資料を統合したものです:

=== 統合元ドキュメント

. **引当推奨機能（ソフトアロケーション）仕様書 v2.0**
* 元ファイル: `docs/allocations/allocation_suggestion_spec_v2.md`
* 内容: FEFO（先入れ先出し）ロジックによる引当推奨機能の業務仕様

. **Allocation Suggestion Design（最終版）**
* 元ファイル: `docs/allocations/allocation_suggestion_design.md`
* 内容: 引当推奨の技術設計書（`generated_for_month`廃止版）

. **ロット引当ページ UI改善仕様書【統合版】**
* 元ファイル: `docs/lot-allocation-ui-improvement-spec-integrated.md`
* 内容: ロット引当画面のUI/UX改善仕様（Phase 1～5完了）

=== 統合の目的

* ロット引当に関する仕様を1箇所にまとめ、参照性を向上
* 業務仕様・技術設計・UI仕様の関連性を明確化
* ドキュメントの散在を防ぎ、メンテナンス性を向上

== 引当推奨機能（ソフトアロケーション）仕様書 v2.0

=== 概要
本機能は、将来の需要（フォーキャスト）や受注に対して、在庫をどのように割り当てるべきかをシステムが提案（ソフトアロケーション）する機能です。
FEFO（First-Expired, First-Out：先入れ先出し/期限切迫順）ロジックに基づき、賞味期限の近い在庫から優先的に引き当てる案を作成します。

=== 業務フロー

==== フォーキャスト取込時の自動生成
. **フォーキャスト取込**: CSVインポート等でフォーキャストデータが登録されます。
. **自動再計算**: 取込完了後、対象期間（Forecast Period）の引当推奨が自動的に再計算されます。
* 既存の推奨データは削除され、最新の在庫・フォーキャスト状況に基づいて再生成されます。

==== 手動生成（フォーキャスト一覧画面）
. **生成ボタン**: 「フォーキャスト一覧」画面に設置された「引当推奨生成」ボタンを押下します。
. **期間指定**: 現在から向こう3ヶ月分の期間に対して、引当推奨を強制的に再生成します。
* 在庫状況が変化した場合などに、手動で最新化したい場合に使用します。

==== 受注引当時の自動入力（ロット引当画面）
. **画面表示**: 受注に対する「ロット引当」画面を開きます。
. **自動入力**: 画面表示時、未引当の明細に対して、FEFOロジックに基づいた引当数量が**自動的に入力（プレビュー）**されます。
* ユーザーは提案された数量を確認し、必要に応じて修正して「確定」します。
* これにより、「値が埋まっている状態」から作業を開始できます。

=== 引当ロジック (FEFO)
在庫の割り当ては以下の優先順位で行われます：

. **賞味期限 (Expiry Date)**: 期限が近いものから優先。
. **入荷日 (Received Date)**: 期限が同じ場合、入荷が古いものから優先。
. **ロット番号**: 上記が同じ場合、ロット番号順。

※ **ソフトアロケーション**であるため、在庫の物理的な移動や拘束（ハードアロケーション）は行いません。あくまで「推奨案」としてのデータ作成、または画面上のプレビュー表示となります。

=== データモデル

==== `allocation_suggestions` テーブル
システムが生成した推奨データを保持します。

[cols="1,1,1"]
|===
| カラム名 | 型 | 説明

| `id`
| BigInteger
| PK

| `forecast_period`
| String(7)
| 対象期間 (YYYY-MM)

| `customer_id`
| BigInteger
| 得意先ID

| `delivery_place_id`
| BigInteger
| 納入先ID

| `product_id`
| BigInteger
| 製品ID

| `lot_id`
| BigInteger
| 割り当てるロットID

| `quantity`
| Decimal
| 引当数量

| `allocation_type`
| String
| 'soft' (推奨) / 'hard' (確定 - 将来用)

| `source`
| String
| 'forecast_import' 等
|===

=== API仕様

==== 引当推奨生成/プレビュー
`POST /allocation-suggestions/preview`

* **Mode: `forecast`**: 指定期間のフォーキャストに対して推奨データをDBに保存（再生成）。
* **Mode: `order`**: 指定オーダー明細に対して、推奨引当数量を計算して返却（DB保存なし）。

==== 一覧取得
`GET /allocation-suggestions`

* 推奨データの一覧を取得します。期間や製品でフィルタリング可能です。

=== 画面機能詳細

==== フォーキャスト一覧
* **「引当推奨生成」ボタン**:
** 押下すると、当月を含む向こう3ヶ月分の推奨データを再生成します。
** 実行前に確認ダイアログが表示されます。

==== ロット引当画面
* **初期表示時の挙動**:
** 画面ロード完了後、未引当の行に対して自動的にFEFO計算が走ります。
** 計算結果の数量が各ロットの入力欄にセットされます（ドラフト状態）。
** ユーザーはそのまま「保存」するか、数量を変更して保存します。

== Allocation Suggestion Design（最終版）

=== 概要

本ドキュメントは、Lot Management System における **ロット引当候補 (Allocation Suggestion)** の設計を定義する。

* **目的**
** 需要予測 (Forecast) と在庫ロットから、**自動でロット引当候補 (soft allocation)** を生成する。
** 主に **当月 / 翌月の予測**に対して、FEFO で在庫ロットを割り当て、カバー状況 (coverage) と不足 (gaps) を可視化する。
* **スコープ**
** Forecast インポート時に、当月 / 翌月の引当候補を一括生成する。
** 個別オーダー行に対して、DBに保存しない preview 用の引当候補を返す。
* **非スコープ**
** 実在庫をロックする **hard allocation の本格運用**（v3.0 で詳細設計）。
** 画面レイアウトやコンポーネント構造（別 UI 設計書で扱う）。

> **重要:**
> 本設計では **`generated_for_month` という列・概念は使用しない**。
> 今後も追加しない前提とする。

=== 用語

==== Soft Allocation

* 在庫ロットに対して「こう割り当てるのが望ましい」という **候補情報**。
* 実在庫のロックは行わない（在庫数は減らさない）。
* Forecast インポート時などに自動生成され、`allocation_suggestions` テーブルに保存される。
* 複数回の再生成が可能であり、「常に最新の予測と在庫に基づいた案」を提供する。

==== Hard Allocation（将来 v3.0）

* 在庫ロットに対して **数量を確保した状態**。他のオーダーから利用できない。
* 本バージョンでは業務ロジックは扱わず、
** `allocation_type` に `'hard'` を許容して将来拡張できるようにするに留める。

==== Forecast の粒度

* DB では日別の `forecast_date` を持つ。
* 同じ行に集計用の **期間キー** として `forecast_period`（例: `"2025-11"`）を持つ前提。
* Frontend では
** 日別
** 旬 (1–10, 11–20, 21–月末)
** 月合計
+
に集約して表示する。

==== FEFO (First-Expired, First-Out)

* ロット引き当て時の基本ルール。
* 優先順位：
. 消費期限 (`expiration_date`) 昇順
. 入庫日 (`received_date`) 昇順
. さらに必要なら lot_id 昇順などで安定ソート

=== 業務前提と運用

==== 業務前提

* 需要予測は外部システム（例: SAP）から月次で取り込まれる。
* ロット在庫は日々変動するが、**「最新の Forecast × 最新の在庫」から常に計算し直す**スタイルとする。
* 月末時点の状態を固定スナップショットとして取る必要があれば、
** それは別の snapshot 機構で対応し、Allocation Suggestion 側では持たない。

==== 運用方針（generated_for_month 不使用）

* Forecast インポートのたびに、対象期間（当月 / 翌月など）の Allocation Suggestion を **全て再生成** する。
* 再生成の単位は **forecast_period**（例: `"2025-11"`、`"2025-12"`）。
* 「いつの時点で生成したか」は
** `allocation_suggestions.created_at` で必要に応じて追跡する。
** それ以上の「月別バージョン管理」はこのテーブルでは行わない。

=== モードとユースケース

==== モード

. **Forecast モード（バッチ）**
* Forecast インポート時に、
** 指定された `forecast_period` 群（例: 当月 / 翌月）について
** Allocation Suggestion を一括再生成する。
* 結果は `allocation_suggestions` テーブルに保存。

. **Order Preview モード（オンデマンド）**
* 個別オーダー行に対して、
** 当時点の在庫を基に FEFO で候補を計算し、
** DB に保存せず Response として返す。

==== Forecast モード シーケンス

. FE が `POST /forecasts/bulk-import` を呼び出し、当月・翌月などの Forecast を送信。
. Backend が `forecast_current` / `forecast_history` を更新。
. Backend が `AllocationSuggestionService.regenerate_for_periods(forecast_periods)` を呼び出す：
.. 対象 `forecast_periods`（例: `"2025-11"`, `"2025-12"`）の既存 `allocation_suggestions` を削除。
.. 対象期間の Forecast を、key（customer, delivery_place, product, forecast_period）ごとに集計。
.. 在庫ロットを FEFO でソートし、引当候補を生成。
.. 生成された候補を `allocation_suggestions` に一括 INSERT。
.. coverage / gaps を集計し、必要に応じて Forecast API のレスポンスに含める。

==== Order Preview モード シーケンス

. FE が `POST /allocations/suggestions/preview` を呼び出し、`order_line_id` を指定。
. Backend が対象 `order_line` を取得（customer, delivery_place, product, quantity 等）。
. 在庫ロットを FEFO でソートし、必要数量分だけ候補を計算。
. 生成結果を `suggestions` / `stats` / `gaps` として返す（DB には保存しない）。

=== テーブル仕様

==== allocation_suggestions

> 実際の DDL は既存スキーマに合わせて微調整すること。

[source,sql]
----
CREATE TABLE allocation_suggestions (
  id                  BIGSERIAL PRIMARY KEY,

  -- 需要側キー
  order_line_id       BIGINT NULL,        -- Forecastベースの soft allocation では NULL 可
  forecast_period     VARCHAR(7) NOT NULL, -- "YYYY-MM"

  customer_id         BIGINT NOT NULL,
  delivery_place_id   BIGINT NOT NULL,
  product_id          BIGINT NOT NULL,

  -- ロット側キー
  lot_id              BIGINT NOT NULL,
  quantity            NUMERIC(18, 3) NOT NULL,

  -- 種別 / 由来
  allocation_type     VARCHAR(10) NOT NULL, -- 'soft' or 'hard'
  source              VARCHAR(32) NOT NULL, -- 'forecast_import' / 'order_preview' など

  -- 将来の拡張用 (v3.0)
  -- priority_level   INTEGER NULL,         -- 優先ロット用など

  created_at          TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at          TIMESTAMP NOT NULL DEFAULT NOW()
);
----

* **generated_for_month は持たない。**
* Forecast の対象期間は `forecast_period` で識別する。
* 「いつ生成したか」は `created_at` で参照する。

=== API 仕様

==== コンセプト

* Request は「モード + 対象 (scope) + options」で表現する。
* Response は「suggestions + stats + gaps」を返す。

==== Request（論理モデル）

[source,ts]
----
type AllocationScopeMode = "forecast" | "order";

interface AllocationSuggestionRequest {
  mode: AllocationScopeMode;

  // Forecast モード用
  forecast_scope?: {
    forecast_periods: string[];     // ["2025-11", "2025-12"] など
    customer_ids?: number[];
    delivery_place_ids?: number[];
    product_ids?: number[];
  };

  // Order preview 用
  order_scope?: {
    order_line_id: number;
  };

  // options
  options?: {
    allocation_type?: "soft" | "hard"; // 現状は "soft" デフォルト
    fefo?: boolean;                    // true デフォルト
    allow_cross_warehouse?: boolean;   // 倉庫跨ぎ許容フラグ
    ignore_existing_suggestions?: boolean; // Forecast モードで、既存を初期状態として見ない場合 true
  };
}
----

> Forecast インポート API からは、内部でこの Request を組み立てて
> `AllocationSuggestionService` に渡す想定でもよい。

==== Response（論理モデル）

[source,ts]
----
interface AllocationSuggestionResponse {
  suggestions: AllocationSuggestionDto[];
  stats: AllocationStatsSummary;
  gaps: AllocationGap[];
}

interface AllocationSuggestionDto {
  id?: number;        // DBに保存された場合のみ
  order_line_id?: number | null;

  customer_id: number;
  delivery_place_id: number;
  product_id: number;

  forecast_period: string;  // "YYYY-MM"

  lot_id: number;
  quantity: number;

  allocation_type: "soft" | "hard";
  source: "forecast_import" | "order_preview";

  // FE 表示用補助
  lot_number?: string;
  lot_expiration_date?: string | null;
  warehouse_id?: number;
}

interface AllocationStatsSummary {
  per_period: AllocationStatsPerPeriod[]; // forecast_period ごとの集計
  total: AllocationStatsTotal;
}

interface AllocationStatsPerPeriod {
  forecast_period: string; // "YYYY-MM"
  per_key: AllocationStatsPerKey[];
}

interface AllocationStatsPerKey {
  customer_id: number;
  delivery_place_id: number;
  product_id: number;
  forecast_period: string;  // "YYYY-MM"

  forecast_quantity: number;
  allocated_quantity: number;
  shortage_quantity: number; // max(forecast - allocated, 0)
}

interface AllocationStatsTotal {
  forecast_quantity: number;
  allocated_quantity: number;
  shortage_quantity: number;
}

interface AllocationGap {
  customer_id: number;
  delivery_place_id: number;
  product_id: number;
  forecast_period: string;  // "YYYY-MM"

  shortage_quantity: number;
  related_order_line_ids?: number[];
}
----

=== 生成ロジック

==== 入力

* Forecast
** `forecast_current` から対象 `forecast_periods` の行を取得。
** key：
*** `customer_id`
*** `delivery_place_id`
*** `product_id`
*** `forecast_period`
** 日別 (`forecast_date`) は期間ごとに集約する。

* 在庫ロット
** `product_id` ごとに使用可能ロットを取得。
** 必要に応じて `warehouse_id` などでフィルタ。

==== FEFO 割り当て

. key ごとの必要数量 `needed` を算出。
. 在庫ロット候補を取得し FEFO ソート。
. 各ロットに対して：
** `alloc = min(needed, available_for_soft)` を計算。
** `needed -= alloc`。
** `alloc > 0` の場合、`allocation_suggestions` 用の1行として保持。
. `needed > 0` が残れば、それが不足量として `shortage_quantity` になる。

==== 保存・再生成

* **Forecast モード**
** 対象 `forecast_periods` の既存 `allocation_suggestions` を削除。
** 新しく計算した候補を一括 INSERT。

* **Order Preview モード**
** 計算結果は保存せず、Response の `suggestions` として返す。

==== stats / gaps の算出

* key（customer, delivery_place, product, forecast_period）ごとに：
** `forecast_quantity`：Forecast の合計
** `allocated_quantity`：suggestions の合計
** `shortage_quantity = max(forecast_quantity - allocated_quantity, 0)`
* 不足がある key のみを `gaps` として保持。

=== 例外ケースと拡張

==== 緊急オーダー

* Forecast に存在しないが、Order として入ってきた需要。
* Order Preview モードで処理：
** Forecast の有無に関係なく、在庫ロットに対して FEFO で割り当て候補を計算。
** stats では `forecast_quantity = 0` の key として扱う。

==== 在庫不足（全く割り当てられない）

* 使用可能なロットを全て割り当てても `needed > 0` の場合：
** `suggestions` は 0件のこともある。
** `shortage_quantity` は必ず > 0 となり、`gaps` に記録される。

==== 優先ロット（v3.0）

* 将来的に、特定ロットを「優先して割り当てたい」要望に対応する。
* 拡張方針：
** `allocation_suggestions` に `priority_level` などの列を追加。
** FEFO ソートの前に「優先ソート」を挟むだけで導入できる設計とする。
* 本バージョンでは列は追加せず、設計上の拡張ポイントとしてのみ記載。

=== 参考：開発用サンプルデータ（任意）

> この章は実装・テストのための参考であり、業務仕様そのものではない。

* 当月・翌月それぞれについて：
** 複数の key（customer × delivery_place × product）で Forecast を持つ。
** 一部の key では在庫が足りず `gaps` が発生するように調整する。
** 在庫ロットは複数の消費期限・入庫日を混在させ、FEFO の挙動が目視確認できるようにする。
* 具体的な値や seed スクリプトは、実装フェーズの責務とする。

== ロット引当ページ UI改善仕様書【統合版】

=== ドキュメント概要

本書は以下3つの資料を統合した、包括的なUI改善仕様書です:
. ロット引当ページの基本改善要件
. フロントエンド技術的修正ポイント
. より広範なUI課題(OrderCard、異常系表示、構造改善)

=== 前提条件

==== バックエンド側
* `npm run typegen` は実行済み
* `v_lot_details` ビューが作成済み(以下のフィールドを持つ):
** `lot_id`, `lot_number`, `warehouse_id`, `warehouse_name`
** `available_qty`, `receipt_date`, `expiry_date`, `lot_status`
* ビュー名変更: `lot_current_stock` → `v_lot_current_stock`

==== フロントエンド側
* TypeScript型定義が最新化されている想定
* `VLotDetails`, `VLotCurrentStock` 型が利用可能

=== 改善対象の範囲

本仕様書は以下の3つのエリアを対象とします:

==== 1. **ロット表示部分**(最優先)
* LotRowItem / LotList
* ロット番号、倉庫名、在庫量の表示
* FEFO順位とラベル

==== 2. **OrderCard部分**(優先度高)
* 注文カードの状態表示
* 引当状態のバッジ表示

==== 3. **UI構造全体**(段階的改善)
* カードの階層化
* 区切りと余白の改善

=== 現状の問題点

==== カテゴリ1: ロット表示の問題

===== 1-1. データ表示の欠落
* ❌ **倉庫名が表示されない**: どの倉庫のロットか判別不能
* ❌ **ロット番号が目立たない**: 視認性が低い
* ❌ **「倉庫未設定」と表示される**: 「未登録」「データなし」に変更すべき
* ❌ **Remaining/Totalの意味が不明**: 「残量/ロット総量」のように改善

===== 1-2. FEFO順位の不明確さ
* ❌ **FEFO順位(#1, #2, #3)が見えない**: 優先度が判別不能
* ❌ **自動引当で使用されたロットが分からない**: ハイライトが必要

===== 1-3. 状態ラベルの欠如
* ❌ **ラベルがない**: 自動/手動/過少/過剰などの状態が不明
* ❌ **すべてのロット行が同じ色**: アクティブ/非アクティブの区別不能

==== カテゴリ2: OrderCardの問題

===== 2-1. 状態の判別不能
OrderCardが以下の状態を区別できない:
* 自動引当済み
* 手動引当済み
* 一部不足
* 未引当
* 候補ロットなし

===== 2-2. バッジの不在
以下のバッジが存在しない:
* 「自動引当済み」
* 「手動調整済み」
* 「未引当」
* 「候補ロットなし(重大)」

===== 2-3. 担当者ロック表示がない
* ❌ 別ユーザーが編集中でも分からない
* ❌ 同時編集事故のリスクあり

==== カテゴリ3: 異常系表示の問題

===== 3-1. 過剰・過少・不足の可視化不足
* ❌ 在庫の多い/少ない/不足の違いが不明
* ❌ 明示的なラベルが必要

===== 3-2. 異常系が目立たない
* ❌ 候補なし・不足などの重大な問題が埋もれる
* ❌ 「⚠ 大量異常」レベルの赤帯などが必要

==== カテゴリ4: UI構造の問題

===== 4-1. 階層構造の不明確さ
* ❌ カード全体がフラット
* ❌ OrderCard(上段)とLotList(下段)の段差が必要

===== 4-2. 視覚的区切りの弱さ
* ❌ 枠・区切り・背景色の差が弱い
* ❌ ブロックごとの識別が困難

===== 4-3. 操作エリアの境界が曖昧
* ❌ 半量/全量ボタンがどのロットに属するか不明確

=== 改善後の仕様

==== 【A】ロット表示の改善

===== A-1. ロット行のレイアウト

----
┌──────────────────────────────────────────────────────────┐
│ **LOT: ABC123** (太字・大きめ)        [#1][自動]       │ ← ラベル領域
│ 倉庫: 東倉庫 (text-gray-600)                            │
│ 残量: 100 / 総量: 150 (明確な表記)                      │
│ 入荷: 2025-01-15 | 期限: 2025-12-31                    │
└──────────────────────────────────────────────────────────┘
※ アクティブな行のみ背景色を濃くする(bg-blue-50など)
----

===== A-2. 表示要素の詳細

[cols="1,1,1,1"]
|===
| 要素 | 位置 | スタイル | データソース

| **ロット番号**
| 行の上部左
| 太字・大きめフォント
| `lot_number`

| **倉庫名**
| ロット番号の下
| `text-gray-600`
| `warehouse_name`

| **在庫量**
| 中段
| 「残量 XX / 総量 XX」
| `available_qty`

| **日付情報**
| 下段
| 小さめ・グレー
| `receipt_date`, `expiry_date`

| **ラベル領域**
| 右端
| Badge群
| 後述
|===

===== A-3. ラベルの種類と条件

====== ① FEFO順位ラベル
[cols="1,1,1"]
|===
| ラベル | 条件 | スタイル

| `#1`
| FEFO最優先
| `bg-blue-600 text-white`

| `#2`
| 2番目
| `bg-blue-400 text-white`

| `#3`
| 3番目
| `bg-blue-300 text-white`
|===

====== ② 状態ラベル
[cols="1,1,1"]
|===
| ラベル | 条件 | スタイル

| `自動引当`
| 自動割当済み
| `bg-green-100 text-green-800`

| `手動引当`
| ユーザー選択
| `bg-blue-100 text-blue-800`

| `過少`
| available_qty < 必要量
| `bg-yellow-100 text-yellow-800`

| `過剰`
| available_qty > 閾値
| `bg-orange-100 text-orange-800`

| `ロック中`
| 編集不可
| `bg-gray-200 text-gray-600`
|===

====== ③ 倉庫表示の改善
[cols="1,1"]
|===
| 表示前 | 表示後

| `倉庫未設定`
| `未登録` または `データなし`
|===

====== ④ 数量表示の改善
[cols="1,1"]
|===
| 表示前 | 表示後

| `Remaining: 100 / Total: 150`
| `残量: 100 / 総量: 150`
|===

===== A-4. 背景色の制御

[cols="1,1"]
|===
| 状態 | 背景色

| **アクティブ**(引当中)
| `bg-blue-50` または `bg-gray-100`

| **非アクティブ**
| `bg-white`

| **ホバー時**
| `hover:bg-gray-50`
|===

==== 【B】OrderCardの改善

===== B-1. 状態別の色分け

[cols="1,1,1"]
|===
| 状態 | カード背景色 | ボーダー

| 自動引当済み
| `bg-green-50`
| `border-green-300`

| 手動引当済み
| `bg-blue-50`
| `border-blue-300`

| 一部不足
| `bg-yellow-50`
| `border-yellow-300`

| 未引当
| `bg-gray-50`
| `border-gray-300`

| 候補ロットなし
| `bg-red-50`
| `border-red-300`
|===

===== B-2. バッジの追加

OrderCard右上に状態バッジを配置:
* `自動引当済み`: green badge
* `手動調整済み`: blue badge
* `未引当`: gray badge
* `候補ロットなし`: red badge + 警告アイコン

===== B-3. 担当者ロック表示

編集中の場合、OrderCard上部に以下を表示:
----
┌──────────────────────────────────────────┐
│ 🔒 田中太郎さんが編集中 (2分前〜)        │
└──────────────────────────────────────────┘
----

スタイル: `bg-yellow-100 border-yellow-300 text-yellow-800`

==== 【C】異常系表示の強化

===== C-1. 重大な異常の目立たせ方

候補ロットなし・大量不足などの場合:
----
┌────────────────────────────────────────────────┐
│ ⚠ 警告: 候補ロットが見つかりません              │
│ この注文に割り当て可能なロットがありません      │
└────────────────────────────────────────────────┘
----

スタイル: `bg-red-100 border-red-500 text-red-900 font-bold`

===== C-2. 過剰・過少の視覚化

[cols="1,1,1"]
|===
| 状態 | 表示 | スタイル

| 過剰在庫
| 「⚠ 在庫過剰」バッジ
| `bg-orange-100 text-orange-800`

| 過少在庫
| 「⚠ 在庫過少」バッジ
| `bg-yellow-100 text-yellow-800`

| 不足
| 「❌ 在庫不足」バッジ
| `bg-red-100 text-red-800`
|===

==== 【D】UI構造の改善

===== D-1. カードの階層化

----
┌─ OrderCard (上段・濃い背景) ───────────────┐
│ 注文情報・バッジ・ロック表示               │
└────────────────────────────────────────────┘
     ↓ 視覚的な段差・余白
┌─ LotList (下段・薄い背景) ─────────────────┐
│  ├─ LotRowItem #1 (アクティブ)            │
│  ├─ LotRowItem #2 (非アクティブ)          │
│  └─ LotRowItem #3 (非アクティブ)          │
└────────────────────────────────────────────┘
----

===== D-2. 区切りの強化

* OrderCardとLotListの間に `border-t-2` と `my-4` で明確な区切り
* LotRowItem間にも薄い区切り線(`border-b border-gray-200`)

===== D-3. 操作エリアの明確化

半量/全量ボタンを含む操作エリア:
----
┌─ LotRowItem ─────────────────────────────┐
│ ロット情報                                │
│  ┌─ 操作エリア ─────────────────┐       │
│  │ [半量] [全量] [リセット]      │       │
│  └──────────────────────────────┘       │
└──────────────────────────────────────────┘
----

操作エリアに `bg-gray-50 rounded p-2` などで視覚的に分離

==== 【E】単位取扱いの改善

===== E-1. 内部単位と外部単位の併記
* **OrderCard**:
** メイン: 受注単位での数量 (例: `40 KG`)
** サブ: 内部管理単位への換算値 (例: `(= 2 CAN)`) ※単位が異なる場合のみ表示
* **LotList**:
** メイン: 内部管理単位での数量 (例: `5 CAN`)
** サブ: 外部単位への換算値 (例: `(= 100 KG)`) ※換算係数が定義されている場合
* **入力フィールド**:
** 入力は内部管理単位 (例: `CAN`)
** 入力値の下に外部単位への換算値をリアルタイム表示 (例: `1 CAN = 20 KG`)

===== E-2. データ構造
* **Product**:
** `internal_unit`: 内部管理単位 (Allocation Unit)
** `external_unit`: 外部表示単位 (Display/Input Unit)
** `qty_per_internal_unit`: 換算係数 (1 Internal = X External)
* **OrderLine**:
** `converted_quantity`: 内部単位に換算された数量

=== 技術的実装ガイド

==== 1. 型定義の確認

以下の型が生成されていることを確認:
[source,ts]
----
interface VLotDetails {
  lot_id: number;
  lot_number: string;
  warehouse_id: number;
  warehouse_name: string;
  available_qty: number;
  receipt_date: string | null;
  expiry_date: string | null;
  lot_status: string;
}

interface VLotCurrentStock {
  // 同様に確認
}
----

==== 2. API呼び出しの修正

===== 修正対象
* `useLotAllocation` 系フック
* ロット一覧取得API
* 自動引当候補取得API

===== 修正例
[source,ts]
----
// Before
const { data } = useQuery(["lots", id], () => client.lots.get(id));

// After
const { data } = useQuery(["lotDetails", id], () =>
  client.v_lot_details.get(id)
);
----

==== 3. コンポーネント構造の整理

===== 推奨構造
----
LotAllocationPane
 ├─ OrderCard (新規または既存を改修)
 │   ├─ OrderInfo
 │   ├─ StatusBadge
 │   └─ LockIndicator (新規)
 ├─ LotList
 │   └─ LotRowItem (改修)
 │       ├─ LotNumber (新規コンポーネント化)
 │       ├─ WarehouseLabel (新規)
 │       ├─ QtyInfo (改修)
 │       ├─ DateInfo (新規)
 │       └─ LabelGroup (新規)
 │           ├─ FEFOBadge
 │           └─ StatusBadge
 └─ LotDetailPanel
----

==== 4. 共通化の推奨

以下を共通コンポーネント/ユーティリティ化:
----
utils/label.ts         → ラベル生成ロジック
utils/date.ts          → 日付フォーマット
components/lot/
  ├─ LotNumberDisplay.tsx
  ├─ WarehouseBadge.tsx
  ├─ FEFOPriorityBadge.tsx
  └─ LotStatusBadge.tsx
types/lot.ts           → ロット関連型定義
----

==== 5. FEFOソート順の確認

===== ロジック
----
expiry_date ASC → receipt_date ASC → lot_id ASC
----

===== 実装方針
* **推奨**: バックエンドでソート済み → フロントはそのまま表示
* **最終手段**: フロント側で再計算(パフォーマンス注意)

=== 優先順位と段階的実装

==== Phase 1: 緊急対応(最優先)

. ✅ typegen を最新化(完了想定)
. 🔥 **倉庫名の表示**(これがないと他が無意味)
. 🔥 **ロット番号の太字化・視認性向上**
. 🔥 **APIを v_lot_details に統一**

==== Phase 2: 視認性改善(優先度高)

. ラベル領域の追加(FEFO順位・状態)
. アクティブ行の背景色変更
. OrderCardの状態別色分け
. 担当者ロック表示

==== Phase 3: UX向上(段階的)

. 異常系表示の強化(赤帯など)
. UI構造の階層化・区切り改善
. 操作エリアの明確化
. 全体的なスタイル調整

==== Phase 4: 操作性・情報参照の強化(実装済み)

. ✅ **全量ボタンの改善**: ワンクリックで他をクリアして全量確保、計算ロジック修正
. ✅ **一括操作**: チェックボックスによる一括選択・解除・保存
. ✅ **リスト整理**: チェック済み項目の折りたたみと下部移動（アニメーション付き）
. ✅ **ナビゲーション**: 上下ジャンプボタン（TOP/CHK）の追加
. ✅ **情報参照**: 数量入力時のフォーキャスト情報ツールチップ表示
. ✅ **視認性**: クリアボタン、矢印アイコン、ホバー効果の改善

==== Phase 5: 単位取扱いの再構築(実装済み)

. ✅ **DBスキーマ更新**: Product/OrderLineへの単位カラム追加
. ✅ **バックエンドロジック**: 受注時の単位換算、内部単位での引当計算
. ✅ **OrderCard表示**: 受注単位と内部単位の併記
. ✅ **LotList表示**: 内部単位表示と外部単位換算の併記
. ✅ **入力補助**: 入力時のリアルタイム換算表示

=== 実装してほしいこと(AI向け指示)

==== 基本方針
. **Lot Allocation Page全体を探索**し、UIの表示部分を特定
. 必要なファイルを自動で探して修正
. `v_lot_details`のフィールドを正しく表示に反映

==== 作業の進め方
. ✅ まず**影響範囲(修正対象ファイル)を一覧で提示**
. 各ファイルの修正内容を順次実装
. 必要に応じてコンポーネント分割やスタイルファイル追加

==== 注意点
* Phase 1 → Phase 2 → Phase 3 の順序を守る
* 倉庫名表示ができない限り、他の改善は後回し
* 既存のコンポーネント構造を尊重しつつ、必要な箇所のみ修正

=== 期待される改善効果

==== Before → After 比較

[cols="1,1,1"]
|===
| 項目 | Before | After

| **倉庫情報**
| ❌ 表示されない
| ✅ 明確に表示

| **ロット状態**
| ❌ 判別不能
| ✅ ラベルで一目瞭然

| **FEFO順位**
| ❌ 不明
| ✅ #1, #2, #3で明示

| **アクティブ識別**
| ❌ 同じ色
| ✅ 背景色で強調

| **OrderCard状態**
| ❌ 全て同じ
| ✅ 色分け+バッジ

| **編集ロック**
| ❌ 不明
| ❌ 未実装（残課題）

| **異常系**
| ❌ 埋もれる
| ⚠ 一部改善（残課題あり）

| **UI階層**
| ❌ フラット
| ✅ 段差で明確化

| **操作性**
| ❌ 全量ボタン不具合
| ✅ ワンクリック全量、一括操作

| **情報参照**
| ❌ 予測見えない
| ✅ ツールチップで予測表示

| **単位表示**
| ❌ 単位混在で混乱
| ✅ 内部/外部単位を明確に併記
|===

=== 関連ファイル

==== 想定される修正対象
----
frontend/src/features/allocations/
  ├─ LotAllocationPane.tsx        (メイン)
  ├─ LotAllocationPanel.tsx       (パネル)
  ├─ components/
  │   ├─ OrderCard.tsx            (新規または改修)
  │   └─ LotRowItem.tsx           (要改修)
  └─ hooks/
      └─ useLotAllocation.ts      (API呼び出し)

frontend/src/hooks/api/
  └─ useLotsQuery.ts              (存在すれば修正)

frontend/src/api/types/
  └─ generated.ts                 (typegen出力)
----

=== 完了チェックリスト

実装後に以下を確認:

==== Phase 1(必須) - ✅ 完了
* [x] 倉庫名が正しく表示される
* [x] ロット番号が太字で目立つ
* [x] APIが `v_lot_details` を参照している
* [x] TypeScript型エラーがない

==== Phase 2(推奨) - ✅ 完了
* [x] FEFO順位ラベル(#1, #2, #3)が表示される
* [x] 状態ラベル(自動/手動/過少/過剰)が表示される
* [x] アクティブなロットの背景色が濃い
* [x] OrderCardが状態別に色分けされている

==== Phase 3(理想) - ✅ 完了
* [ ] 担当者ロック表示が機能している（未実装）
* [x] 異常系(候補なし等)が赤帯で警告される
* [x] UI階層(OrderCard/LotList)が明確
* [x] 操作エリアが視覚的に分離されている

==== Phase 4(追加改善) - ✅ 完了
* [x] 全量ボタンが正しく動作する
* [x] チェックボックス一括操作ができる
* [x] チェック済み項目が移動する
* [x] フォーキャスト情報が表示される
* [x] ジャンプボタンが機能する
* [x] ステータスフィルタリング機能（完了/不足/過剰/未引当/候補なし）
* [x] 「上へ戻る」ボタンの常時表示

==== Phase 5(単位取扱い) - ✅ 完了
* [x] DBスキーマ(Product, OrderLine)に単位カラムが追加されている
* [x] 受注作成時に数量が内部単位に正しく換算される
* [x] 引当計算が内部単位(converted_quantity)で行われる
* [x] OrderCardに受注単位と内部単位が併記される
* [x] LotListに内部単位と外部単位換算が併記される
* [x] 数量入力時に換算値が表示される

=== 残課題（未実装タスク）

以下の機能はまだ実装されていません。次回の開発サイクルで検討してください。

==== 1. 担当者ロック表示 (排他制御)
* **要件**: 別ユーザーが編集中の場合、OrderCard上部に「🔒 田中太郎さんが編集中」と表示し、操作をブロックまたは警告する。
* **現状**: 排他制御のロジックおよびUIが存在しない。ユーザー認証機能の実装待ち。

==== 2. レスポンシブ対応の最適化
* **要件**: モバイル端末での表示確認と調整。
* **現状**: PCビューを中心に開発しており、モバイルでの検証が不十分。優先度は低。

=== 補足事項

==== スタイルフレームワーク
* Tailwind CSS使用想定
* shadcn/ui の Badge コンポーネント利用可能
* 既存のデザインシステムに準拠

==== レスポンシブ対応
* 既存の実装に準拠
* モバイル表示では一部ラベルを省略する可能性あり

==== アクセシビリティ
* ラベルには適切な `aria-label` を設定
* 色だけに依存せず、アイコンやテキストでも状態を示す
