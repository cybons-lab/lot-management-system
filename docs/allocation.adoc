= ロット引当機能
:toc: left
:toc-title: 目次

**最終更新:** 2025-11-30 +
**ステータス:** ✅ 実装完了（Phase 1-5）

NOTE: 詳細設計・実装コードは `backend/app/services/allocations/` と `frontend/src/features/allocations/` を参照してください。

== 機能概要

* 受注明細に対する在庫ロットの自動引当
* FEFO（First-Expired, First-Out）ロジックによる期限管理
* Soft Allocation（推奨引当）をサポート
* Hard Allocation（確定引当）はスキーマ準備済み（v3.0予定）

== 主要機能

=== 1. 引当推奨（Soft Allocation）

* フォーキャスト取込時の自動生成
* 手動生成（フォーキャスト一覧画面からの実行）
* 受注引当時の自動入力プレビュー

=== 2. FEFOロジック

優先順位:

. **賞味期限（Expiry Date）** - 期限が近いものから優先
. **入荷日（Received Date）** - 期限が同じ場合、入荷が古いものから
. **ロット番号** - 上記が同じ場合、ID順

=== 3. UI機能（Phase 1-5完了）

* ドラッグ&ドロップによる引当操作
* リアルタイム在庫更新
* 自動引当 + 手動調整
* ロット詳細表示（倉庫名、在庫量、FEFO順位）
* 状態別カラーリング（自動/手動/過少/過剰）
* 異常系の明確な表示

== データモデル

=== allocation_suggestions テーブル

[cols=\"1,1,1\"]
|===
| カラム | 型 | 説明

| id | BigInteger | PK
| forecast_period | String(7) | 対象期間（YYYY-MM）
| customer_id | BigInteger | 得意先ID
| delivery_place_id | BigInteger | 納入先ID
| product_id | BigInteger | 製品ID
| lot_id | BigInteger | 割り当てるロットID
| quantity | Decimal | 引当数量
| allocation_type | String | 'soft'（推奨）/ 'hard'（確定）
| source | String | 'forecast_import' 等
|===

== API仕様

=== 引当推奨生成/プレビュー

`POST /allocation-suggestions/preview`

* **Mode: `forecast`** - 指定期間のフォーキャストに対して推奨データをDBに保存
* **Mode: `order`** - 指定オーダー明細に対して推奨引当数量を計算して返却（保存なし）

=== 一覧取得

`GET /allocation-suggestions`

== 参照

* **実装コード**
** Backend: `backend/app/services/allocations/`
** Frontend: `frontend/src/features/allocations/`
* **モデル定義:** `backend/app/models/inventory_models.py:Allocation`
* **API仕様:** `docs/api_reference.adoc`
