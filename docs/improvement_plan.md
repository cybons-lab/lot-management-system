# 改善計画書

## 1. 目的
- バックエンド・フロントエンド・ドキュメント間で分散した責務を整理し、FEFO を中心としたロット管理ドメインの整合性を高める。
- main.py への集中や API/DTO の不一致を解消し、型安全でメンテナブルな構造へ移行する。
- CI/生成物連携を整備し、バックエンド拡張がフロントへ自動で伝播する開発体験を確立する。
- ドキュメントと実装の乖離を減らし、新規メンバーのオンボーディングコストを低減する。

## 2. 前提・制約
- チーム体制：開発者1〜2名、QA 兼任。
- 想定期間：フェーズ1は1ヶ月、フェーズ2は2〜3ヶ月、フェーズ3は余力対応。
- 技術制約：既存 DB データを破壊しないこと、FastAPI/React スタックを維持。
- 運用制約：API プレフィックスや環境変数の互換性を保ち、デプロイ手順を増やさない。

## 3. 改善テーマ一覧
- ルーター/設定の分離：main.py の組み立て専任化で拡張性を向上し、設定の探索性を上げる。期待効果：新規機能追加時の衝突・副作用を抑制。
- ドメインサービス導入：Lot/Inventory の更新・引当をユースケース単位に集約。期待効果：数量整合性とバリデーションの一元化。
- Enum/型安全性強化：文字列比較を排除し共通 Enum を活用。期待効果：バグ混入リスク低減とオートコンプリートの活用。
- API DTO/DB モデル整合：入力/出力/内部スキーマの役割分離。期待効果：不変条件の型表現と破壊的変更の早期検知。
- フロント API レイヤー分割：services/api.ts を機能別フックへ再編。期待効果：責務明確化と TanStack Query 連携の統一。
- 型生成パイプライン整備：OpenAPI → TS 型同期の CI 導入。期待効果：API 変更の追従漏れ防止。
- エラーハンドラモジュール化：共通ハンドラを再利用可能に分割。期待効果：例外処理の一貫性とテスト容易性向上。
- ドキュメント整合：README/STYLE_GUIDE を現構成に合わせ更新。期待効果：オンボーディングと運用手順の明瞭化。
- FEFO/在庫ロジック拡充：ロック・検査状態を考慮した候補生成。期待効果：実運用に近い引当優先順位の担保。
- 環境設定の一本化：prefixUrl 等の重複設定を整理。期待効果：デプロイ時の設定ミス低減。

## 4. フェーズ別ロードマップ
### 4.1 フェーズ1（〜1ヶ月）
- ゴール：main.py の責務縮小、型安全性の底上げ、ドキュメント整合の着手。
- 個別タスク
  - ルーター/設定のモジュール分割（backend/app/main.py, backend/app/api/**）：1日
  - Enum 参照への置換（allocation calculator など backend/app/**）：0.5日
  - services/api.ts から互換ヘルパ分離（frontend/src/services/api.ts, 新規 hooks/**）：1日
  - README/STYLE_GUIDE への構成差分注記追記（docs/README.adoc など）：0.5日
  - API ベース URL 設定テスト追加（frontend/src/**, tests）：0.5日

### 4.2 フェーズ2（〜2〜3ヶ月）
- ゴール：ドメインサービス層導入と DTO 整理、型生成パイプラインの確立。
- 個別タスク
  - Lot/Inventory ユースケースサービス追加と数量バリデーション統合（backend/app/domain/**, services/**）：2日
  - 入力/出力/内部スキーマの分離とマッピングレイヤー整備（backend/app/schemas/**）：2日
  - FEFO 候補生成にロック・検査状態を組み込み（backend/app/allocation/**）：1.5日
  - TanStack Query 用 hooks 分割と API 呼び出し整理（frontend/src/features/**/hooks）：2日
  - OpenAPI→TS 型生成 CI ジョブ追加（tools/scripts, .github/workflows/**）：1日
  - 例外ハンドラのモジュール化（backend/app/exception_handlers/**）：1日

### 4.3 フェーズ3（任意・余裕があれば）
- ゴール：クリーンアーキテクチャ的再配置とイベントドリブンな在庫再計算の検討。
- 個別タスク
  - domain/application/infrastructure/presentation 再配置設計と段階導入（backend/app/**）：3〜5日
  - stock_movements 再計算をドメインイベントで統制する PoC（backend/app/domain/events/**）：3日
  - フロント DTO 層と UI 層の分離、UI テスト拡充（frontend/src/viewmodels/**, tests）：2〜3日

## 5. チケット化の例
1. "main.py のルーター分割" — backend/app/main.py から機能別モジュールへ移動し、起動確認できること。
2. "Enum 参照でのステータス比較統一" — allocation ロジック内の文字列比較が Enum 呼び出しに置換されていることをユニットテストで確認。
3. "services/api.ts 互換ヘルパ分離" — 互換処理が専用ユーティリティへ移動し、ビルドが成功すること。
4. "API ベース URL 設定テスト追加" — `/api` 二重付与がないことを自動テストで担保。
5. "Lot/Inventory ユースケースサービス実装" — 数量更新がサービス経由となり、直接更新箇所がなくなること。
6. "スキーマ入力/出力/内部モデル分離" — Pydantic モデルの責務が整理され、既存エンドポイントの I/O が保持されること。
7. "FEFO 候補生成にロック・検査状態を考慮" — テストケースで優先順位が期待通りとなること。
8. "TanStack Query hooks 分割" — 機能別 hooks が用意され、呼び出し側の重複ロジックが解消されること。
9. "OpenAPI→TS 型生成 CI 追加" — CI で型生成が実行され、差分がない状態でパスすること。
10. "例外ハンドラのモジュール化" — 共通ハンドラがモジュール化され、main.py の登録コードが簡素化されること。

## 6. リスク・注意点
- ルーター分割やスキーマ整理時のエンドポイント互換性破壊に注意。事前に API 契約の回帰テストを準備。
- 在庫数量ロジック変更は既存データへの影響が大きいため、DB バックアップと段階リリースを実施。
- 型生成 CI 導入によりビルド時間が延びる可能性。キャッシュ活用や差分生成で緩和。
- ドキュメント更新が追従しない場合、チーム周知不足による混乱が発生するため、レビュー工程を必須化。

## 7. まとめ
- main.py への集中や型不整合を解消し、ドメインサービスと型生成パイプラインで整合性を高める計画とした。
- フェーズ1で基盤整備とクイックウィンを実施し、フェーズ2でドメイン・DTO・CI を強化、フェーズ3で構造再編を検討する。
- リスクにはエンドポイント互換性とデータ整合性を挙げ、バックアップとテストでの緩和策を明示した。
- ドキュメント整合を並行して進め、オンボーディングや運用の明瞭化を図る。
