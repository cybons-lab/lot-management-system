# 受注非連動ロット対応プラン

## 背景
生産や物流の現場では、確定受注が無い段階でもロット番号を払い出すケース（見込み生産・サンプル・安全在庫など）が存在する。一方で現行システムは、サプライヤ入荷計画に紐づくロット生成を前提としており、サプライヤコードによるバリデーションを強く要求している。

## 現状の観察
- `lots` テーブル自体は注文参照を保持しておらず、`supplier_id` と `expected_lot_id` は NULL を許容している。ただし、ドメインとしては製品・倉庫紐づけや数量・ステータス制約を依然として要求する。【F:backend/app/infrastructure/persistence/models/inventory_models.py†L53-L129】
- 手動ロット作成ではサプライヤコードが必須で、未入力の場合はリクエストを拒否するため、社内組立などサプライヤ不明のケースに対応できない。【F:backend/app/application/services/inventory/lot_service.py†L309-L347】
- 入荷受入が主要なロット生成経路であり、入荷計画番号からロット番号を導出する。すなわち、すべてのロットが（多くの場合注文から作成された）入荷計画に由来する前提となっている。【F:backend/app/application/services/inventory/inbound_receiving_service.py†L37-L180】

## 受注非連動ロットにおけるギャップ
- ロットが存在する理由（見込み生産・サンプル・安全在庫など）を分類する手段がなく、レポートや引当ルール上で注文起点ロットとの差別化ができない。
- スキーマ上は NULL を許容していても、サービス層がサプライヤ必須となっているため、内部生産やプレースホルダロットを作れない。
- ロット番号生成が入荷計画に強く依存しており、アドホックロットに対する一貫した採番経路がない。
- UI/API が入荷受入や受注連動のコンテキストのみを提供しており、専用の「アドホックロット払い出し」フローが存在しない。

## 提案方針
1. **ロット起点メタデータを追加**
   - 新カラム: `origin_type`（enum: `order`, `forecast`, `sample`, `safety_stock`, `adhoc`）と `origin_reference`（任意の文字列。キャンペーンコードやチケットなどの自由入力リンクを想定）。
   - 既存レコードは `origin_type` を `order` で初期化し、`origin_type` が `order` 以外の場合は `supplier` を NULL で許容する。
2. **アドホック文脈でのバリデーション緩和**
   - `LotCreate` 処理を拡張し、`origin_type` が非 `order` の場合は `supplier_code` を省略可能とし、その際 `supplier_id` を `None` に設定する。
   - リクエストに `origin_type` を明示させ、必要に応じて理由・メモを必須化して監査性を確保する。製品・倉庫の必須条件は維持する。
3. **ロット番号生成の入荷計画依存を解消**
   - `origin_type` + 日付 + 連番に基づく採番ユーティリティを追加（例: `SAF-20250304-0001`）。
   - 既存の入荷計画ベースの採番は `order` 起点の場合に維持し、後方互換性を確保する。
4. **アドホックロット払い出し API/フローの公開**
   - REST エンドポイント: `POST /api/lots/adhoc`（もしくは `/api/lots` を `origin_type` と任意の `origin_reference` 付きで拡張）。
   - ロットを作成し、`reference_type="manual_issue"` の在庫履歴を挿入し、入荷計画を要求しないシンプルなサービスを作成する。
   - フロントエンド: 在庫メニュー配下にフォームを追加し、製品・倉庫・単位を指定、`origin_type` を選択し、必要に応じてサプライヤや備考を入力。`origin_type` が `order` のときのみサプライヤ必須とするバリデーションを表示。
5. **引当ルールの意識づけ**
   - FEFO 候補計算時に `origin_type` でフィルタできるようにし、安全在庫やサンプルロットを除外・優先させるなど、業務ルールに応じた選択を可能にする。

## ロールアウト / 移行プラン
- **DDL**: カラムと enum 制約を追加し、既存ロットの `origin_type` を `order` でバックフィル。
- **API/ドメイン**: スキーマとサービスバリデーションを拡張し、フロントエンド更新までは `origin_type` を省略した場合に `order` をデフォルトとする後方互換を維持。
- **フロントエンド**: アドホック作成フォームを実装し、一覧・詳細画面に `origin_type` と `origin_reference` を表示。
- **テスト**: サプライヤなしでの作成、`origin_type` による FEFO フィルタ、アドホックロットの採番をカバーする。
