# 📘 削除ポリシー（Deletion Policy）

## 1. 対象

本ポリシーは以下のデータに適用する：
- マスタ（得意先・仕入先・製品・配送先・マッピング等）
- トランザクション（受注、ロット、入庫・出庫、移動）
- 在庫およびロット履歴データ

---

## 2. 削除方式の原則

データは **4種類の状態** を持つ：

| 削除種別 | 概要 | 対象 | 実装 |
|----------|------|------|------|
| **A. 論理削除（無効化）** | 過去参照を残しつつ今後使わない | マスタの廃番・取引終了 | `valid_to` を今日に設定 |
| **B. 物理削除（完全削除）** | 間違い登録のため完全に消す | マスタのみ（参照がない場合に限る） | `DELETE` 文 |
| **C. 取消（status変更）** | 業務取消・受付ミス | 受注・予約等のビジネストランザクション | `status = cancelled` |
| **D. 逆仕訳（反転トランザクション）** | ロットの入出庫ミス | ロット移動・出庫など在庫影響がある処理 | マイナス取引を生成して整合性を確保 |

---

## 3. マスタデータの削除ルール

マスタは2種類の削除方式を持つ：

### (1) 論理削除（valid_to）

**用途**: 廃番・取引終了など「正しいが今後使わないデータ」

**実装仕様**:
- `valid_to: DATE NOT NULL DEFAULT '9999-12-31'`
- 無効化時は `valid_to = 今日`
- 有効データ検索は `WHERE valid_to >= CURRENT_DATE`

**API 仕様**:
```
DELETE /masters/{id}
→ valid_to を今日に設定する（論理削除）
```

### (2) 物理削除（Permanent Delete）

**用途**: 間違い登録（作成直後のミス）
※運用上は管理者のみ可能

**条件**:
- 他テーブルに参照されていないこと（外部キー制約 or 自前の参照チェックが必須）

**API 仕様**:
```
DELETE /masters/{id}/permanent
→ 完全削除（管理者のみ）
```

---

## 4. トランザクションの削除方式

以下のデータは **削除禁止**。必ず取消または逆仕訳で扱う。

### (1) 受注（Orders）

削除は不可
→ `status = 'cancelled'` を設定することで取消扱いとする

### (2) ロット・在庫移動・出庫

削除不可
→ 必ず **逆仕訳（マイナス移動）** で対応し、在庫整合性を維持する

例:
- 出庫誤り → negative issue を記録
- 入庫誤り → negative receipt を記録

---

## 5. フロントエンド仕様

### 通常ユーザー
- 「削除」ボタン → 論理削除（終了日入力ダイアログ）
- 無効データは一覧上でグレー表示

### 管理者
- 「完全削除」ボタンを追加表示
- 押下時ダイアログで確認テキスト（マスタ名）を入力させる

---

## 6. 必須チェック

### 物理削除前に必ず実施する条件
- 他テーブルに参照がないこと
- 参照がある場合は 400 or 409 エラーで拒否

### 論理削除時の注意
- 過去のロット・受注・出荷履歴で参照されるため絶対に物理削除しないこと

---

## 7. 保持期間

- データ保持の基本方針は **10年間保持**
- マスタの論理削除データも保持対象

---

## 8. 実装タスク一覧

### DB
- [x] `valid_to` カラムの追加
- [x] 外部キー制約 or 参照チェックロジック追加
- [ ] 逆仕訳用テーブル（必要なら）作成

### Backend サービス
- [x] `soft_delete(id)` → `valid_to` を更新
- [x] `hard_delete(id)` → 参照チェック後に DELETE
- [ ] 受注取消API
- [ ] 出庫・入庫の逆処理API

### API Router
- [x] `DELETE /{id}`（論理削除）
- [x] `DELETE /{id}/permanent`（物理削除）
- [x] 管理者権限チェックを組み込む

### Frontend
- [ ] 削除ダイアログ2種類
- [ ] グレーアウト表示
- [ ] 管理者のみ完全削除ボタン表示

---

## 9. 制約遵守

全ての実装はこの削除ポリシーに従って行うこと。
