= バックアップ運用方針
:toc: left
:toclevels: 3
:sectnums:

== 概要

本ドキュメントでは、Lot Management System のデータベースバックアップ運用方針について定義します。
データの保全性を確保しつつ、ディスク容量の圧迫を防ぐための保存期間（リテンションポリシー）を定めます。

== バックアップ戦略

=== バックアップの種類

* **完全バックアップ (Full Dump)**: データベース全体のスキーマとデータをダンプします。
* **ツール**: `pg_dump` (PostgreSQL標準ツール)
* **形式**: カスタム形式 (`-Fc`) または SQL形式 (`.sql`)。現在は可読性と汎用性を重視し SQL形式 (`.sql`) を推奨としますが、容量削減が必要な場合はカスタム形式への移行を検討します。

=== 実行頻度

* **日次**: 毎日深夜（例: 03:00 JST）に実行することを推奨します。
* **タイミング**: バッチ処理や大量データ更新の前後など、運用に合わせて適宜手動実行も可能です。

=== 保存場所

* **ローカル**: プロジェクトルート直下の `backups/` ディレクトリ
* **リモート**: (将来的な検討事項) S3 などのクラウドストレージへの転送を推奨

== 保存期間 (Retention Policy)

ディスク容量の効率的な利用のため、以下のポリシーに従って古いバックアップを削除します。

* **日次バックアップ**: 直近 **7日間** 分を保持
* **週次バックアップ**: 直近 **4週間** 分を保持（毎週日曜日のバックアップを残す）
* **月次バックアップ**: 直近 **6ヶ月** 分を保持（毎月1日のバックアップを残す）

上記期間を超過したバックアップファイルは、自動的に削除対象となります。

== ファイル命名規則

バックアップファイルは以下の命名規則に従います。

`backup_YYYYMMDD_HHMMSS.sql`

* 例: `backup_20251128_153000.sql`

== 運用ツール

`scripts/backup_manager.py` を使用して、バックアップの作成と古いバックアップの削除（クリーンアップ）を行います。

=== バックアップ作成

[source,bash]
----
python scripts/backup_manager.py create
----

=== クリーンアップ実行

[source,bash]
----
python scripts/backup_manager.py cleanup
----

※ `--dry-run` オプションを付けることで、削除対象のファイルを確認のみ行うことができます。

== リストア（復元）手順

データベースの復元が必要な場合は、以下の手順で実施します。

1. **既存データベースのクリア** (必要な場合):
+
[source,bash]
----
dropdb -U <user> <dbname>
createdb -U <user> <dbname>
----

2. **バックアップからの復元**:
+
[source,bash]
----
psql -U <user> -d <dbname> -f backups/backup_YYYYMMDD_HHMMSS.sql
----

== 連絡先

バックアップ運用に関する問い合わせは、システム管理者までお願いします。
