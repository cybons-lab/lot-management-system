# プロジェクトレビュー報告書

## 1. 概要
- ロット在庫・受注・引当を扱う FastAPI バックエンドと React/TypeScript フロントエンドからなるロット管理システム。バックエンドは多量のルーターとドメインロジックを含み、FEFO を前提とした在庫処理やサマリテーブル活用を特徴としている。



- フロントエンドは Vite + Tailwind + shadcn/ui 構成で、共有 HTTP クライアント（ky）と OpenAPI 型を取り込みつつ、受注・ロット・予測向けの API ラッパーを提供している。




## 2. アーキテクチャの評価
- 現状構成  
  - バックエンドは単一 FastAPI アプリに多数のルーターを直結し、ドメインフォルダ（allocation など）と models/schemas 層が混在する、レイヤードだが疎な整理。

  
  - ドメインロジックは一部純粋関数で独立（引当計算など）。


  - フロントは features/ services/ shared などの粒度で API 呼び出し・UI を分割。
- 良い点  
  - FEFO ロジックをドメイン層で純粋関数化しテスト容易性を意識。

  
  - HTTP クライアントが共通化され、エラーハンドリングやリトライ設定を一箇所に集約。


- 課題点  
  - ルーティング・設定・ミドルウェアが main.py に集中し可読性が低下。機能モジュールごとのアプリ分割が不足。

  
  - ドメイン層とアプリケーション層の境界が曖昧で、サービス／リポジトリ的抽象が見当たらない部分が多い。  
  - フロントの services/api.ts が OpenAPI 型とカスタム互換ヘルパを混在させ、整合性が不透明。


- 改善の方向性  
  - ルーターを機能別モジュールで FastAPI sub-application へ分割し、主エントリは組み立てだけにする。  
  - ドメイン・アプリ・インフラ・プレゼンテーションのフォルダ階層を明確化し、サービス層を介したユースケース実装を導入。  
  - フロントは API ラッパーを TanStack Query 用の hook 層に寄せ、OpenAPI 型と UI 用 DTO を分離。

## 3. バックエンドの評価
- モデル・スキーマ整合性  
  - Lot 系 Pydantic スキーマは FEFO 用フィールドと数量を持つが、DB モデル側の単位換算・ロック量などとの整合チェックがコード上で明示されていない（スキーマの allocated/locked は任意更新可能で、サービス層の制約が見えない）。

  
  - main.py に多くのルートを直接登録しており、ルート間依存の順序コメントが存在するなど結合度が高い（例: confirmed_lines_router を orders より前に登録）。


- 型・バリデーション  
  - LotStatus など Enum は定義されるが、計算ロジック側では文字列比較でハードコードされており型一貫性が弱い（calculator は "active" 固定）。


  
  - allocation calculator は locked_quantity や allocated_quantity を考慮せず available_quantity 前提で計算しているため、上位サービスでの整合チェックが必須だが位置が不明。


- ドメインロジックのリスク  
  - FEFO ソートは expiry_date のみ基準で同日優先度や倉庫・ロットロックの扱いが未考慮。  
  - 期限切れ／在庫なし以外のビジネスルール（品質検査、ロック理由など）がロジックに組み込まれておらず、複数箇所に分散する可能性。  
  - 例外ハンドラ登録はあるが、ドメイン例外と HTTP 例外のマッピング整理が main.py 依存で拡張性が限定的。



## 4. フロントエンドの評価
- コンポーネント構造  
  - services/api.ts が多機能 API 呼び出しを単一オブジェクトで管理し、Compat ヘルパを同ファイルに追加しているため責務集中が進行。

  
  - features/ shared/ factories など多層に分かれているが、README の構造と実フォルダ構造が乖離（pages フォルダではなく features/mainRoutes 等が存在）し、学習コスト増。
- 状態管理とデータフロー  
  - TanStack Query 用の hook 抽象が明確でない（services と hooks の責務境界が不透明）ため、API 呼び出しロジックが重複するリスク。  
  - エラーロギングは共通だが、UI での再試行やローディング状態管理の規約が見えず一貫性に課題。
- API 連携と型整合性  
  - OpenAPI 生成型 components を直接 alias しているが、一部互換ヘルパで items を任意配列化するなど、サーバー応答との差異を埋める手続きが散在。

  
  - API ベース URL は `import.meta.env.VITE_API_BASE_URL || "/api"` で決めるが、バックエンドの prefix `/api` と二重にならない保証が README 以外に明示されていない。



## 5. レイヤー間の整合性
- DB ⇄ バックエンド ⇄ フロントの命名・型  
  - LotResponse は backend で `lot_id` エイリアスを提供するが、フロントでは OpenAPI 型をそのまま Lot として使用しており、シリアライズ時の alias とフィールド名の混在が起きやすい。


  
  - FEFO や在庫計算ロジックはバックエンドにのみ存在し、フロント側での表示・フィルタリングは別実装になる可能性が高く、優先順序やステータス判定の差異リスク。  
  - 受注/ロット API が多数あるが、フロントの services/api.ts では一部のみ実装されており、API 契約変更時の追従漏れが懸念。

## 6. コード品質・保守性の評価
- 読みやすさ  
  - main.py にミドルウェア・例外ハンドラ・多数ルーターが直列記述されており、設定を探しづらい。

  
  - allocation calculator は単純で読みやすいが、ビジネスルールが限定的で実環境との乖離をコメント等で示していない。


- テスト容易性  
  - 純粋関数の導入は良いが、スキーマと DB モデルの整合を保証する統合テストの痕跡が見えず、移行時の破壊的変更に弱い。  
- スケーラビリティ  
  - ルーター拡大に伴う main.py のスケール問題、サービス層の不足によるドメイン重複実装のリスク。  
  - フロントの API レイヤーに手続き的互換ヘルパが追加され続けると、呼び出し規約が統一されずメンテが困難。

## 7. 優先度付き改善提案
### 7.1 Top 10 重要な問題
1. main.py に設定・ルーターが集中し拡張性が低い。


2. ロット/在庫スキーマの数量フィールドが自由更新で、整合性検証が不明確。


3. Allocation ロジックがロック量・検査状態を考慮せず、ビジネスルール逸脱リスク。


4. Enum 定義と文字列比較の混在による型安全性欠如。



5. フロント services/api.ts が互換ヘルパを同居させ責務過多。


6. OpenAPI 型とシリアライズ alias の整合性が不透明（lot_id 等）。



7. API カバレッジがフロントで限定され、バックエンド拡張に追従しづらい構造。
8. エラーハンドリングの責務が main.py 依存で再利用性が低い。


9. HTTP クライアント設定が環境変数と既定パスの二重管理で、デプロイ時のミスリード懸念。


10. README の構造記述と実際のフロントフォルダ構成の乖離によるオンボーディング難。



### 7.2 Top 10 改善提案
1. FastAPI を機能別サブアプリ or Router グループに分割し、main.py は組み立てのみとする。
2. Lot/Inventory の数量更新はドメインサービス経由に統一し、スキーマを入力専用に絞って不変項目はレスポンスのみ許容。
3. Allocation 前の候補生成で locked_quantity・inspection_status 等をフィルタするユースケース層を追加。
4. Enum 型をドメインロジックでも厳密使用し、文字列リテラル比較を排除。
5. フロント API レイヤーをファイル分割し、TanStack Query 向けの `useOrdersQuery` 等 hooks に責務を限定。
6. OpenAPI 生成型と UI DTO のマッピングを専用ファクトリで行い、alias 名と camelCase/ snake_case の変換ポリシーを明文化。
7. バックエンドの API 拡張時に自動生成された `types/api` を同期するスクリプトを CI に組み込む。
8. 例外ハンドラをモジュール化し、各機能モジュールが依存する形で登録する構造へ移行。
9. HTTP クライアントの prefixUrl をデプロイ単位で明示設定し、二重 `/api` 防止のテストを追加。
10. ドキュメント（README/STYLE_GUIDE）を現行フォルダ構成に合わせて更新。

### 7.3 クイックウィン（約1時間で対応可能）
- main.py のルーター登録をカテゴリ別のリスト化・コメント整理で可読性改善。


- allocation calculator 内のステータス比較を Enum 参照に変更する軽微リファクタ。


- services/api.ts から Compat ヘルパを分離しファイル分割。


- README と実ディレクトリ構成の差分を補足する注記追記。



### 7.4 中規模リファクタリング
- ドメインサービス層の導入：Lot 更新・引当・検査などをユースケース単位でまとめ、リポジトリパターンを採用してトランザクション境界を明示。
- API DTO と DB モデルのマッピング整理：Pydantic モデルを入力/出力/内部用に分離し、エンティティの不変条件を型で表現。
- フロントのデータフロー再設計：TanStack Query hooks + 状態管理（Jotai など）で画面間共有ステートを整理し、サービス呼び出しを hook に集約。

### 7.5 大規模リファクタリング
- クリーンアーキテクチャ/Hexagonal への再配置：domain/application/infrastructure/presentation フォルダ構成を適用し、依存逆転を徹底。  
- マルチテナント・パフォーマンス対応のための CQRS/イベントソーシング整理：stock_movements とサマリテーブルの再計算フローをドメインイベントで統制。  
- API スキーマの自動生成と型共有パイプラインの確立：バックエンド OpenAPI → TypeScript 型生成 → API hook 自動生成までを CI/CD で一貫。

## 8. 不明点・前提条件
- DB モデル定義全体と実際のマイグレーション整合性が未確認【不明】。
- 在庫サマリ計算や割当候補抽出のサービス層実装が見当たらず、現行ビジネスルールとの乖離有無【要確認】。
- フロントの features/hooks 実装詳細が未レビューのため、画面単位の状態管理方針やテストカバレッジは不明【不明】。

