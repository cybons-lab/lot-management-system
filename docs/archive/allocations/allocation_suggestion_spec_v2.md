# 引当推奨機能（ソフトアロケーション）仕様書 v2.0

## 1. 概要
本機能は、将来の需要（フォーキャスト）や受注に対して、在庫をどのように割り当てるべきかをシステムが提案（ソフトアロケーション）する機能です。
FEFO（First-Expired, First-Out：先入れ先出し/期限切迫順）ロジックに基づき、賞味期限の近い在庫から優先的に引き当てる案を作成します。

## 2. 業務フロー

### 2.1. フォーキャスト取込時の自動生成
1.  **フォーキャスト取込**: CSVインポート等でフォーキャストデータが登録されます。
2.  **自動再計算**: 取込完了後、対象期間（Forecast Period）の引当推奨が自動的に再計算されます。
    *   既存の推奨データは削除され、最新の在庫・フォーキャスト状況に基づいて再生成されます。

### 2.2. 手動生成（フォーキャスト一覧画面）
1.  **生成ボタン**: 「フォーキャスト一覧」画面に設置された「引当推奨生成」ボタンを押下します。
2.  **期間指定**: 現在から向こう3ヶ月分の期間に対して、引当推奨を強制的に再生成します。
    *   在庫状況が変化した場合などに、手動で最新化したい場合に使用します。

### 2.3. 受注引当時の自動入力（ロット引当画面）
1.  **画面表示**: 受注に対する「ロット引当」画面を開きます。
2.  **自動入力**: 画面表示時、未引当の明細に対して、FEFOロジックに基づいた引当数量が**自動的に入力（プレビュー）**されます。
    *   ユーザーは提案された数量を確認し、必要に応じて修正して「確定」します。
    *   これにより、「値が埋まっている状態」から作業を開始できます。

## 3. 引当ロジック (FEFO)
在庫の割り当ては以下の優先順位で行われます：

1.  **賞味期限 (Expiry Date)**: 期限が近いものから優先。
2.  **入荷日 (Received Date)**: 期限が同じ場合、入荷が古いものから優先。
3.  **ロット番号**: 上記が同じ場合、ロット番号順。

※ **ソフトアロケーション**であるため、在庫の物理的な移動や拘束（ハードアロケーション）は行いません。あくまで「推奨案」としてのデータ作成、または画面上のプレビュー表示となります。

## 4. データモデル

### `allocation_suggestions` テーブル
システムが生成した推奨データを保持します。

| カラム名 | 型 | 説明 |
| :--- | :--- | :--- |
| `id` | BigInteger | PK |
| `forecast_period` | String(7) | 対象期間 (YYYY-MM) |
| `customer_id` | BigInteger | 得意先ID |
| `delivery_place_id` | BigInteger | 納入先ID |
| `product_id` | BigInteger | 製品ID |
| `lot_id` | BigInteger | 割り当てるロットID |
| `quantity` | Decimal | 引当数量 |
| `allocation_type` | String | 'soft' (推奨) / 'hard' (確定 - 将来用) |
| `source` | String | 'forecast_import' 等 |

## 5. API仕様

### 5.1. 引当推奨生成/プレビュー
`POST /allocation-suggestions/preview`

*   **Mode: `forecast`**: 指定期間のフォーキャストに対して推奨データをDBに保存（再生成）。
*   **Mode: `order`**: 指定オーダー明細に対して、推奨引当数量を計算して返却（DB保存なし）。

### 5.2. 一覧取得
`GET /allocation-suggestions`

*   推奨データの一覧を取得します。期間や製品でフィルタリング可能です。

## 6. 画面機能詳細

### フォーキャスト一覧
*   **「引当推奨生成」ボタン**:
    *   押下すると、当月を含む向こう3ヶ月分の推奨データを再生成します。
    *   実行前に確認ダイアログが表示されます。

### ロット引当画面
*   **初期表示時の挙動**:
    *   画面ロード完了後、未引当の行に対して自動的にFEFO計算が走ります。
    *   計算結果の数量が各ロットの入力欄にセットされます（ドラフト状態）。
    *   ユーザーはそのまま「保存」するか、数量を変更して保存します。
