# ロット引当ページ UI改善仕様書【統合版】

## 📋 ドキュメント概要

本書は以下3つの資料を統合した、包括的なUI改善仕様書です:
1. ロット引当ページの基本改善要件
2. フロントエンド技術的修正ポイント
3. より広範なUI課題(OrderCard、異常系表示、構造改善)

---

## ✅ 前提条件

### バックエンド側
- `npm run typegen` は実行済み
- `v_lot_details` ビューが作成済み(以下のフィールドを持つ):
  - `lot_id`, `lot_number`, `warehouse_id`, `warehouse_name`
  - `available_qty`, `receipt_date`, `expiry_date`, `lot_status`
- ビュー名変更: `lot_current_stock` → `v_lot_current_stock`

### フロントエンド側
- TypeScript型定義が最新化されている想定
- `VLotDetails`, `VLotCurrentStock` 型が利用可能

---

## 🎯 改善対象の範囲

本仕様書は以下の3つのエリアを対象とします:

### 1. **ロット表示部分**(最優先)
- LotRowItem / LotList
- ロット番号、倉庫名、在庫量の表示
- FEFO順位とラベル

### 2. **OrderCard部分**(優先度高)
- 注文カードの状態表示
- 引当状態のバッジ表示

### 3. **UI構造全体**(段階的改善)
- カードの階層化
- 区切りと余白の改善

---

## 🔴 現状の問題点

### **カテゴリ1: ロット表示の問題**

#### 1-1. データ表示の欠落
- ❌ **倉庫名が表示されない**: どの倉庫のロットか判別不能
- ❌ **ロット番号が目立たない**: 視認性が低い
- ❌ **「倉庫未設定」と表示される**: 「未登録」「データなし」に変更すべき
- ❌ **Remaining/Totalの意味が不明**: 「残量/ロット総量」のように改善

#### 1-2. FEFO順位の不明確さ
- ❌ **FEFO順位(#1, #2, #3)が見えない**: 優先度が判別不能
- ❌ **自動引当で使用されたロットが分からない**: ハイライトが必要

#### 1-3. 状態ラベルの欠如
- ❌ **ラベルがない**: 自動/手動/過少/過剰などの状態が不明
- ❌ **すべてのロット行が同じ色**: アクティブ/非アクティブの区別不能

---

### **カテゴリ2: OrderCardの問題**

#### 2-1. 状態の判別不能
OrderCardが以下の状態を区別できない:
- 自動引当済み
- 手動引当済み
- 一部不足
- 未引当
- 候補ロットなし

#### 2-2. バッジの不在
以下のバッジが存在しない:
- 「自動引当済み」
- 「手動調整済み」
- 「未引当」
- 「候補ロットなし(重大)」

#### 2-3. 担当者ロック表示がない
- ❌ 別ユーザーが編集中でも分からない
- ❌ 同時編集事故のリスクあり

---

### **カテゴリ3: 異常系表示の問題**

#### 3-1. 過剰・過少・不足の可視化不足
- ❌ 在庫の多い/少ない/不足の違いが不明
- ❌ 明示的なラベルが必要

#### 3-2. 異常系が目立たない
- ❌ 候補なし・不足などの重大な問題が埋もれる
- ❌ 「⚠ 大量異常」レベルの赤帯などが必要

---

### **カテゴリ4: UI構造の問題**

#### 4-1. 階層構造の不明確さ
- ❌ カード全体がフラット
- ❌ OrderCard(上段)とLotList(下段)の段差が必要

#### 4-2. 視覚的区切りの弱さ
- ❌ 枠・区切り・背景色の差が弱い
- ❌ ブロックごとの識別が困難

#### 4-3. 操作エリアの境界が曖昧
- ❌ 半量/全量ボタンがどのロットに属するか不明確

---

## 🎨 改善後の仕様

### **【A】ロット表示の改善**

#### A-1. ロット行のレイアウト

```
┌──────────────────────────────────────────────────────────┐
│ **LOT: ABC123** (太字・大きめ)        [#1][自動]       │ ← ラベル領域
│ 倉庫: 東倉庫 (text-gray-600)                            │
│ 残量: 100 / 総量: 150 (明確な表記)                      │
│ 入荷: 2025-01-15 | 期限: 2025-12-31                    │
└──────────────────────────────────────────────────────────┘
※ アクティブな行のみ背景色を濃くする(bg-blue-50など)
```

#### A-2. 表示要素の詳細

| 要素 | 位置 | スタイル | データソース |
|------|------|----------|--------------|
| **ロット番号** | 行の上部左 | 太字・大きめフォント | `lot_number` |
| **倉庫名** | ロット番号の下 | `text-gray-600` | `warehouse_name` |
| **在庫量** | 中段 | 「残量 XX / 総量 XX」 | `available_qty` |
| **日付情報** | 下段 | 小さめ・グレー | `receipt_date`, `expiry_date` |
| **ラベル領域** | 右端 | Badge群 | 後述 |

#### A-3. ラベルの種類と条件

##### ① FEFO順位ラベル
| ラベル | 条件 | スタイル |
|--------|------|----------|
| `#1` | FEFO最優先 | `bg-blue-600 text-white` |
| `#2` | 2番目 | `bg-blue-400 text-white` |
| `#3` | 3番目 | `bg-blue-300 text-white` |

##### ② 状態ラベル
| ラベル | 条件 | スタイル |
|--------|------|----------|
| `自動引当` | 自動割当済み | `bg-green-100 text-green-800` |
| `手動引当` | ユーザー選択 | `bg-blue-100 text-blue-800` |
| `過少` | available_qty < 必要量 | `bg-yellow-100 text-yellow-800` |
| `過剰` | available_qty > 閾値 | `bg-orange-100 text-orange-800` |
| `ロック中` | 編集不可 | `bg-gray-200 text-gray-600` |

##### ③ 倉庫表示の改善
| 表示前 | 表示後 |
|--------|--------|
| `倉庫未設定` | `未登録` または `データなし` |

##### ④ 数量表示の改善
| 表示前 | 表示後 |
|--------|--------|
| `Remaining: 100 / Total: 150` | `残量: 100 / 総量: 150` |

#### A-4. 背景色の制御

| 状態 | 背景色 |
|------|--------|
| **アクティブ**(引当中) | `bg-blue-50` または `bg-gray-100` |
| **非アクティブ** | `bg-white` |
| **ホバー時** | `hover:bg-gray-50` |

---

### **【B】OrderCardの改善**

#### B-1. 状態別の色分け

| 状態 | カード背景色 | ボーダー |
|------|-------------|---------|
| 自動引当済み | `bg-green-50` | `border-green-300` |
| 手動引当済み | `bg-blue-50` | `border-blue-300` |
| 一部不足 | `bg-yellow-50` | `border-yellow-300` |
| 未引当 | `bg-gray-50` | `border-gray-300` |
| 候補ロットなし | `bg-red-50` | `border-red-300` |

#### B-2. バッジの追加

OrderCard右上に状態バッジを配置:
- `自動引当済み`: green badge
- `手動調整済み`: blue badge
- `未引当`: gray badge
- `候補ロットなし`: red badge + 警告アイコン

#### B-3. 担当者ロック表示

編集中の場合、OrderCard上部に以下を表示:
```
┌──────────────────────────────────────────┐
│ 🔒 田中太郎さんが編集中 (2分前〜)        │
└──────────────────────────────────────────┘
```

スタイル: `bg-yellow-100 border-yellow-300 text-yellow-800`

---

### **【C】異常系表示の強化**

#### C-1. 重大な異常の目立たせ方

候補ロットなし・大量不足などの場合:
```
┌────────────────────────────────────────────────┐
│ ⚠ 警告: 候補ロットが見つかりません              │
│ この注文に割り当て可能なロットがありません      │
└────────────────────────────────────────────────┘
```

スタイル: `bg-red-100 border-red-500 text-red-900 font-bold`

#### C-2. 過剰・過少の視覚化

| 状態 | 表示 | スタイル |
|------|------|----------|
| 過剰在庫 | 「⚠ 在庫過剰」バッジ | `bg-orange-100 text-orange-800` |
| 過少在庫 | 「⚠ 在庫過少」バッジ | `bg-yellow-100 text-yellow-800` |
| 不足 | 「❌ 在庫不足」バッジ | `bg-red-100 text-red-800` |

---

### **【D】UI構造の改善**

#### D-1. カードの階層化

```
┌─ OrderCard (上段・濃い背景) ───────────────┐
│ 注文情報・バッジ・ロック表示               │
└────────────────────────────────────────────┘
     ↓ 視覚的な段差・余白
┌─ LotList (下段・薄い背景) ─────────────────┐
│  ├─ LotRowItem #1 (アクティブ)            │
│  ├─ LotRowItem #2 (非アクティブ)          │
│  └─ LotRowItem #3 (非アクティブ)          │
└────────────────────────────────────────────┘
```

#### D-2. 区切りの強化

- OrderCardとLotListの間に `border-t-2` と `my-4` で明確な区切り
- LotRowItem間にも薄い区切り線(`border-b border-gray-200`)

#### D-3. 操作エリアの明確化

半量/全量ボタンを含む操作エリア:
```
┌─ LotRowItem ─────────────────────────────┐
│ ロット情報                                │
│  ┌─ 操作エリア ─────────────────┐       │
│  │ [半量] [全量] [リセット]      │       │
│  └──────────────────────────────┘       │
└──────────────────────────────────────────┘
```

操作エリアに `bg-gray-50 rounded p-2` などで視覚的に分離

---

### **【E】単位取扱いの改善**

#### E-1. 内部単位と外部単位の併記
- **OrderCard**:
    - メイン: 受注単位での数量 (例: `40 KG`)
    - サブ: 内部管理単位への換算値 (例: `(= 2 CAN)`) ※単位が異なる場合のみ表示
- **LotList**:
    - メイン: 内部管理単位での数量 (例: `5 CAN`)
    - サブ: 外部単位への換算値 (例: `(= 100 KG)`) ※換算係数が定義されている場合
- **入力フィールド**:
    - 入力は内部管理単位 (例: `CAN`)
    - 入力値の下に外部単位への換算値をリアルタイム表示 (例: `1 CAN = 20 KG`)

#### E-2. データ構造
- **Product**:
    - `internal_unit`: 内部管理単位 (Allocation Unit)
    - `external_unit`: 外部表示単位 (Display/Input Unit)
    - `qty_per_internal_unit`: 換算係数 (1 Internal = X External)
- **OrderLine**:
    - `converted_quantity`: 内部単位に換算された数量

---

## 🛠 技術的実装ガイド

### **1. 型定義の確認**

以下の型が生成されていることを確認:
```ts
interface VLotDetails {
  lot_id: number;
  lot_number: string;
  warehouse_id: number;
  warehouse_name: string;
  available_qty: number;
  receipt_date: string | null;
  expiry_date: string | null;
  lot_status: string;
}

interface VLotCurrentStock {
  // 同様に確認
}
```

### **2. API呼び出しの修正**

#### 修正対象
- `useLotAllocation` 系フック
- ロット一覧取得API
- 自動引当候補取得API

#### 修正例
```ts
// Before
const { data } = useQuery(["lots", id], () => client.lots.get(id));

// After
const { data } = useQuery(["lotDetails", id], () => 
  client.v_lot_details.get(id)
);
```

### **3. コンポーネント構造の整理**

#### 推奨構造
```
LotAllocationPane
 ├─ OrderCard (新規または既存を改修)
 │   ├─ OrderInfo
 │   ├─ StatusBadge
 │   └─ LockIndicator (新規)
 ├─ LotList
 │   └─ LotRowItem (改修)
 │       ├─ LotNumber (新規コンポーネント化)
 │       ├─ WarehouseLabel (新規)
 │       ├─ QtyInfo (改修)
 │       ├─ DateInfo (新規)
 │       └─ LabelGroup (新規)
 │           ├─ FEFOBadge
 │           └─ StatusBadge
 └─ LotDetailPanel
```

### **4. 共通化の推奨**

以下を共通コンポーネント/ユーティリティ化:
```
utils/label.ts         → ラベル生成ロジック
utils/date.ts          → 日付フォーマット
components/lot/
  ├─ LotNumberDisplay.tsx
  ├─ WarehouseBadge.tsx
  ├─ FEFOPriorityBadge.tsx
  └─ LotStatusBadge.tsx
types/lot.ts           → ロット関連型定義
```

### **5. FEFOソート順の確認**

#### ロジック
```
expiry_date ASC → receipt_date ASC → lot_id ASC
```

#### 実装方針
- **推奨**: バックエンドでソート済み → フロントはそのまま表示
- **最終手段**: フロント側で再計算(パフォーマンス注意)

---

## 📊 優先順位と段階的実装

### **Phase 1: 緊急対応**(最優先)

1. ✅ typegen を最新化(完了想定)
2. 🔥 **倉庫名の表示**(これがないと他が無意味)
3. 🔥 **ロット番号の太字化・視認性向上**
4. 🔥 **APIを v_lot_details に統一**

### **Phase 2: 視認性改善**(優先度高)

5. ラベル領域の追加(FEFO順位・状態)
6. アクティブ行の背景色変更
7. OrderCardの状態別色分け
8. 担当者ロック表示

### **Phase 3: UX向上**(段階的)

9. 異常系表示の強化(赤帯など)
10. UI構造の階層化・区切り改善
11. 操作エリアの明確化
12. 全体的なスタイル調整

### **Phase 4: 操作性・情報参照の強化**(実装済み)

13. ✅ **全量ボタンの改善**: ワンクリックで他をクリアして全量確保、計算ロジック修正
14. ✅ **一括操作**: チェックボックスによる一括選択・解除・保存
15. ✅ **リスト整理**: チェック済み項目の折りたたみと下部移動（アニメーション付き）
16. ✅ **ナビゲーション**: 上下ジャンプボタン（TOP/CHK）の追加
17. ✅ **情報参照**: 数量入力時のフォーキャスト情報ツールチップ表示
18. ✅ **視認性**: クリアボタン、矢印アイコン、ホバー効果の改善

### **Phase 5: 単位取扱いの再構築**(実装済み)

19. ✅ **DBスキーマ更新**: Product/OrderLineへの単位カラム追加
20. ✅ **バックエンドロジック**: 受注時の単位換算、内部単位での引当計算
21. ✅ **OrderCard表示**: 受注単位と内部単位の併記
22. ✅ **LotList表示**: 内部単位表示と外部単位換算の併記
23. ✅ **入力補助**: 入力時のリアルタイム換算表示

---

## 🎯 実装してほしいこと(AI向け指示)

### **基本方針**
1. **Lot Allocation Page全体を探索**し、UIの表示部分を特定
2. 必要なファイルを自動で探して修正
3. `v_lot_details`のフィールドを正しく表示に反映

### **作業の進め方**
1. ✅ まず**影響範囲(修正対象ファイル)を一覧で提示**
2. 各ファイルの修正内容を順次実装
3. 必要に応じてコンポーネント分割やスタイルファイル追加

### **注意点**
- Phase 1 → Phase 2 → Phase 3 の順序を守る
- 倉庫名表示ができない限り、他の改善は後回し
- 既存のコンポーネント構造を尊重しつつ、必要な箇所のみ修正

---

## 📈 期待される改善効果

### Before → After 比較

| 項目 | Before | After |
|------|--------|-------|
| **倉庫情報** | ❌ 表示されない | ✅ 明確に表示 |
| **ロット状態** | ❌ 判別不能 | ✅ ラベルで一目瞭然 |
| **FEFO順位** | ❌ 不明 | ✅ #1, #2, #3で明示 |
| **アクティブ識別** | ❌ 同じ色 | ✅ 背景色で強調 |
| **OrderCard状態** | ❌ 全て同じ | ✅ 色分け+バッジ |
| **編集ロック** | ❌ 不明 | ❌ 未実装（残課題） |
| **異常系** | ❌ 埋もれる | ⚠ 一部改善（残課題あり） |
| **UI階層** | ❌ フラット | ✅ 段差で明確化 |
| **操作性** | ❌ 全量ボタン不具合 | ✅ ワンクリック全量、一括操作 |
| **情報参照** | ❌ 予測見えない | ✅ ツールチップで予測表示 |
| **単位表示** | ❌ 単位混在で混乱 | ✅ 内部/外部単位を明確に併記 |

---

## 🔗 関連ファイル

### 想定される修正対象
```
frontend/src/features/allocations/
  ├─ LotAllocationPane.tsx        (メイン)
  ├─ LotAllocationPanel.tsx       (パネル)
  ├─ components/
  │   ├─ OrderCard.tsx            (新規または改修)
  │   └─ LotRowItem.tsx           (要改修)
  └─ hooks/
      └─ useLotAllocation.ts      (API呼び出し)

frontend/src/hooks/api/
  └─ useLotsQuery.ts              (存在すれば修正)

frontend/src/api/types/
  └─ generated.ts                 (typegen出力)
```

---

## ✅ 完了チェックリスト

実装後に以下を確認:

### Phase 1(必須) - ✅ 完了
- [x] 倉庫名が正しく表示される
- [x] ロット番号が太字で目立つ
- [x] APIが `v_lot_details` を参照している
- [x] TypeScript型エラーがない

### Phase 2(推奨) - ✅ 完了
- [x] FEFO順位ラベル(#1, #2, #3)が表示される
- [x] 状態ラベル(自動/手動/過少/過剰)が表示される
- [x] アクティブなロットの背景色が濃い
- [x] OrderCardが状態別に色分けされている

### Phase 3(理想) - ✅ 完了
- [ ] 担当者ロック表示が機能している（未実装）
- [x] 異常系(候補なし等)が赤帯で警告される
- [x] UI階層(OrderCard/LotList)が明確
- [x] 操作エリアが視覚的に分離されている

### Phase 4(追加改善) - ✅ 完了
- [x] 全量ボタンが正しく動作する
- [x] チェックボックス一括操作ができる
- [x] チェック済み項目が移動する
- [x] フォーキャスト情報が表示される
- [x] ジャンプボタンが機能する
- [x] ステータスフィルタリング機能（完了/不足/過剰/未引当/候補なし）
- [x] 「上へ戻る」ボタンの常時表示

### Phase 5(単位取扱い) - ✅ 完了
- [x] DBスキーマ(Product, OrderLine)に単位カラムが追加されている
- [x] 受注作成時に数量が内部単位に正しく換算される
- [x] 引当計算が内部単位(converted_quantity)で行われる
- [x] OrderCardに受注単位と内部単位が併記される
- [x] LotListに内部単位と外部単位換算が併記される
- [x] 数量入力時に換算値が表示される

---

## 🚀 残課題（未実装タスク）

以下の機能はまだ実装されていません。次回の開発サイクルで検討してください。

### 1. 担当者ロック表示 (排他制御)
- **要件**: 別ユーザーが編集中の場合、OrderCard上部に「🔒 田中太郎さんが編集中」と表示し、操作をブロックまたは警告する。
- **現状**: 排他制御のロジックおよびUIが存在しない。ユーザー認証機能の実装待ち。

### 2. レスポンシブ対応の最適化
- **要件**: モバイル端末での表示確認と調整。
- **現状**: PCビューを中心に開発しており、モバイルでの検証が不十分。優先度は低。

---

## 📝 補足事項

### スタイルフレームワーク
- Tailwind CSS使用想定
- shadcn/ui の Badge コンポーネント利用可能
- 既存のデザインシステムに準拠

### レスポンシブ対応
- 既存の実装に準拠
- モバイル表示では一部ラベルを省略する可能性あり

### アクセシビリティ
- ラベルには適切な `aria-label` を設定
- 色だけに依存せず、アイコンやテキストでも状態を示す

---

以上が統合版のUI改善仕様書です。
Phase 1から順に実装していくことで、段階的かつ確実な改善が可能です。
