# 繧｢繝励Μ螻､ 縺ゅｉ謗｢縺励Ξ繝昴・繝・
## 謖・遭荳隕ｧ

### 1. 莠育ｴ・庄逕ｨ驥剰ｨ育ｮ励′繝ｭ繝・け謨ｰ驥上ｒ辟｡隕悶＠縺ｦ驕主､ｧ隧穂ｾ｡ (P1)
- **逞・憾**: 繝ｭ繝・け縺輔ｌ縺溷惠蠎ｫ (`locked_quantity`) 繧呈戟縺､繝ｭ繝・ヨ縺ｧ繧ゆｺ育ｴ・ｽ懈・縺碁壹ｊ縲∝ｮ滄圀縺ｫ蠑輔″蠖薙※蜿ｯ閭ｽ縺ｪ謨ｰ驥上ｒ雜・∴縺ｦ莠育ｴ・〒縺阪ｋ縲ょｾ檎ｶ壹・蜃ｺ蠎ｫ繝ｻ蠑募ｽ薙〒荳崎ｶｳ繧ｨ繝ｩ繝ｼ繧・・繧､繝翫せ谿九′逋ｺ逕溘＠蠕励ｋ縲・- **蜀咲樟/譚｡莉ｶ**: `lots.locked_quantity > 0` 縺ｮ繝ｭ繝・ヨ縺ｫ蟇ｾ縺・`LotReservationService.reserve` 繧貞他縺ｳ蜃ｺ縺吶→縲～locked_quantity` 繧貞ｷｮ縺怜ｼ輔°縺壹↓蜿ｯ逕ｨ驥丞愛螳壹ｒ陦後≧縺溘ａ縲√Ο繝・け蛻・ｒ鬟溘＞霎ｼ繧薙□莠育ｴ・′菴懈・縺輔ｌ繧九ゅ色:backend/app/application/services/inventory/lot_reservation_service.py窶L329-L368縲・- **蜴溷屏**: `_calculate_available_qty` 縺・`current_quantity - reserved_qty` 縺励°隕九※縺翫ｉ縺壹∝酔縺倥し繝ｼ繝薙せ蜀・・莉悶・繝倥Ν繝代・(`stock_calculation.get_available_quantity`)縺梧治逕ｨ縺吶ｋ繝ｭ繝・け謗ｧ髯､繝ｫ繝ｼ繝ｫ縺ｨ荵夜屬縺励※縺・ｋ縲ゅ色:backend/app/application/services/inventory/lot_reservation_service.py窶L329-L368縲代色:backend/app/application/services/inventory/stock_calculation.py窶L35-L55縲・- **蠖ｱ髻ｿ遽・峇**: 莠育ｴ・ｳｻAPI/繧ｵ繝ｼ繝薙せ蜈ｨ闊ｬ・医ヵ繧ｩ繝ｼ繧ｭ繝｣繧ｹ繝医・蜿玲ｳｨ繝ｻ謇句虚莠育ｴ・ｼ峨ゅΟ繝・け蝨ｨ蠎ｫ繧貞ｰ企㍾縺吶ｋ險ｭ險亥燕謠舌′遐ｴ繧峨ｌ縲∝惠蠎ｫ莠碁㍾驟榊・縺ｮ貂ｩ蠎翫↓縺ｪ繧九・- **菫ｮ豁｣譯・*:
  - *譛蟆・: `_calculate_available_qty` 繧・`current_quantity - reserved - locked_quantity` 縺ｫ鄂ｮ縺肴鋤縺医～get_available_quantity` 縺ｨ蜷御ｸ繝ｭ繧ｸ繝・け縺ｫ縺吶ｋ縲・  - *逅・Φ*: 蝨ｨ蠎ｫ蜿ｯ逕ｨ驥上Ο繧ｸ繝・け繧・繧ｫ謇縺ｫ髮・ｴ・ｼ井ｾ九∴縺ｰ `stock_calculation.get_available_quantity_by_id` 繧貞茜逕ｨ・峨＠縲√し繝ｼ繝薙せ/繝薙Η繝ｼ/繝輔Ο繝ｳ繝医〒蜈ｱ騾壼喧縲・- **菫ｮ豁｣譎ゅ・豕ｨ諢・*: 蜿ｯ逕ｨ驥上′貂帙ｋ縺溘ａ譌｢蟄倥ユ繧ｹ繝医ョ繝ｼ繧ｿ縺ｧ莠育ｴ・､ｱ謨励′蠅励∴繧句庄閭ｽ諤ｧ縺ゅｊ縲ゆｺ育ｴ・ｽ懈・繝ｻ譖ｴ譁ｰ邉ｻ縺ｮE2E繝・せ繝医ｒ隱ｿ謨ｴ縺吶ｋ縺薙→縲・
### 2. 繝薙Η繝ｼ縺ｮ蠑募ｽ馴寔險医′ confirmed 繧帝勁螟悶＠蝨ｨ蠎ｫ繧帝℃螟ｧ陦ｨ遉ｺ (P1)
- **逞・憾**: `v_lot_available_qty` 繧・`v_inventory_summary` 縺・confirmed 莠育ｴ・ｒ辟｡隕悶＠縺溷庄逕ｨ驥上ｒ霑斐＠縲√ヵ繝ｭ繝ｳ繝医・蝨ｨ蠎ｫ陦ｨ遉ｺ繧・呵｣懊Ο繝・ヨ驕ｸ螳壹′螳溷惠蠎ｫ繧医ｊ螟壹￥隕狗ｩ阪ｂ繧峨ｌ繧九・- **蜀咲樟/譚｡莉ｶ**: 莠育ｴ・せ繝・・繧ｿ繧ｹ縺・`confirmed` 縺ｮ陦後′蟄伜惠縺吶ｋ繝ｭ繝・ヨ繧・`v_lot_available_qty` 邨檎罰縺ｧ蜿ら・縺吶ｋ縺ｨ縲～allocated_quantity` 縺・縺ｨ縺励※謇ｱ繧上ｌ蜿ｯ逕ｨ驥上′豌ｴ蠅励＠縺輔ｌ繧九ゅ色:backend/sql/views/create_views.sql窶L29-L127縲・- **蜴溷屏**: `v_lot_allocations` 縺ｮ螳夂ｾｩ縺・`status = 'active'` 縺ｮ縺ｿ繧担UM縺励※縺翫ｊ縲√ラ繝｡繧､繝ｳ荳榊､画擅莉ｶ縲径ctive/confirmed縺悟庄逕ｨ驥上ｒ貂帷ｮ励阪↓蜿阪＠縺ｦ縺・ｋ縲ゅ色:backend/sql/views/create_views.sql窶L34-L127縲代色:backend/app/application/services/inventory/lot_reservation_service.py窶L300-L368縲・- **蠖ｱ髻ｿ遽・峇**: 蝨ｨ蠎ｫ髢｢騾｣繝薙Η繝ｼ繧貞茜逕ｨ縺吶ｋ蜈ｨAPI/繝輔Ο繝ｳ繝茨ｼ亥惠蠎ｫ荳隕ｧ縲∝呵｣懊Ο繝・ヨ謠千､ｺ縲∝惠蠎ｫ繧ｵ繝槭Μ・峨ょｮ溷惠蠎ｫ繧医ｊ螟壹＞謨ｰ驥上〒蠑募ｽ薙・蜃ｺ蠎ｫ諢乗晄ｱｺ螳壹′陦後ｏ繧後ｋ蜊ｱ髯ｺ縲・- **菫ｮ豁｣譯・*:
  - *譛蟆・: `v_lot_allocations` 縺ｮ WHERE 繧・`status IN ('active','confirmed')` 縺ｫ螟画峩縺励∽ｾ晏ｭ倥ン繝･繝ｼ縺ｮ蜿ｯ逕ｨ驥冗ｮ怜・繧呈ｭ｣縺吶・  - *逅・Φ*: 繝峨Γ繧､繝ｳ縺ｮ蜿ｯ逕ｨ驥上Ο繧ｸ繝・け繧偵ン繝･繝ｼ/繧ｵ繝ｼ繝薙せ縺ｧ蜈ｱ騾壹Δ繧ｸ繝･繝ｼ繝ｫ蛹悶＠縲√せ繝・・繧ｿ繧ｹ霑ｽ蜉譎ゅ・謚懊￠貍上ｌ繧偵ユ繧ｹ繝医〒髦ｲ豁｢縲・- **菫ｮ豁｣譎ゅ・豕ｨ諢・*: confirmed蛻・ｒ蜉蜻ｳ縺吶ｋ縺ｨ蜿ｯ逕ｨ驥上′貂帙ｋ縺溘ａ譌｢蟄篭I縺ｮ謨ｰ蛟､縺悟､峨ｏ繧九ゅく繝｣繝・す繝･繧・寔險医ず繝ｧ繝悶′譌ｧ繝薙Η繝ｼ繧貞燕謠舌↓縺励※縺・↑縺・°遒ｺ隱阪☆繧九％縺ｨ縲・
### 3. 莠育ｴ・｢ｺ螳壹・蜀ｪ遲峨メ繧ｧ繝・け縺梧ｩ溯・縺帙★莠碁㍾遒ｺ螳壹ｒ險ｱ螳ｹ (P2)
- **逞・憾**: `LotReservationService.confirm` 繧貞酔縺倅ｺ育ｴ・↓蟇ｾ縺励※隍・焚蝗槫他繧薙〒繧ょｸｸ縺ｫ譖ｴ譁ｰ蜃ｦ逅・′襍ｰ繧翫∝・遲画ｧ縺梧球菫昴＆繧後↑縺・ょ､夜Κ縺九ｉ縺ｮ繝ｪ繝医Λ繧､譎ゅ↓荳崎ｦ√↑譖ｴ譁ｰ繝ｻ繧､繝吶Φ繝育匱轣ｫ縺瑚ｵｷ縺薙ｊ蠕励ｋ縲・- **蜀咲樟/譚｡莉ｶ**: `reservation.status` 縺轡B荳翫・譁・ｭ怜・縺縺後√Γ繧ｽ繝・ラ縺ｯ `ReservationStatus.CONFIRMED`・・num繧ｪ繝悶ず繧ｧ繧ｯ繝茨ｼ峨→豈碑ｼ・☆繧九◆繧∽ｸ閾ｴ蛻､螳壹↓螟ｱ謨励＠縲∵ｯ主屓譖ｴ譁ｰ繝悶Ο繝・け繧帝夐℃縺吶ｋ縲ゅ色:backend/app/application/services/inventory/lot_reservation_service.py窶L189-L204縲代色:backend/app/infrastructure/persistence/models/lot_reservations_model.py窶L51-L112縲・- **蜴溷屏**: Enum蝙九→譁・ｭ怜・縺ｮ豈碑ｼ・Α繧ｹ縺ｫ繧医ｊ縲梧里縺ｫconfirmed縺ｪ繧画掠譛殲eturn縲阪→縺・≧繧ｬ繝ｼ繝峨′蜉ｹ縺・※縺・↑縺・・- **蠖ｱ髻ｿ遽・峇**: 莠育ｴ・｢ｺ螳哂PI/繝舌ャ繝√ら┌逕ｨ縺ｪUPDATE縺ｫ繧医ｋ陦後Ο繝・け蟒ｶ髟ｷ繝ｻ逶｣譟ｻ繝ｭ繧ｰ豎壽沒縲∝ｰ・擂繧､繝吶Φ繝磯｣謳ｺ譎ゅ・莠碁㍾騾夂衍繝ｪ繧ｹ繧ｯ縲・- **菫ｮ豁｣譯・*:
  - *譛蟆・: 豈碑ｼ・→莉｣蜈･繧呈枚蟄怜・繝吶・繧ｹ縺ｫ邨ｱ荳・井ｾ・ `if reservation.status == ReservationStatus.CONFIRMED.value`・峨・  - *逅・Φ*: `status` 繧ｫ繝ｩ繝繧脱num蝙九↓螟画峩縺励￣ydantic/DB蜿梧婿縺ｧEnum繧呈桶縺・ｈ縺・梛螳牙・蛹悶・- **菫ｮ豁｣譎ゅ・豕ｨ諢・*: 繝｢繝・Ν縺ｮ蝙句､画峩譎ゅ・繝槭う繧ｰ繝ｬ繝ｼ繧ｷ繝ｧ繝ｳ縺悟ｿ・ｦ√・num蛹悶☆繧九→譛ｪ遏･蛟､縺ｮ謚募・縺悟ｼｾ縺九ｌ繧狗せ繧偵ユ繧ｹ繝医〒遒ｺ隱阪・
### 4. 蜃ｺ蠎ｫAPI縺後Μ繧ｽ繝ｼ繧ｹ譛ｪ蟄伜惠繧・00縺ｧ霑斐＠繧ｯ繝ｩ繧､繧｢繝ｳ繝亥・騾√ｒ蝗ｰ髮｣縺ｫ縺吶ｋ (P2)
- **逞・憾**: 繝ｭ繝・ヨ/蠕玲э蜈・邏榊・蜈医′蟄伜惠縺励↑縺・ｴ蜷医〒繧・TTP 400繧定ｿ斐☆縺溘ａ縲√け繝ｩ繧､繧｢繝ｳ繝医′縲悟・蜉幄ｪ､繧翫阪→縲悟ｯｾ雎｡譛ｪ蟄伜惠縲阪ｒ蛹ｺ蛻･縺ｧ縺阪★縲∝・騾√ｄ繝・・繧ｿ蜷梧悄縺ｮ閾ｪ蜍輔Μ繝医Λ繧､縺後〒縺阪↑縺・・- **蜀咲樟/譚｡莉ｶ**: `/withdrawals` 縺ｫ蟄伜惠縺励↑縺・`lot_id` 縺ｧPOST縺吶ｋ縺ｨ `ValueError` 縺粂TTP 400縺ｫ螟画鋤縺輔ｌ繧九ゅ色:backend/app/presentation/api/routes/inventory/withdrawals_router.py窶L82-L110縲代色:backend/app/application/services/inventory/withdrawal_service.py窶L43-L114縲・- **蜴溷屏**: `WithdrawalService` 縺梧悴蟄伜惠繧・`ValueError` 縺ｧ謚輔￡縲√Ν繝ｼ繧ｿ繝ｼ縺ｧ荳蠕・00縺ｫ繝槭ャ繝斐Φ繧ｰ縺励※縺・ｋ縲・04/409縺ｪ縺ｩ迥ｶ諷九↓蠢懊§縺溘お繝ｩ繝ｼ險ｭ險医′辟｡縺・・- **蠖ｱ髻ｿ遽・峇**: 蜃ｺ蠎ｫ菴懈・API縲ゅけ繝ｩ繧､繧｢繝ｳ繝亥・縺ｮ繧ｨ繝ｩ繝ｼ繝上Φ繝峨Μ繝ｳ繧ｰ縺梧尠譏ｧ縺ｫ縺ｪ繧翫∝酔譛溘ヰ繝・メ繧СPA縺ｮ蜀榊ｮ溯｡悟愛螳壹ｒ隱､繧峨○繧九・- **菫ｮ豁｣譯・*:
  - *譛蟆・: 譛ｪ蟄伜惠邉ｻ縺ｯ蟆ら畑萓句､悶ｒ謚輔￡縲√Ν繝ｼ繧ｿ繝ｼ縺ｧ404縺ｫ繝槭ャ繝励ょ庄逕ｨ驥丈ｸ崎ｶｳ縺ｯ409(Conflict)縺ｪ縺ｩ諢丞袖縺ｮ縺ゅｋ繧ｹ繝・・繧ｿ繧ｹ繧定ｿ斐☆縲・  - *逅・Φ*: 繝峨Γ繧､繝ｳ萓句､悶ｒ謨ｴ逅・＠繝ｬ繧ｹ繝昴Φ繧ｹ繧ｳ繝ｼ繝・繧ｨ繝ｩ繝ｼ繝｡繝・そ繝ｼ繧ｸ繧堤ｵｱ荳縲√ユ繝ｼ繝悶Ν鬧・虚縺ｮ繧ｨ繝ｩ繝ｼ螟画鋤螻､繧貞ｰ主・縲・- **菫ｮ豁｣譎ゅ・豕ｨ諢・*: 繧ｹ繝・・繧ｿ繧ｹ繧ｳ繝ｼ繝牙､画峩縺ｫ莨ｴ縺・ヵ繝ｭ繝ｳ繝・繝・せ繝医・譛溷ｾ・､譖ｴ譁ｰ縺悟ｿ・ｦ√・
### 5. 繝薙Η繝ｼ縺ｨ繧ｵ繝ｼ繝薙せ縺ｧ縲御ｺ育ｴ・庄逕ｨ驥上阪・螳夂ｾｩ縺御ｺ碁㍾蛹悶＠讀懆ｨｼ荳崎・ (P2)
- **逞・憾**: 繧ｵ繝ｼ繝薙せ蛛ｴ縺ｨ繝薙Η繝ｼ蛛ｴ縺ｧ蜿ｯ逕ｨ驥冗ｮ怜・繝ｭ繧ｸ繝・け縺檎焚縺ｪ繧翫√←縺｡繧峨′豁｣縺句愛蛻･縺励▼繧峨＞縲ゆｾ・ 繧ｵ繝ｼ繝薙せ縺ｯ繝ｭ繝・け謗ｧ髯､繧呈Φ螳夲ｼ・stock_calculation.get_available_quantity`・峨√ン繝･繝ｼ縺ｯ繝ｭ繝・け謗ｧ髯､繧貞性繧縺軍eservation繧ｹ繝・・繧ｿ繧ｹ譚｡莉ｶ縺檎焚縺ｪ繧九↑縺ｩ縲∝茜逕ｨ邂・園縺ｫ繧医▲縺ｦ蜿ｯ逕ｨ驥上′螟牙虚縺吶ｋ縲・- **蜀咲樟/譚｡莉ｶ**: 蜷御ｸ繝ｭ繝・ヨ繧・`LotReservationService.get_available_quantity` 縺ｨ `v_lot_available_qty` 縺ｮ荳｡譁ｹ縺ｧ蜿ら・縺吶ｋ縺ｨ縲∽ｺ育ｴ・せ繝・・繧ｿ繧ｹ繧・Ο繝・け閠・・譛臥┌縺ｫ繧医ｊ逡ｰ縺ｪ繧狗ｵ先棡繧定ｿ斐☆縲ゅ色:backend/app/application/services/inventory/lot_reservation_service.py窶L326-L368縲代色:backend/app/application/services/inventory/stock_calculation.py窶L35-L55縲代色:backend/sql/views/create_views.sql窶L113-L170縲・- **蜴溷屏**: 蜿ｯ逕ｨ驥剰ｨ育ｮ励′蜷・園縺ｫ繧ｳ繝斐・縺輔ｌ縲√ラ繝｡繧､繝ｳ荳榊､画擅莉ｶ繧剃ｸ蜈・噪縺ｫ繝・せ繝医〒縺阪※縺・↑縺・・- **蠖ｱ髻ｿ遽・峇**: 蝨ｨ蠎ｫ陦ｨ遉ｺ繝ｻ莠育ｴ・ｽ懈・繝ｻ蛟呵｣懊Ο繝・ヨ謠千､ｺ縺ｮ謨ｴ蜷域ｧ縲ら腸蠅・ｄ蜻ｼ縺ｳ蜃ｺ縺礼ｵ瑚ｷｯ縺ｫ繧医▲縺ｦ蜿ｯ逕ｨ驥上′螟峨ｏ繧九◆繧√√ヰ繧ｰ蜀咲樟繧・屓蟶ｰ隧ｦ鬨薙′蝗ｰ髮｣縲・- **菫ｮ豁｣譯・*:
  - *譛蟆・: 繧ｵ繝ｼ繝薙せ/繝薙Η繝ｼ縺ｧ蜿ｯ逕ｨ驥上・螳夂ｾｩ繧呈純縺医ｋ・医Ο繝・け謗ｧ髯､ + active/confirmed貂帷ｮ暦ｼ峨ょ・騾夐未謨ｰ繧定ｵｷ轤ｹ縺ｫ繝ｦ繝九ャ繝医ユ繧ｹ繝医ｒ霑ｽ蜉縲・  - *逅・Φ*: 蜿ｯ逕ｨ驥上ｒDB蛛ｴ縺ｯ繝槭ユ繝ｪ繧｢繝ｩ繧､繧ｺ繝峨ン繝･繝ｼ/髢｢謨ｰ縺ｧ荳蜈・喧縺励√し繝ｼ繝薙せ/繝輔Ο繝ｳ繝医・縺昴ｌ繧貞盾辣ｧ縲ゅラ繝｡繧､繝ｳ荳榊､画擅莉ｶ繧貞･醍ｴ・ユ繧ｹ繝医〒諡・ｿ昴・- **菫ｮ豁｣譎ゅ・豕ｨ諢・*: 繝ｭ繧ｸ繝・け邨ｱ荳縺ｫ繧医ｊ蛟､縺悟､峨ｏ繧九◆繧√∽ｾ晏ｭ倥☆繧九Ξ繝昴・繝医ｄ繝輔Ο繝ｳ繝郁｡ｨ遉ｺ縺ｮ譛溷ｾ・､繧呈峩譁ｰ縺吶ｋ縺薙→縲・
## 荳贋ｽ・莉ｶ縺ｮ縺ｾ縺ｨ繧・1. 莠育ｴ・庄逕ｨ驥剰ｨ育ｮ励′繝ｭ繝・け辟｡隕悶〒驕主､ｧ隧穂ｾ｡・・1・・2. 繝薙Η繝ｼ縺慶onfirmed莠育ｴ・ｒ髯､螟悶＠蜿ｯ逕ｨ驥上ｒ豌ｴ蠅励＠・・1・・3. 莠育ｴ・｢ｺ螳壹・蜀ｪ遲峨メ繧ｧ繝・け荳榊・縺ｧ莠碁㍾譖ｴ譁ｰ繝ｪ繧ｹ繧ｯ・・2・・4. 蜃ｺ蠎ｫAPI縺ｮ繧ｨ繝ｩ繝ｼ繧ｳ繝ｼ繝峨′譖匁乂縺ｧ蠕ｩ譌ｧ荳崎・・・2・・5. 蜿ｯ逕ｨ驥上Ο繧ｸ繝・け縺悟､夐㍾螳夂ｾｩ縺ｧ謨ｴ蜷域ｧ讀懆ｨｼ縺後〒縺阪↑縺・ｼ・2・・
## 謗ｨ螂ｨ螳溯｡碁・1. **(P1)** 繝薙Η繝ｼ縺ｨ繧ｵ繝ｼ繝薙せ縺ｮ蜿ｯ逕ｨ驥上Ο繧ｸ繝・け繧堤ｵｱ荳・医Ο繝・け繝ｻconfirmed閠・・・峨・2. **(P1)** 繝薙Η繝ｼ縺ｮ髮・ｨ域擅莉ｶ菫ｮ豁｣縺ｫ蜷医ｏ縺帙※繝輔Ο繝ｳ繝・繝ｬ繝昴・繝医・譛溷ｾ・､繧呈峩譁ｰ縲・3. **(P2)** 莠育ｴ・｢ｺ螳壹・蜀ｪ遲画ｧ繧ｬ繝ｼ繝我ｿｮ豁｣・・num豈碑ｼ・・譏ｯ豁｣・峨・4. **(P2)** 蜃ｺ蠎ｫAPI縺ｮ萓句､問・HTTP繧ｹ繝・・繧ｿ繧ｹ繝槭ャ繝斐Φ繧ｰ繧呈紛逅・・5. **(P2)** 蜿ｯ逕ｨ驥剰ｨ育ｮ励・蜈ｱ騾壼喧繝ｻ繝・せ繝域紛蛯呻ｼ医ラ繝｡繧､繝ｳ荳榊､画擅莉ｶ縺ｮ螂醍ｴ・喧・峨・
