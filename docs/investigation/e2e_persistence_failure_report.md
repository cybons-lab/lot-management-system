# E2Eテストにおける永続化失敗およびAPIリクエスト欠落の調査報告

## 概要
`e2e-02-save-persistence.spec.ts` において、データの新規作成および編集保存がリロード後に反映されない問題が発生していました。調査の結果、以下の2つの主要な原因が特定されました。

1. **並列実行時のDBリセット干渉 (解決済み)**
2. **E2E環境下における保存APIリクエストの欠落 (未解決)**

## 1. 並列実行時のDBリセット干渉
### 現象
並列実行（workers > 1）時、テスト実行中に断続的に全データが焼失する現象が発生していました。

### 原因
`e2e-04-permission.spec.ts` 内の「管理者権限テスト」において、`/api/admin/reset-database` (DB全消去) を実行するステップが存在しました。これが並列実行中の他のテストデータを消し去っていました。

### 対処
当該ステップをコメントアウトし、並列テストの相互干渉を物理的に排除しました。
修正ファイル: `frontend/e2e/specs/p0/e2e-04-permission.spec.ts`

## 2. E2E環境下における保存APIリクエストの欠落
### 現象
マニュアルテストでは正常に保存されますが、E2Eテスト（Playwright）実行時には「保存」ボタンを押しても、以下のAPIリクエストが発生していません。

- `POST /api/masters/warehouses` (新規作成)
- `PUT /api/masters/warehouses/{code}` (編集)

代わりに、ボタンクリック直後に以下のログ送信APIリクエストが発生しています。
- `POST /api/system/logs/client`

### 証拠ログ
ネットワーク監視ログにおいて、ボタンクリック操作（`Page.click` および `Page.keyboard.press("Enter")`）の直後にAPIリクエストが確認されません。

```text
新規作成ボタンを探しています...
ダイアログの表示を待っています...
Enterキーを入力して送信を試みます...
[Network] POST http://localhost:5174/api/system/logs/client
（ここに本来あるべき POST /api/masters/warehouses が存在しない）
```

### 試行した対策と結果
1. **待機処理の厳密化**: `page.waitForResponse` で URL を厳密に指定したが、リクエスト自体が飛ばないためタイムアウトする。
2. **クリック方法の変更**: `click({ force: true })` や `Enter` キー送信を試したが改善せず。
3. **バリデーションエラー確認**: 画面上にバリデーションエラーメッセージは表示されていない（セレクタで確認済み）。

### 推定原因
フロントエンドの `api-client` (Axios等) または `WarehouseForm` の `onSubmit` ハンドラにおいて、E2E環境特有の条件（タイミング、トークン状態、ブラウザAPIの挙動など）により、リクエスト送信前に処理が中断されている、あるいはエラーとして処理されログ送信（`/api/system/logs/client`）に流れている可能性が高いです。

## 今後の対応方針
1. **フロントエンド実装の深堀り**: `WarehouseForm.tsx` および `useWarehouses` フック、HTTPクライアントの実装を確認し、リクエスト送信をブロックする条件がないか調査する。
2. **ログ送信の中身確認**: `/api/system/logs/client` に送信されているペイロードを確認できれば、どのようなエラーが発生しているか特定できる可能性がある。

以上
