# ビジネスコンテキスト補足が必要な項目

このドキュメントは、コードに「意図・背景」コメントを追加する際に、
開発者の判断だけでは記述できない項目をまとめたものです。

**作成日**: 2025-12-27
**対象**: ロット管理システム v2.1（自動車部品商社向け）

---

## 🔴 最優先（ビジネスロジックの根幹）

### 1. 過剰予約（オーバーブッキング）の許容範囲

**ファイル**: `stock_calculation.py`, `lot_reservation_service.py`

**現状の理解**:
- ACTIVE（仮予約）状態は利用可能数量の計算から除外される
- これにより、物理在庫を超える予約が可能

**質問**:
1. **どの程度のオーバーブッキングまで許容するのか？**
   - 例: 在庫100個に対して、150個まで予約可能？
   - 上限は設けているか？設けるべきか？

2. **オーバーブッキング時の運用フロー**
   - 在庫不足が判明した時点で、誰がどう対処するのか？
   - 納期調整？緊急発注？一部キャンセル？

3. **リスク管理**
   - オーバーブッキングによる欠品リスクをどう監視しているか？
   - アラート閾値は？（例: 在庫充足率80%未満で警告）

**コメントに記載すべき内容**:
```python
# オーバーブッキング運用ルール:
# - 許容範囲: 在庫の○○%まで（例: 120%）
# - 監視方法: ダッシュボードで在庫充足率を毎日確認
# - 対処フロー: 充足率が○○%を下回ったら営業に通知 → 納期調整または緊急発注
```

---

### 2. FEFO vs FIFO の使い分け基準

**ファイル**: `allocation_policy.py`, 製品マスタ

**現状の理解**:
- FEFO: 有効期限優先（ゴム部品・オイル等）
- FIFO: 入荷日優先（金属部品・電装品等）

**質問**:
1. **製品カテゴリごとの具体的な適用ルール**
   - どの製品分類にFEFOを適用？
   - 例外的なケースは？（顧客指定ロット等）

2. **有効期限の設定基準**
   - ゴム部品の有効期限はどう決定？（製造から○ヶ月等）
   - オイル・グリスの期限管理はメーカー指定に従う？

3. **顧客要求への対応**
   - 「最新ロット優先出荷」などの特殊要求にどう対応？
   - 現在のFEFO/FIFOで対応できないケースは？

**コメントに記載すべき内容**:
```python
# 製品カテゴリ別の適用ルール:
# - FEFO適用: ゴム部品（有効期限: 製造から2年）、オイル類（メーカー指定期限）
# - FIFO適用: 金属部品、電装品、樹脂部品（有効期限なし）
# - 例外処理: 顧客指定ロット出荷は手動引当で対応
```

---

### 3. SAP連携のタイミングと責任範囲

**ファイル**: `sap_service.py`, `sap_router.py`

**現状の理解**:
- ACTIVE → CONFIRMED への遷移はSAP登録時
- 現在はモック実装

**質問**:
1. **SAP登録のトリガー**
   - バッチ処理？手動操作？自動連携？
   - 実行頻度は？（例: 1日3回、毎時等）

2. **SAP登録失敗時の対応**
   - リトライロジックは？
   - 失敗した予約はどう処理？（ACTIVE のまま？RELEASED に戻す？）

3. **SAP側との責任分界点**
   - どこまでがこのシステムの責任？
   - SAP側で在庫を変更した場合の同期方法は？

**コメントに記載すべき内容**:
```python
# SAP連携フロー:
# 1. トリガー: 毎日○時、○時、○時の3回バッチ実行
# 2. 失敗時: 最大3回リトライ → それでも失敗したら営業に通知
# 3. 同期方法: SAP → 当システムは○時に全件同期、逆方向は都度連携
```

---

## 🟠 高優先（運用ルール）

### 4. 在庫ロック機能の用途

**ファイル**: `lot_models.py` (locked_quantity), `LockMode`

**現状の理解**:
- ロット単位でlocked_quantityを設定可能
- ロックされた数量は引当不可

**質問**:
1. **どのような場合にロックするのか？**
   - 品質検査中？出荷準備中？顧客専用在庫？

2. **ロック解除のタイミング**
   - 誰が手動で解除？自動解除の条件は？

3. **ロック中の在庫の物理的な扱い**
   - 倉庫内で物理的に隔離？ラベル貼付？

**コメントに記載すべき内容**:
```python
# ロック用途:
# - 品質検査中: 検査完了まで引当不可（検査部門が手動ロック・解除）
# - 顧客専用在庫: 特定顧客専用ロット（営業が設定）
# - 出荷準備中: ピッキング開始〜出荷完了まで自動ロック
```

---

### 5. 調整理由の分類

**ファイル**: `adjustment_service.py`, `AdjustmentType`

**現状の理解**:
- 在庫調整時にreasonを記録
- adjustment_typeで分類

**質問**:
1. **調整が発生する主なケース**
   - 棚卸差異？破損？期限切れ廃棄？

2. **承認フローの有無**
   - 在庫調整に承認が必要？権限レベルは？

3. **監査要件**
   - どのような監査証跡が必要？
   - 調整履歴の保管期間は？

---

## 🟡 中優先（拡張性・将来対応）

### 6. マルチ倉庫対応の方針

**ファイル**: `config.py` (DEFAULT_WAREHOUSE_ID)

**質問**:
1. **将来的な倉庫追加の予定**
   - 現在は1倉庫運用？複数倉庫への拡張予定は？

2. **倉庫間移動の扱い**
   - 倉庫間在庫移動は発生するか？
   - その場合のロット番号の引継ぎは？

---

### 7. 予測需要（Forecast）の活用方法

**ファイル**: `lot_reservations_model.py` (ReservationSourceType.FORECAST)

**質問**:
1. **予測需要の登録方法**
   - 誰が？いつ？どのように予測値を入力？

2. **予測と実受注の関係**
   - 予測で予約した在庫を実受注で使う流れは？

3. **予測精度の管理**
   - 予測と実績の乖離を監視？フィードバックループは？

---

## 📝 その他（詳細仕様の確認）

### 8. エラーハンドリングの方針

**全般的な質問**:
1. **マイナス在庫を許容しない理由**
   - 業界標準？SAP制約？内部方針？

2. **エラー通知の方法**
   - 画面表示のみ？メール通知？Slack通知？

---

## 🔄 次のアクション

1. **このドキュメントをレビュー**
   - 各質問に回答を記入
   - 不明点があれば追加質問を記載

2. **回答をコードコメントに反映**
   - 回答内容を元に、各ファイルに「意図・背景」コメントを追加

3. **運用マニュアルへの統合**
   - 必要に応じて、運用マニュアルやREADMEにも記載

---

## 📌 回答記入欄

以下、各項目に回答を記入してください：

### 1. 過剰予約の許容範囲
```
【回答】


```

### 2. FEFO vs FIFO の使い分け
```
【回答】


```

### 3. SAP連携のタイミング
```
【回答】


```

（以下、各項目について同様に回答欄を設ける）
