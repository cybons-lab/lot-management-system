# UI改善課題

## 予測詳細ページ

### 1. 倉庫表示が「不明」になる問題 ✅ 解決済

**原因**: 
- `/api/lots` エンドポイントが `v_lots_with_master` ビューを使用
- このビューに `warehouse_code` / `warehouse_name` フィールドが欠落
- フロントエンドのフォールバック値「不明」が表示された

**修正内容**:
- `v_lots_with_master` ビューに `warehouses` テーブルをJOIN
- `warehouse_code` と `warehouse_name` フィールドを追加

**修正ファイル**: `backend/sql/views/create_views.sql`

---

### 2. SAP受注登録UIの改善 🔄 仕様見直し中

#### 暫定実装（保留中）

現在の実装（コミット: `44dc2a9`, `0c820e5`）:
- 各受注行にSAPステータスバッジ統合
- インライン「SAP登録」ボタン
- 受注単位での登録

**保留理由**: SAP登録は明細単位で、かつまとめて登録が基本フローのため

---

#### 新しい要件（v2）

**業務仕様:**
- SAP登録は**明細行単位**（1明細 = 1 SAP受注）
- **引当確定済み**の明細のみ登録可能
- 基本はまとめて登録（フォーキャストグループを横断）
- 単体登録も可能

**UI設計:**

```
画面上部（メニュー下）固定位置
┌────────────────┐
│ [SAP受注登録]  │  ← フローティングボタン
└────────────────┘

クリック時 → ダイアログ表示

┌──────────────────────────────────────────────┐
│  SAP受注登録 - 引当確定済み明細                │
├──────────────────────────────────────────────┤
│                                               │
│ □ 得意先A | 製品X-001 | 明細#123             │
│   数量: 1,580 KG | 引当: 1,580 KG (確定)      │
│   ロット: LOT-00001                           │
│   納期: 2025/12/13                            │
│                                               │
│ □ 得意先B | 製品Y-002 | 明細#124             │
│   数量: 500 EA | 引当: 500 EA (確定)          │
│   ロット: LOT-00002                           │
│   納期: 2025/12/15                            │
│                                               │
│ □ 得意先A | 製品Z-003 | 明細#125             │
│   数量: 320 CAN | 引当: 320 CAN (確定)        │
│   ロット: LOT-00003                           │
│   納期: 2025/12/18                            │
│                                               │
├──────────────────────────────────────────────┤
│  選択: 2件                 [キャンセル] [登録] │
└──────────────────────────────────────────────┘
```

**表示条件:**
- 引当が完全に確定している明細のみ（`allocated_quantity >= order_quantity`）
- SAP未登録の明細のみ
- ロット番号が確定している明細

**操作フロー:**
1. 画面上部の「SAP受注登録」ボタンをクリック
2. ダイアログに引当確定済み明細が一覧表示
3. 登録したい明細にチェック
4. 「登録」ボタンクリック
5. バックエンドAPIに`order_line_ids`を送信
6. 成功したら各明細のSAP受注番号を表示

**登録後の表示:**
- 明細行に「SAP登録済み」バッジ表示
- SAP受注番号を表示（例: `SAP: SAP-2025-00123`）

---

### 実装方針

#### Phase 1: フローティングボタンとダイアログUI作成
- `SAPRegistrationButton.tsx` - 固定位置フローティングボタン
- `SAPRegistrationDialog.tsx` - 明細一覧ダイアログ
- 引当確定済み明細の取得API（または既存データから抽出）

#### Phase 2: 明細単位の登録機能
- 明細IDリストを受け取るAPI実装（モック）
- 明細ごとのSAPステータス管理
- 明細行へのバッジ表示

#### Phase 3: 既存実装の流用
- 単体明細登録は`OrderAllocationInline`に統合
- `useSAPRegistration`を明細ID対応に変更

---

## 対応優先度

1. ✅ 倉庫表示バグ修正
2. 🔄 SAP登録UI v2実装（仕様確定後）

## 関連ファイル

- `frontend/src/features/forecasts/pages/ForecastDetailPage.tsx`
- `frontend/src/features/forecasts/components/ForecastDetailCard/`
- `backend/app/api/routes/integrations/sap_router.py`
