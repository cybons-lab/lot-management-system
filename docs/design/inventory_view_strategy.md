# Inventory View Strategy (計測と改善方針)

## 目的
在庫サマリ/ロット詳細のビュー更新方式を「計測 → 改善優先 → それでも不足ならマテビュー」の順で決める。
キャッシュ層は最終手段とし、整合性負荷の増大を避ける。

## スコープ
- 対象: 在庫サマリ・ロット詳細に関わる主要ビュー/クエリ
- 非対象: UI側の再計算（SSOTはバックエンド）

## 現状計測の進め方
1. **データ量の把握**
   - 対象テーブル/ビューの件数を計測する。
   - 例: `lot_receipts`, `withdrawal_lines`, `lot_reservations`, 各種ビュー。

2. **EXPLAIN/ANALYZE の実施**
   - 代表的なクエリ（一覧・詳細・集計）を選定し、`EXPLAIN (ANALYZE, BUFFERS)` を取得する。
   - 重点: フルスキャン、JOIN順序、インデックス利用状況、ソート/集計コスト。

3. **ボトルネックの特定**
   - I/O偏重かCPU偏重かを判断。
   - 遅延要因が「必要列の取りすぎ」「JOIN過多」「集計の再計算」にあるかを整理する。

## 改善方針（優先順）
1. **クエリ/インデックス改善を優先**
   - 不要列の削減、JOIN順序の見直し、WHERE条件の絞り込み。
   - 既存インデックスの活用を優先し、必要なら追加。

2. **それでも不足ならマテビュー**
   - 更新戦略（即時/定期/トリガー）を先に決める。
   - 再計算コストと遅延許容を明文化。

3. **キャッシュ層は最後**
   - 更新整合性の負荷が大きいため、最終手段とする。

## 代表クエリ（例）
- 在庫サマリ一覧（製品×倉庫）
- ロット詳細（製品×倉庫の内訳）
- 予約/引当/ロックの集計

> 実測時はこの一覧にクエリを追加して更新する。

## 成果物
- EXPLAIN結果のサマリ
- 改善対象クエリ/インデックスの候補
- マテビュー導入の可否判断（必要なら更新戦略を明記）

## 更新履歴
- 2026-01-16: 初版
