"""引当ポリシー定義.

ロット選択のためのポリシー（FEFO/FIFO）とデータベースロックモードを定義します。
これらはAllocationCandidateServiceによって引当候補のSSoT（信頼できる唯一の情報源）として使用されます。
"""

from enum import StrEnum


class AllocationPolicy(StrEnum):
    """引当時のロット並び順を決定するポリシー.

    在庫引当時にどのロットを優先的に使用するかを制御します。

    【設計意図】
    2種類のポリシーを用意する理由:
    1. 自動車部品は製品特性により最適な出庫順が異なる
       - ゴム部品・オイル等: 経年劣化があるため有効期限管理が必須 → FEFO
       - 金属部品・電装品等: 有効期限より入荷順序が重要 → FIFO

    2. 業界標準への準拠
       - 自動車業界では品質トレーサビリティのため、ロット単位の厳密な管理が求められる
       - FIFO: ロット番号順の出庫により、古いロットから確実に消化
       - FEFO: 有効期限のある部品で期限切れによる廃棄を防止

    3. 顧客要求への対応
       - 顧客によっては「最新ロット優先」などの特殊要求もあるが、
         現時点ではFEFO/FIFOで大半のケースに対応可能
    """

    FEFO = "fefo"  # 有効期限優先 - ゴム部品・オイル・グリス等の経年劣化品
    FIFO = "fifo"  # 入荷日優先 - 金属部品・電装品等の製造番号管理品


class LockMode(StrEnum):
    """引当候補クエリ時のデータベースロックモード.

    並行処理時の在庫の整合性を保つためのロック制御戦略を定義します。

    【設計意図】
    3種類のロックモードを使い分ける理由:

    1. NONE（ロックなし）
       用途: 引当プレビュー、レポート生成、在庫照会
       理由: 読み取り専用操作でロックを取得すると、他ユーザーの更新処理をブロックしてしまう
       → システム全体のスループット低下を防ぐため、参照時はロック不要

    2. FOR_UPDATE（行ロック・待機あり）
       用途: 単一ユーザーによる確実な引当処理
       理由: 最適なロット（最も期限が近い、最も古い等）を確実に取得したい場合
       トレードオフ: 他の処理が完了するまで待機が発生 → レスポンス遅延の可能性
       → 夜間バッチ処理など、待機時間を許容できるケースで使用

    3. FOR_UPDATE_SKIP_LOCKED（行ロック・スキップあり）
       用途: 複数ユーザーの同時引当処理（デフォルト）
       理由: 待機によるタイムアウトやデッドロックを回避
       → 営業時間中の対話的な引当操作で、レスポンス速度を優先
       トレードオフ: 競合時に次善のロットを割り当てる可能性
       → ただし、在庫が十分にあれば実用上問題なし

    【選択基準】
    - プレビュー・照会: NONE
    - バッチ処理: FOR_UPDATE
    - 対話的操作: FOR_UPDATE_SKIP_LOCKED（推奨）
    """

    NONE = "none"
    FOR_UPDATE = "for_update"
    FOR_UPDATE_SKIP_LOCKED = "for_update_skip_locked"
