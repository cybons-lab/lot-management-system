# テストデータ生成仕様書（最新版・DB直接投入版）

## 1. 目的

Lot Management System の各種ロジック（FEFO、仮予約 vs 本番突合、横取り受注、在庫異常、フォーキャスト欠落時挙動、UI アラート等）を現実的に検証できる高品質テストデータを、自動で **DB に直接投入** する。

管理画面の「テストデータ生成（開発用）」ボタンから実行し、以下を行う。

1. 関連テーブルのデータを削除（開発環境のみ）  
2. テストデータを生成して DB に insert  
3. フロントエンドから検証できる状態にする

---

## 2. マスタデータ生成（ランダム）

実在名は使用せず、faker 等でランダム生成する。

- 顧客（customers）: 5〜10 件  
- 納入先（delivery_places）: 各顧客 2〜3 件  
- 倉庫（warehouses）: 4〜8 件  
- 製品（products）: 任意件数（数十件程度を想定）  

---

## 3. 在庫・ロット（lots）

各製品について、以下の条件でロットを生成する。

- 1 製品あたり 5〜10 ロット  
- quantity: 5〜50  
- expiry（有効期限）: 今日〜120 日後の範囲でランダム  
- 在庫パターン: 製品単位でいずれかを割り当てる  
  - **overstock**: フォーキャスト・受注より多い  
  - **exact**: ほぼピッタリになるよう調整  
  - **lowstock**: 明確に不足する量  

---

## 4. フォーキャスト（forecasts）

### 4.1 フォーキャストあり製品

以下の 3 レベルのデータを生成する。数量は「近似値」で整合性を保つ。

- **日別（日別フォーキャスト）**  
  - 対象期間: 基本「翌月」  
  - 全日ではなく、3 日・5 日・10 日周期などで「ランダム間引き」して生成  
  - 数量: 20〜120 の範囲でランダム  

- **旬（旬フォーキャスト）**  
  - 対象期間: 日別と同じく「翌月」  
  - 上旬 / 中旬 / 下旬 の 3 区分  
  - 各旬の数量は、該当する日別合計に対して **±10〜20% 以内** に収まるよう計算  

- **月（月次フォーキャスト）**  
  - 対象期間: 「翌々月」の月次フォーキャスト  
  - 数量は、翌月の日別合計のトレンドを踏まえ **±10〜15% 以内** に収まるようにする  

> 例：翌月の日別合計が 900 の場合、翌々月の月次フォーキャストは おおよそ 765〜1035 程度の範囲で生成する。

### 4.2 フォーキャストなし製品

- 日別・旬・月のいずれのフォーキャストも生成しない  
- ただし **本番受注は必ず発生** させる（発注予測系のテスト用）  

---

## 5. 仮予約（reservations / 仮引当）

仮予約は **日別フォーキャストを 100% コピー** して作成する。

- 対象: フォーキャストあり製品のみ  
- 顧客 × 納入先 × 製品 × 日付 の組み合わせごとに、  
  日別フォーキャスト数量 = 仮予約数量 とする  
- 旬・月の値は予約には使用しない（あくまで参考値・集計用）  
- 日別フォーキャストが更新された場合は、
  「該当する顧客 × 製品（＋納入先）の仮予約を一旦削除して再生成」する想定

フォーキャストなし製品については仮予約は 0（生成しない）。

---

## 6. 本番受注データ（orders）

テスト目的で、各製品について 50〜80 件程度の受注を生成する。

### 6.1 共通ルール

- **1 社（特定の顧客）は「完全正常なシナリオ」** とする  
  - この顧客については異常パターンを一切付与しない  
- 残りの顧客については、下記の異常パターンを **ランダムで付与** する  
  - ただし、1 顧客に全異常をまとめて発生させるような極端な状況は避ける  

### 6.2 異常パターン一覧

- 正常: 仮予約／フォーキャストにほぼ一致する日付・数量で受注  
- 早着: 仮予約日より 1〜3 日前倒し  
- 遅延: 仮予約日より 1〜3 日後ろ倒し  
- 数量違い: 仮予約数量に対して ±20〜50% の差  
- 納入先違い: 予約とは異なる納入先に対する受注  
- 横取り受注: 他顧客向けに仮予約されているロットを消費しようとする受注  
- 在庫ゼロ受注: 在庫が 0 もしくは明らかに不足している状態で発生する受注  
- フォーキャストなし受注: フォーキャストが存在しない製品に対する受注  

これらを組み合わせつつ、現実的な比率で分布させる（例：正常 > 数量違い > 日付ずれ > 横取り > 在庫ゼロ）。

---

## 7. データ投入方法（DB 直接）

- Python スクリプトから SQLAlchemy モデルを使用して **DB に直接 insert** する  
- 生成対象テーブル（例）:
  - customers, delivery_places, warehouses, products  
  - lots（在庫・ロット）  
  - forecasts（必要に応じて日別・旬・月でテーブル分割 or 種別カラム持ち）  
  - reservations（仮予約）  
  - orders（受注）  

### 7.1 事前クリア

テストデータ生成時には、関連テーブルを論理的にクリアする。  
（TRUNCATE もしくは DELETE。開発環境専用エンドポイントであることを明示する）

---

## 8. スクリプト仕様

配置場所:

```bash
backend/app/services/test_data_generator.py
```

要件:

- pandas・faker・python-dateutil などを用いてデータ生成  
- SQLAlchemy のセッションを受け取り、バルクインサートを行うヘルパー関数を実装  
- 乱数 seed を固定し、同じ条件では毎回同じデータが生成されるようにする  
- メイン関数は「既存データ削除 → 各テーブルへの insert」を一連で実行できる構造にする  

---

## 9. 管理画面との連携（概要）

- 管理画面「テストデータ生成（開発用）」ボタン押下  
- FastAPI の管理用エンドポイントを叩く  
- エンドポイント内で `generate_test_data.py` のメイン処理を呼び出す  
- 成功時は `{ "success": true }` を返却し、フロント側でトースト通知を行う  

---

## 10. 実装状況（2025-11-21 更新）

以下の通り実装完了。

- **スクリプト**: `backend/app/services/test_data_generator.py`
  - `generate_all_test_data(db)` 関数で一括生成
  - `faker` を使用してランダムデータを生成
  - `allocation_suggestions` テーブルを仮予約（reservations）として使用

- **API**: `POST /api/v1/admin/test-data/generate`
  - `backend/app/api/routes/admin/test_data.py` に実装
  - 実行時に関連テーブルを TRUNCATE

- **Frontend**: 管理画面（AdminPage）
  - 「テストデータ生成（開発用）」ボタンを配置
  - 確認ダイアログを経て API を実行
